{% extends 'app_common/common_files/base_template.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load app_web_my_filters %}
{% load markdown_extras %}
{% load mptt_tags %}

 <!-- Bootstrap CSS -->
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
 <!-- Font Awesome CDN -->
 <link
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
 rel="stylesheet"
 integrity="sha512-p6M6Fh8hjbEEC5Vnm68s/bB7o93uaf1/Jq3axRf9UKIY7sVdzIz0yGZrAmkXQOVX3Kbi8e4uJ1UrI6kZe0QkDA=="
 crossorigin="anonymous"
 referrerpolicy="no-referrer"
/>

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

{% block content %}
    {% include 'app_common/common_files/navbar.html' %}

<!-- Custom Styles -->
<style>
    /* Top Menu Container */
    .top-menu-container {
        width: 100%;
        background-color: #f8f9fa;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .top-menu {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .left-section {
        flex: 0 0 30%;
        max-width: 30%;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .right-section {
        flex: 0 0 70%;
        max-width: 90%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 5px;
    }

    .activity_input_style, .step_input_style {
        min-width: 200px;
        max-width: 250px;
        flex: 1;
    }

    /* Post-it Note Styles */
    .post-it {
        position: relative;
        min-width: 100px;
        max-width: 200px;
        background-color: #fff9c4;
        border: 1px solid #f0e68c;
        padding: 10px;
        margin: 10px;
        font-size: 0.9rem;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        box-sizing: border-box;
        word-wrap: break-word;
    }

    .backlog-item {
        display: block;
        min-width: 50px;
        max-width: 120px;
        background: #eef;
        border: 1px solid #bbb;
        padding: 5px;
        margin-right: 10px;
        font-size: 0.7rem;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        box-sizing: border-box;
        word-wrap: break-word;
    }

    .content-header {
        margin-top: 10px;
        font-weight: bold;
        width: 20px;
        margin-right: 10px;
        writing-mode: vertical-lr;
        transform: rotate(180deg);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .activity-card {
        display: inline-block;
        min-width: 50px;
        max-width: 180px;
        min-height: 80px;
        background: lightcoral;
        color: black;
        border: 1px solid #bbb;
        padding: 5px;
        margin-right: 10px;
        font-size: 0.8rem;
        font-weight: bold;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: top;
        box-sizing: border-box;
        word-wrap: break-word;
    }

    .step-card {
        display: inline-block;
        min-width: 50px;
        max-width: 180px;
        min-height: 40px;
        background: lightskyblue;
        color: black;
        border: 1px solid #bbb;
        padding: 5px;
        margin-right: 10px;
        font-size: 0.8rem;
        font-weight: bold;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: top;
        box-sizing: border-box;
        word-wrap: break-word;
    }

    .story-map-container {
        max-height: 80vh;
        overflow-y: auto;
    }

    .card {
        position: relative;
        background-color: #fffa65;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.15);
        cursor: grab;
        transition: box-shadow 0.2s;
        width: 250px;
        word-wrap: break-word;
    }

    /* Different styling for mapped items */
    .mapped-item {
        background-color: #e8f5e8 !important;
        border: 2px solid #4caf50 !important;
        opacity: 0.7;
        cursor: not-allowed;
    }

    .mapped-item small {
        font-size: 0.6rem;
        line-height: 1.1;
    }

    .activity-color {
        background-color: lightyellow;
        border: 1px solid lightcoral;
    }

    .step-color {
        background-color: yellow;
        border: 1px solid #81c784;
    }

    @media (max-width: 768px) {
        .left-section, .right-section {
            flex: 0 0 100%;
            max-width: 100%;
            justify-content: center;
            text-align: center;
        }
        .right-section {
            margin-top: 10px;
            flex-direction: column;
            gap: 10px;
        }
    }
</style>

<div class="page-container">
    <!-- Custom Top Menu -->
    <div class="top-menu-container">
        <div class="top-menu">
            <!-- Left-Aligned Section -->
            <div class="left-section">
               <b>Story Mapping from Backlog: <a href="{% url 'list_projects' org_id %}">{{project.name}}</a></b>
               &nbsp;&nbsp;
               <a href="{% url 'view_project_tree_backlog' project.id %}" class="btn btn-sm btn-primary" style="font-size: 12px;"><b>Back to Backlog</b></a>
            </div>

            <!-- Right-Aligned Section -->
            <div class="right-section">
                <b>Activity:</b>
                <form action="" method="post" class="d-flex align-items-center w-100">
                    {% csrf_token %}
                    <input type="text" name="activity" id="activity" class="form-control activity_input_style" placeholder="Activity" width="100%">
                    <input type="hidden" name="persona_id" value="{{ persona.id }}">
                    <input type="hidden" name="project_id" value="{{ pro_id }}">
                    &nbsp;&nbsp;
                    <button type="submit" name="submit_activity" class="btn btn-primary btn-sm">Add</button>
                </form>
                
                <b>Step:</b> 
                <form action="" method="post" class="d-flex align-items-center w-100">
                    {% csrf_token %}
                    <input type="text" name="step_input" id="step_input" class="form-control step_input_style" placeholder="Step">
                    <input type="hidden" name="default_activity_id" value="{{ default_activity_id }}">
                    <input type="hidden" name="persona_id" value="{{ persona.id }}">
                    <input type="hidden" name="project_id" value="{{ pro_id }}">
                    &nbsp;&nbsp;
                    <button type="submit" name="submit_step" class="btn btn-success btn-sm">Add</button>
                    &nbsp;&nbsp;
                    <a href="{% url 'storymap_group_steps' pro_id persona_id %}" class="btn btn-sm btn-primary">Group</a>
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="{% url 'edit_persona' org_id persona.id %}" class="btn btn-primary btn-sm">View</a>
                    &nbsp;&nbsp;
                    <a href="{% url 'list_project_personae' org_id project.id %}" class="btn btn-secondary btn-sm">List</a>
                </form> 
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Display -->
        <div class="row">
            <!-- Left Sidebar (Existing Backlog Items) -->
            <div class="col col-md-2" id="">
                <!-- Sidebar Header -->
                <div class="container-fluid-width">
                    <div class="row">
                        <div class="col col-md-12">
                           <div class="message_display"></div>
                        </div>
                    </div>
                </div>
                <!-- Sidebar Content -->
                <div class="container-fluid-width mt-2">
                    <table class="table table-bordered">
                        <!-- Add New Backlog Item Form -->
                        <tr id="add-backlog-row">
                            <td colspan="">
                                <strong>Add New Backlog Item</strong>
                                <form method="post" action="" onsubmit="return addBacklogItem(event);">
                                    {% csrf_token %}
                                    <input type="hidden" name="project_id" value="{{ pro_id }}">
                                    <input type="hidden" name="persona_id" value="{{ persona.id }}">
                                    <input type="text" name="detail" id="detail" class="form-control form-control-sm mt-2" placeholder="Enter backlog item name">
                                    <button type="submit" name="submit_detail" class="btn btn-primary btn-sm mt-2 w-100">Add Item</button>
                                </form>
                            </td>
                        </tr>
                        
                        <!-- Existing Backlog Items Row -->                         
                        <tr id="backlog-items-row">
                            <td colspan="" class="backlog-source-zone" 
                                ondragover="allowDrop(event)"
                                ondrop="dropToBacklog(event)">
                                <strong>Existing Backlog Items</strong>
                                <br><small class="text-muted">Drag items to map them to activities and steps</small>
                                <br><br>
                                
                                <div id="backlog-items-container">
                                    {% comment %} Show only unmapped backlog items that can be dragged {% endcomment %}
                                    {% if unmapped_backlog %}
                                        {% for backlog_item in unmapped_backlog %}
                                            {% if backlog_item.active %}
                                                <div class="backlog-item post-it draggable-backlog" draggable="true" id="backlog-{{ backlog_item.id }}"
                                                     data-backlog-id="{{ backlog_item.id }}"
                                                     ondblclick="editText(this);" 
                                                     onblur="saveText(this, {{ backlog_item.id }})">
                                                    {{ backlog_item.name }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% comment %} Show message if no unmapped backlog items exist {% endcomment %}
                                    {% if not unmapped_backlog %}
                                        <div class="text-muted">
                                            <small>No unmapped backlog items. Create new items using the form above.</small>
                                            {% if mapped_items_count > 0 %}
                                                <br><small>{{ mapped_items_count }} item(s) are already mapped to the story map.</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>      
                   </table>
                </div>
            </div>

            <!-- Right Sidebar (Story Map) -->
            <div class="col col-md-10 text-start story-map-container">
                <i class="bi bi-person-heart"></i> &nbsp;
                <b>Persona:</b>
                <b id="persona_name" class="persona-name" ondblclick="makeEditable(this)"
                onblur="save_element_text(this, '{{ persona.id }}', 'app_organization', 'Persona', 'name')">
                {% if persona.name != '' %}{{ persona.name }}{% else %}Enter Persona name here...{% endif %}</b>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <!-- Activities Row --> 
                        <tr>
                            <td width="3%">
                                <div class="content-header">Activities</div>
                            </td>
                            {% for activity in activities %}
                                {% with activity.activity_steps.all|filter_active|length as step_count %}
                                    {% if step_count > 0 %}
                                        <td colspan="{{ step_count }}" class="activity-header" style="border-left: 3px solid lightgrey;">
                                            <div class="activity-card post-it activity-color" id="activity-{{ activity.id }}"
                                                 ondblclick="makeEditable(this);"
                                                 onblur="save_element_text(this, '{{ activity.id }}', 'app_organization', 'Activity', 'name')">
                                                {{ activity.name }} ({{ step_count }})
                                            </div>
                                        </td>
                                    {% else %}
                                        <input type="hidden" {% if activity.name == 'Default Activity' %}data-default-activity-id="{{ activity.id }}"{% endif %}>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </tr>
                    
                        <!-- Steps Row -->
                        <tr id="steps-row">
                            <td width="3%">
                                <div class="content-header">Steps</div>
                            </td>
                            {% for activity in activities %}
                                {% with activity.activity_steps.all|filter_active as steps %}
                                    {% for step in steps %}
                                        <td class="step-cell" style="border-left: {% if forloop.first %}3px solid lightgrey;{% else %}none;{% endif %}">
                                            <div class="step-card post-it step-color" draggable="true" id="step-{{ step.id }}"
                                                 ondblclick="makeEditable(this);"
                                                 onblur="save_element_text(this, '{{ step.id }}', 'app_organization', 'Step', 'name')">
                                                {{ step.name }}
                                            </div>
                                        </td>
                                    {% endfor %}
                                {% endwith %}
                            {% endfor %}
                        </tr>
                    
                        <!-- Releases Rows -->
                        {% if not project.project_release %}
                            <tr><td colspan="100%"><b>Please map this project with a release</b></td></tr>
                        {% endif %}
                        
                        {% for release in releases %}
                            {% if release.id == project.project_release.id %}
                                {% for iteration in release.org_release_org_iterations.all|filter_active %}
                                    <tr id="release-row-{{ release.id }}">
                                        <td width="3%">
                                            <div class="content-header">{{ release.name }} / {{iteration.name}}</div>
                                        </td>
                                        {% for activity in activities %}
                                            {% with activity.activity_steps.all|filter_active as steps %}
                                                {% for step in steps %}
                                                    <td class="release-drop-zone"
                                                        data-release-id="{{ release.id }}"
                                                        data-iteration-id="{{ iteration.id }}"
                                                        data-activity-id="{{ activity.id }}"
                                                        data-step-id="{{ step.id }}"
                                                        ondragover="allowDrop(event)"
                                                        ondrop="drop(event)"
                                                        style="border-left: {% if forloop.first %}3px solid lightgrey;{% else %}none;{% endif %};">
                                                        
                                                        <!-- Display existing mapped items -->
                                                        {% for story_map in story_maps %}
                                                            {% if story_map.release_id == release.id and story_map.activity_id == activity.id and story_map.step_id == step.id and story_map.iteration_id == iteration.id and story_map.active %}
                                                                {% for backlog_item in existing_backlog %}
                                                                    {% if story_map.story_id == backlog_item.id %}
                                                                        <div class="step-item post-it card draggable-backlog" draggable="true" id="mapped-backlog-{{ story_map.story_id }}"
                                                                             ondblclick="makeEditable(this);" 
                                                                             onblur="save_element_text(this, '{{ story_map.story_id }}', 'app_organization', 'Backlog', 'name')">
                                                                            {{ backlog_item.name }}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                {% endfor %}
                                            {% endwith %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'a') {
            event.preventDefault();
            document.getElementById('activity').focus();
        } else if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            document.getElementById('step_input').focus();
        } else if (event.ctrlKey && event.key === 'b') {
            event.preventDefault();
            document.getElementById('detail').focus();
        }
    });

    // Function to handle adding new backlog items via AJAX
    function addBacklogItem(event) {
        event.preventDefault();
        
        const form = event.target;
        const detailInput = form.querySelector('input[name="detail"]');
        
        if (!detailInput.value.trim()) {
            alert('Please enter a backlog item name');
            return false;
        }

        // Use jQuery AJAX instead of fetch for better compatibility
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
                'detail': detailInput.value,
                'submit_detail': 'submit_detail',
                'project_id': '{{ pro_id }}',
                'persona_id': '{{ persona.id }}'
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            dataType: 'json',
            success: function(data) {
                if (data.status === 'success') {
                    // Create new backlog item element
                    const newItem = $(`
                        <div class="backlog-item post-it draggable-backlog" draggable="true" id="backlog-${data.backlog_id}"
                             data-backlog-id="${data.backlog_id}"
                             ondblclick="makeEditable(this);" 
                             onblur="save_element_text(this, '${data.backlog_id}', 'app_organization', 'Backlog', 'name')">
                            ${data.backlog_name}
                        </div>
                    `);
                    
                    // Add to container
                    $('#backlog-items-container').append(newItem);
                    
                    // Clear the form
                    detailInput.value = '';
                    
                    console.log('Backlog item added successfully');
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
                console.error('Response:', xhr.responseText);
                alert('Error adding backlog item. Check console for details.');
            }
        });
        
        return false;
    }

        
    // Enhanced drag and drop functionality
    $(document).ready(function() {
        // Make sure drag events work for dynamically added elements
        $(document).on('dragstart', '.draggable-backlog', function(e) {
            e.originalEvent.dataTransfer.setData("text/plain", this.id);
            console.log('Drag started for:', this.id);
        });
    });

    // Event Delegation for dragstart
    document.addEventListener('dragstart', function(event) {
        if (event.target.classList.contains('draggable-backlog')) {
            event.dataTransfer.setData("text/plain", event.target.id);
        }
    });

    function makeEditable(element) {
        element.contentEditable = true;
        element.focus();
    }

    function save_element_text(element, id, appName, modelName, fieldName) {
        element.contentEditable = false;
        $.ajax({
            url: '/common/common_ajax/ajax_save_element_text/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': "{{ csrf_token }}",
                'model_name': modelName,
                'app_name': appName,
                'field_name': fieldName,
                'text': element.textContent, 
                'id': id,
            },
            dataType: 'json',
            success: function(data) {
                console.log("Success:");
            },
            error: function(xhr, status, error) {
                console.error('SAVE ELEMENT Error:', status, error);
            }
        });
    }

    // Allow drop by preventing default behavior
    function allowDrop(event) {
        event.preventDefault();
    }
    
    function drop(event) {
        event.preventDefault();

        // Get the dragged element's ID
        const draggedId = event.dataTransfer.getData("text/plain");
        const draggedElement = document.getElementById(draggedId);

        if (!draggedElement) {
            console.error('Dragged element not found.');
            return;
        }

        // Extract the backlog ID
        const backlogId = draggedId.split('-')[1];

        // Get the drop zone's data attributes
        const dropZone = event.target.closest('.release-drop-zone');
        const releaseId = dropZone.getAttribute('data-release-id');
        const iterationId = dropZone.getAttribute('data-iteration-id');
        const activityId = dropZone.getAttribute('data-activity-id');
        const stepId = dropZone.getAttribute('data-step-id');

        // Prepare the AJAX payload
        const payload = {
            project_id: {{ pro_id }},
            story_id: backlogId,
            release_id: releaseId,
            iteration_id: iterationId,
            activity_id: activityId,
            step_id: stepId,
            persona_id: {{ persona.id }},
        };

        // Send the AJAX request to the backend
        fetch("{% url 'ajax_recieve_story_mapped_details' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(payload),
        })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Move the dragged element to the drop zone
                const clonedElement = draggedElement.cloneNode(true);
                clonedElement.classList.remove('backlog-item');
                clonedElement.classList.add('step-item', 'card');
                clonedElement.id = 'mapped-backlog-' + backlogId;
                dropZone.appendChild(clonedElement);
                
                // Remove the element from the source container
                draggedElement.remove();
                
                console.log('Backlog item successfully mapped to story map.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error mapping story:', error.message);
        });
    }

    // Function to handle dropping items back to backlog
    function dropToBacklog(event) {
        event.preventDefault();

        // Get the dragged element's ID
        const draggedId = event.dataTransfer.getData("text/plain");
        const draggedElement = document.getElementById(draggedId);

        if (!draggedElement) {
            console.error('Dragged element not found.');
            return;
        }

        // Extract the backlog ID (handle both 'backlog-X' and 'mapped-backlog-X' formats)
        let backlogId;
        if (draggedId.startsWith('mapped-backlog-')) {
            backlogId = draggedId.split('-')[2];
        } else {
            backlogId = draggedId.split('-')[1];
        }

        // Define the AJAX payload
        const payload = {
            project_id: {{ pro_id }},
            backlog_id: backlogId,
            persona_id: {{ persona.id }},
            release_id: null, // Remove release association
        };

        // Send the AJAX request to the backend
        fetch("{% url 'ajax_update_backlog_release' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(payload),
        })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Append the dragged element back to the backlog container
                const backlogContainer = document.getElementById('backlog-items-container');
                const clonedElement = draggedElement.cloneNode(true);
                
                // Remove release-related classes and restore backlog classes
                clonedElement.classList.remove('step-item', 'card');
                clonedElement.classList.add('backlog-item');
                clonedElement.id = 'backlog-' + backlogId;
                
                backlogContainer.appendChild(clonedElement);

                // Remove the dropped element from its previous release zone
                draggedElement.remove();

                console.log('Backlog item successfully moved back.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error moving backlog item back:', error.message);
        });
    }
</script>

{% endblock content %}