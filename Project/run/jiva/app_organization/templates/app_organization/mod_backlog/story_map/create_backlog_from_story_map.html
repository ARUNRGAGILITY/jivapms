{% extends 'app_common/common_files/base_template.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load app_web_my_filters %}
{% load markdown_extras %}
{% load mptt_tags %}
 <!-- Bootstrap CSS -->
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
 <!-- Font Awesome CDN -->
 <link
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
 rel="stylesheet"
 integrity="sha512-p6M6Fh8hjbEEC5Vnm68s/bB7o93uaf1/Jq3axRf9UKIY7sVdzIz0yGZrAmkXQOVX3Kbi8e4uJ1UrI6kZe0QkDA=="
 crossorigin="anonymous"
 referrerpolicy="no-referrer"
/>
{% block content %}
    {% include 'app_common/common_files/navbar.html' %}
 
<!-- Custom Styles -->
<style>
    
    /* Top Menu Container */
    .top-menu-container {
        width: 100%;
        background-color: #f8f9fa; /* Light gray background */
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Flex Container */
    .top-menu {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Allows wrapping on smaller screens */
    }

    /* Left Section (40%) */
    .left-section {
        flex: 0 0 30%;
        max-width: 30%;
        display: flex;
        align-items: center;
        gap: 10px; /* Space between elements */
    }

    /* Right Section (60%) */
    .right-section {
        flex: 0 0 70%;
        max-width: 90%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 5px; /* Space between input fields */
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .left-section,
        .right-section {
            flex: 0 0 100%;
            max-width: 100%;
            justify-content: center;
            text-align: center;
        }

        .right-section {
            margin-top: 10px;
            flex-direction: column;
            gap: 10px;
        }
    }

    /* Button Styling */
    .top-menu .btn {
        padding: 6px 12px;
        font-size: 14px;
    }

    /* Optional: Adjust input width */
    .activity_input_style {
        min-width: 200px;
        max-width: 250px; /* Adjust as needed */
        flex: 1; /* Allow input to grow */
    }
    .step_input_style {
        min-width: 200px;
        max-width: 250px; /* Adjust as needed */
        flex: 1; /* Allow input to grow */
    }

    /* Collapsible Sidebar Styles */
.sidebar {
    transition: all 0.3s ease;
    overflow: hidden;
}

.sidebar.collapsed {
    width: 0;
    padding: 0;
    opacity: 0;
}

.toggle-button {
    position: absolute;
    top: 15px;
    left: 20px;
    z-index: 1001;
    background-color: #007bff;
    border: none;
    color: white;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 4px;
}

.toggle-button:focus {
    outline: none;
}

/* Adjust main-content padding when sidebar is visible */
.main-content.with-sidebar {
    margin-left: 0;
}

.main-content.no-sidebar {
    margin-left: 0;
}

/* Adjustments for smaller screens */
@media (max-width: 768px) {
    .toggle-button {
        left: 10px;
        top: 10px;
        padding: 4px 8px;
    }
}
/* Post-it Note Styles */
.post-it {
    position: relative; /* Required for the folded corner */
    min-width: 100px; /* Increased min-width for better appearance */
    max-width: 200px; /* Increased max-width for better readability */
    background-color: #fff9c4; /* Light Yellow Background */
    border: 1px solid #f0e68c; /* Khaki Border */
    padding: 10px;
    margin: 10px;
    font-size: 0.9rem;
    white-space: normal; /* Allow text to wrap */
    overflow: hidden; /* Prevent text overflow */
    text-overflow: ellipsis; /* Add ellipsis for overflowing text */
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); /* Soft Shadow */
    border-radius: 5px; /* Slightly rounded corners */
    box-sizing: border-box; /* Ensure padding and border are included in the width */
    word-wrap: break-word; /* Break long words onto the next line */
}

/* Folded Corner */
.post-it::after {
    content: "";
    position: absolute;
    width: 2px;
    height: 2px;
    background-color: #fff9c4; /* Same as the background color */
    border-left: 1px solid #f0e68c; /* Same as the border color */
    border-top: 1px solid #f0e68c; /* Same as the border color */
    top: -1px; /* Adjust to align with the border */
    right: -1px; /* Adjust to align with the border */
    transform: rotate(45deg);
    box-shadow: -1px -1px 3px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
}

.step-item {
        display: inline-block;
        min-width: 50px;
        max-width: 120px;
        background: #eef;
        border: 1px solid #bbb;
        padding: 5px;
        margin-right: 10px;
        font-size: 0.7rem;
        white-space: normal; /* Allow text to wrap within the item */
        overflow: hidden; /* Prevent text from spilling out */
        text-overflow: ellipsis; /* Add ellipsis for overflowing text */
        vertical-align: top;
        box-sizing: border-box;
        word-wrap: break-word; /* Break long words onto the next line */
    }
.backlog-item {
        display: block;
        min-width: 50px;
        max-width: 120px;
        background: #eef;
        border: 1px solid #bbb;
        padding: 5px;
        margin-right: 10px;
        font-size: 0.7rem;
        white-space: normal; /* Allow text to wrap within the item */
        overflow: hidden; /* Prevent text from spilling out */
        text-overflow: ellipsis; /* Add ellipsis for overflowing text */

        box-sizing: border-box;
        word-wrap: break-word; /* Break long words onto the next line */
    }
    .step-item:last-child {
        margin-right: 0; /* Remove margin for the last item to use the space effectively */
    }

    .content-header {
        margin-top: 10px;
        font-weight: bold;
        width: 20px;
        margin-right: 10px;
        writing-mode: vertical-lr;
        transform: rotate(180deg);
        display: flex;
        align-items: center;
        justify-content: center;
    }

/* Different Background for Step Items */
.step-item {
    background-color: #e1f5fe; /* Light Blue Background */
    border: 1px solid #81d4fa; /* Light Blue Border */
}

.step-item::after {
    background-color: #e1f5fe; /* Match the step item's background */
    border-left: 1px solid #81d4fa;
    border-top: 1px solid #81d4fa;
}

/* Different Background for Backlog Items */
.backlog-item {
    background-color: #fff9c4; /* Light Yellow Background */
    border: 1px solid #f0e68c; /* Khaki Border */
}

.backlog-item::after {
    background-color: #fff9c4; /* Match the backlog item's background */
    border-left: 1px solid #f0e68c;
    border-top: 1px solid #f0e68c;
}

.activity-color {
    background-color: lightyellow;
    border: 1px solid lightcoral; /* Pink Border */
}

.step-color {
    background-color: yellow; /* Light Green Background */
    border: 1px solid #81c784; /* Green Border */
}

.activity-card {
    display: inline-block;
    min-width: 50px;
    max-width: 180px;
    min-height: 80px;
    background: lightcoral;
    color: black;
    border: 1px solid #bbb;
    padding: 5px;
    margin-right: 10px;
    font-size: 0.8rem;
    font-weight: bold;
    white-space: normal; /* Allow text to wrap within the item */
    overflow: hidden; /* Prevent text from spilling out */
    text-overflow: ellipsis; /* Add ellipsis for overflowing text */
    vertical-align: top;
    box-sizing: border-box;
    word-wrap: break-word; /* Break long words onto the next line */
}
.step-card {
    display: inline-block;
    min-width: 50px;
    max-width: 180px;
    min-height: 40px;
    background: lightskyblue;
    color: black;
    border: 1px solid #bbb;
    padding: 5px;
    margin-right: 10px;
    font-size: 0.8rem;
    font-weight: bold;
    white-space: normal; /* Allow text to wrap within the item */
    overflow: hidden; /* Prevent text from spilling out */
    text-overflow: ellipsis; /* Add ellipsis for overflowing text */
    vertical-align: top;
    box-sizing: border-box;
    word-wrap: break-word; /* Break long words onto the next line */
}



/* Ensure the table has a minimum width to trigger horizontal scrolling */
.table-responsive table {
    width: 100%;
    min-width: 800px; /* Adjust this value based on your content */
}

/* Optional: Improve scrolling experience on touch devices */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Enable vertical scrolling for Story Map on smaller screens */
@media (max-width: 768px) {
    .story-map-container {
        max-height: 60vh; /* Adjust the value as needed */
        overflow-y: auto;
    }
}

/* Enable vertical scrolling for Story Map */
.story-map-container {
    max-height: 80vh; /* Sets maximum height to 80% of viewport height */
    overflow-y: auto;  /* Enables vertical scrolling when content overflows */
}

/* Optional: Smooth scrolling experience */
.story-map-container::-webkit-scrollbar {
    width: 8px;
}

.story-map-container::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.2);
    border-radius: 4px;
}

.story-map-container::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0,0,0,0.4);
}


.card {
  position: relative;
  background-color: #fffa65; /* Default Post-it yellow */
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  padding: 15px;
  margin-bottom: 10px;
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.15);
  cursor: grab;
  transition:  box-shadow 0.2s;
  width: 250px; /* Fixed width for consistency */
  word-wrap: break-word;
}


.card:hover {
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
  transform: scale(1) rotate(0deg);
}

/* Optional: Add a small triangle to mimic the corner fold */
.card::before {
  content: '';
  position: absolute;
  top: -10px;
  right: -10px;
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-bottom: 15px solid #e0e0e0;
}

/* Text styling */
.card p {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  color: #333;
}
</style>

<style>
/* Add these styles to your existing CSS section */

/* Available backlog items (unmapped) */
.backlog-item.draggable-backlog {
    background-color: #fff9c4; /* Light yellow - available for mapping */
    border: 1px solid #f0e68c;
    cursor: grab;
    transition: all 0.2s ease;
}

.backlog-item.draggable-backlog:hover {
    transform: scale(1.02);
    box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
    cursor: grab;
}

.backlog-item.draggable-backlog:active {
    cursor: grabbing;
}

/* Already mapped items (read-only reference) */
.backlog-item.mapped-item {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    opacity: 0.8;
    cursor: default;
    border-left: 3px solid #28a745;
}

.mapped-item-name {
    font-weight: 500;
    margin-bottom: 2px;
}

.mapped-item-details {
    color: #155724 !important;
    font-weight: bold;
}

.mapped-item-details .release-name {
    background-color: #c3e6cb;
    padding: 1px 4px;
    border-radius: 2px;
    font-size: 0.5rem;
}

.mapped-item-details .iteration-name {
    background-color: #b3d9b8;
    padding: 1px 4px;
    border-radius: 2px;
    font-size: 0.5rem;
}

/* New items created for current persona */
.backlog-item.new-item {
    background-color: #fff3cd !important;
    border-color: #ffeaa7 !important;
    border-left: 3px solid #f39c12;
}

/* Backlog section improvements */
.backlog-drop-zone {
    min-height: 200px;
    padding: 10px;
}

.backlog-drop-zone.drag-over {
    background-color: #f8f9ff;
    border: 2px dashed #007bff;
}

/* Item type labels */
.item-type-label {
    font-size: 0.6rem;
    color: #6c757d;
    font-weight: normal;
    display: block;
    margin-top: 2px;
}

/* Section headers in backlog */
.backlog-section-header {
    font-size: 0.8rem;
    font-weight: bold;
    color: #495057;
    margin: 10px 0 5px 0;
    padding: 2px 5px;
    border-bottom: 1px solid #dee2e6;
}

/* Empty state styling */
.backlog-empty-state {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 20px;
    border: 1px dashed #dee2e6;
    border-radius: 4px;
    margin: 10px 0;
}

/* Responsive adjustments for backlog sidebar */
@media (max-width: 768px) {
    .backlog-item {
        margin-bottom: 8px;
        font-size: 0.8rem;
    }
    
    .col-md-2 {
        margin-bottom: 20px;
    }
}
</style>

<style>
    /* Enhanced Persona Markers and Mapped Items Styles */

/* Persona Markers */
.persona-markers {
    z-index: 10;
}

.persona-marker {
    display: inline-block;
    min-width: 16px;
    height: 16px;
    line-height: 14px;
    text-align: center;
    border-radius: 8px;
    font-weight: bold;
    cursor: help;
    transition: transform 0.2s ease;
}

.persona-marker:hover {
    transform: scale(1.2);
    z-index: 15;
}

.persona-marker.badge-success {
    background-color: #28a745 !important;
    color: white;
}

.persona-marker.badge-warning {
    background-color: #ffc107 !important;
    color: #212529;
}

/* Mapped Items Enhanced Styling */
.mapped-item {
    position: relative;
    min-height: 60px;
    margin-bottom: 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    cursor: default;
}

.mapped-item:hover {
    transform: translateY(-1px);
    box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.15);
}

/* Current persona items */
.mapped-item[data-is-current="true"] {
    border-left: 4px solid #28a745;
}

.mapped-item[data-is-current="true"]:hover {
    background-color: #c8e6c9 !important;
}

/* Other persona items */
.mapped-item[data-is-current="false"] {
    border-left: 4px solid #ffc107;
}

.mapped-item[data-is-current="false"]:hover {
    background-color: #fff8e1 !important;
}

/* Conflict indicators */
.mapped-item[data-personas*=","] {
    border-left: 4px solid #dc3545;
    position: relative;
}

.mapped-item[data-personas*=","]::before {
    content: "!";
    position: absolute;
    top: -5px;
    left: -8px;
    background-color: #dc3545;
    color: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

/* Action buttons */
.item-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.mapped-item:hover .item-actions {
    opacity: 1;
}

.btn-xs {
    padding: 2px 6px;
    font-size: 0.65rem;
    line-height: 1;
    border-radius: 3px;
}

/* Persona Switcher */
.persona-switcher {
    position: relative;
}

.persona-switcher select {
    border: 1px solid #28a745;
    background-color: #f8fff9;
    color: #155724;
    cursor: pointer;
}

.persona-switcher select:focus {
    border-color: #1e7e34;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Mapping stats */
.mapping-stats {
    border: 1px solid #e9ecef;
    font-size: 0.75rem;
}

.mapping-stats .row > div {
    padding: 0 5px;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .persona-marker {
        min-width: 14px;
        height: 14px;
        font-size: 0.4rem;
    }
    
    .mapped-item-content {
        margin-right: 35px !important;
    }
    
    .persona-switcher select {
        font-size: 0.7rem;
    }
}

/* Tooltip enhancements */
.persona-marker[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.6rem;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
}

/* Animation for new items */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.mapped-item.new-mapping {
    animation: slideIn 0.3s ease-out;
}

/* Filter states */
.mapped-item.filtered-out {
    display: none;
}

.mapped-item.highlighted {
    background-color: #fff9c4 !important;
    border-color: #f0e68c !important;
    box-shadow: 0 0 10px rgba(240, 230, 140, 0.5);
}
</style>
<div class="page-container">
    <!-- Custom Top Menu -->
    <div class="top-menu-container">
        <div class="top-menu">
            <!-- Left-Aligned Section (40%) -->
            <div class="left-section">
               <b>Story Mapping: <a href="{% url 'list_projects' org_id %}">{{project.name}}</a></b>
               &nbsp;&nbsp;
               <a href="{% url 'view_project_tree_backlog' project.id %}" class="btn btn-sm btn-primary" style="font-size: 12px;"><b>Back to Backlog</b></a>
            </div>

            <!-- Right-Aligned Section (60%) -->
            <div class="right-section">
                <!-- Persona Switcher Dropdown -->
                 TEST
                <div class="persona-switcher">
                    <select class="form-select form-select-sm" id="persona-switcher" onchange="switchPersona(this.value)" style="width: auto; font-size: 0.75rem;">
                        <option value="">Switch Persona...</option>
                        {% for p in all_personas %}
                            {% if p.id != persona.id %}
                                <option value="{{ p.id }}">{{ p.name|default:"Unnamed Persona" }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <a href="{% url 'storymap_group_steps' pro_id=project.id persona_id=persona.id %}" class="btn btn-sm btn-success">Configure Activities/Steps</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
       
        <!-- display-->
        <div class="row">
            <!-- Left Sidebar (Backlog) -->
         <div class="col col-md-2" id="">
    <!-- Sidebar Header -->
    <div class="container-fluid-width">
        <div class="row">
            <div class="col col-md-12">
               <div class="message_display"></div>
            </div>
        </div>
    </div>
    <!-- Sidebar Content -->
    <div class="container-fluid-width mt-2">
        <table class="table table-bordered">
            <!-- Backlog Row -->                         
            <tr id="details-row">
    <td colspan="" class="backlog-drop-zone"
    ondragover="allowDrop(event)"
    ondrop="dropToBacklog(event)">
    <strong>Backlog Items</strong>
    
    <!-- Form to add new backlog items -->
    <form method="post" action="" id="add-backlog-form">
    {% csrf_token %}
    <input type="hidden" name="project_id" value="{{ pro_id }}">
    <input type="hidden" name="persona_id" value="{{ persona.id }}">
    <input type="hidden" name="submit_detail" value="submit_detail">
        <div class="input-group input-group-sm mb-2">
            <input type="text" name="detail" id="detail" class="form-control form-control-sm" placeholder="Add new item..." required>
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
        </div>
    </form>
    
    <!-- Show unmapped existing backlog items -->
    {% if unmapped_backlog_items %}
        <div class="mb-3">
            <small class="text-muted"><strong>Available Items:</strong></small>
            <div id="unmapped-items-container">
                {% for backlog_item in unmapped_backlog_items %}
                    <div class="backlog-item post-it draggable-backlog" 
                         draggable="true" 
                         id="backlog-{{ backlog_item.id }}"
                         ondblclick="makeEditable(this);" 
                         onblur="save_element_text(this, '{{backlog_item.id}}', 'app_organization', 'Backlog', 'name')"
                         title="Created: {{ backlog_item.created_at|date:'M d, Y' }}">
                        {{ backlog_item.name }}
                        <small class="d-block text-muted" style="font-size: 0.6rem;">
                            {% if backlog_item.type %}{{ backlog_item.type.name }}{% endif %}
                        </small>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Show items that are already mapped (for reference) -->
   <!-- Enhanced Already Mapped Items Section -->
{% if mapped_backlog_items %}
<div class="mb-3" id="mapped-items-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <small class="text-success"><strong>Already Mapped Items:</strong></small>
        
        <!-- Persona Switcher Dropdown -->
        <div class="persona-switcher">
            <select class="form-select form-select-sm" id="persona-switcher" onchange="switchPersona(this.value)" style="width: auto; font-size: 0.75rem;">
                <option value="">Switch Persona...</option>
                {% for p in all_personas %}
                    {% if p.id != persona.id %}
                        <option value="{{ p.id }}">{{ p.name|default:"Unnamed Persona" }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    
    {% for mapped_item in mapped_backlog_items %}
    <div class="backlog-item post-it mapped-item position-relative" 
         id="mapped-{{ mapped_item.backlog_item.id }}"
         data-story-id="{{ mapped_item.backlog_item.id }}"
         data-personas="{{ mapped_item.mapped_personas|join:',' }}"
         data-is-current="{{ mapped_item.is_current_persona|yesno:'true,false' }}"
         style="background-color: {% if mapped_item.is_current_persona %}#d4edda{% else %}#fff3cd{% endif %}; 
                border-color: {% if mapped_item.is_current_persona %}#c3e6cb{% else %}#ffeaa7{% endif %}; 
                opacity: {% if mapped_item.is_current_persona %}1{% else %}0.7{% endif %};"
         title="{% if mapped_item.is_current_persona %}Your mapping{% else %}Mapped by other persona(s){% endif %}">
        
        <!-- Persona Markers -->
        <div class="persona-markers position-absolute" style="top: 2px; right: 2px;">
            {% for detail in mapped_item.mapping_details %}
                <span class="persona-marker badge {% if detail.is_current_persona %}badge-success{% else %}badge-warning{% endif %}" 
                      style="font-size: 0.5rem; margin: 1px;"
                      title="{{ detail.persona_name }}{% if detail.release_name != 'Not Set' %} - {{ detail.release_name }}{% endif %}">
                    {% if detail.is_current_persona %}
                        <i class="fas fa-user"></i>
                    {% else %}
                        <i class="fas fa-lock"></i>
                    {% endif %}
                    {{ detail.persona_name|truncatechars:3 }}
                </span>
            {% endfor %}
        </div>
        
        <!-- Item Content -->
        <div class="mapped-item-content" style="margin-right: 40px;">
            <div class="mapped-item-name" style="font-weight: 500; margin-bottom: 2px;">
                {{ mapped_item.backlog_item.name }}
            </div>
            
            <!-- Primary mapping details (current persona if available, otherwise first mapping) -->
            {% with mapped_item.mapping_details|first as primary_detail %}
            <small class="d-block text-muted mapped-item-details" style="font-size: 0.6rem;">
                {% if mapped_item.is_current_persona %}
                    <span class="text-success">✓ Your mapping:</span>
                {% else %}
                    <span class="text-warning">⚠ Mapped by {{ primary_detail.persona_name }}:</span>
                {% endif %}
                
                {% if primary_detail.release_name and primary_detail.release_name != 'Not Set' %}
                    <span class="release-name badge badge-light" style="font-size: 0.5rem;">{{ primary_detail.release_name }}</span>
                {% endif %}
                
                {% if primary_detail.iteration_name and primary_detail.iteration_name != 'Not Set' %}
                    <span class="iteration-name badge badge-light" style="font-size: 0.5rem;">{{ primary_detail.iteration_name }}</span>
                {% endif %}
            </small>
            
            {% if primary_detail.activity_name and primary_detail.activity_name != 'Not Set' %}
            <small class="d-block text-muted" style="font-size: 0.5rem;">
                {{ primary_detail.activity_name }}
                {% if primary_detail.step_name and primary_detail.step_name != 'Not Set' %} → {{ primary_detail.step_name }}{% endif %}
            </small>
            {% endif %}
            {% endwith %}
            
            <!-- Show conflict indicator if multiple personas -->
            {% if mapped_item.mapped_personas_count > 1 %}
            <small class="d-block text-danger" style="font-size: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> 
                Conflict: {{ mapped_item.mapped_personas_count }} personas
            </small>
            {% endif %}
        </div>
        
        <!-- Action Buttons (only show for current persona items) -->
        {% if mapped_item.is_current_persona %}
        <div class="item-actions position-absolute" style="bottom: 2px; right: 2px;">
            <button class="btn btn-xs btn-outline-warning" 
                    onclick="unmapFromPersona({{ mapped_item.backlog_item.id }}, '{{ mapped_item.backlog_item.name|escapejs }}')"
                    style="font-size: 0.6rem; padding: 1px 4px;"
                    title="Remove from your persona">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Summary Stats -->
    <div class="mapping-stats mt-2 p-2" style="background-color: #f8f9fa; border-radius: 4px; font-size: 0.7rem;">
        <div class="row">
            <div class="col-6">
                <strong>Your Items:</strong> 
                <span class="text-success">{{ mapped_backlog_items|length|add:"-1"|add:"1" }} 
                    {# This is a hacky way to count, better to pass count from view #}
                </span>
            </div>
            <div class="col-6">
                <strong>Conflicts:</strong> 
                <span class="text-danger" id="conflict-count">0</span>
            </div>
        </div>
    </div>
</div>
{% endif %}
    <!-- Show newly created items for this persona -->
    <div id="new-items-container">
        {% for backlog_item in initial_backlog %}
            {% if backlog_item.persona_id == persona.id and backlog_item.release_id == None and backlog_item.name != project_id_str %}
                <div class="backlog-item post-it draggable-backlog" 
                     draggable="true" 
                     id="backlog-{{ backlog_item.id }}"
                     ondblclick="makeEditable(this);" 
                     onblur="save_element_text(this, '{{backlog_item.id}}', 'app_organization', 'Backlog', 'name')"
                     style="background-color: #fff3cd; border-color: #ffeaa7;"
                     title="New item created for this persona">
                    {{ backlog_item.name }}
                    <small class="d-block text-muted" style="font-size: 0.6rem;">
                        New
                    </small>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Show message if no items available -->
    {% if not unmapped_backlog_items and not mapped_backlog_items %}
        <div class="text-center text-muted mt-3" id="empty-state">
            <small>
                <i class="fas fa-info-circle"></i><br>
                No backlog items found.<br>
                Create new items using the form above.
            </small>
        </div>
    {% endif %}
    
    </td>
</tr>
       </table>
    </div>
</div>
            <!-- Right Sidebar (Story Map) -->
            <div class="col col-md-10 text-start story-map-container">
                <i class="bi bi-person-heart"></i> &nbsp;
                <b>Persona:</b>
                <b id="persona_name" class="persona-name" ondblclick="makeEditable(this)"
                onblur="save_element_text(this, '{{ persona.id }}', 'app_organization', 'Persona', 'name')">
                {% if persona.name != '' %}{{ persona.name }}{% else %}Enter Persona name here...{% endif %}</b>
                <div class="table-responsive">
                <table class="table table-bordered">
                    <!-- Activities Row --> 
                    <tr>
                        <td width="3%">
                            <div class="content-header">Activities</div>
                        </td>
                        {% for activity in activities %}
                            {% with activity.activity_steps.all|filter_active|length as step_count %}
                                {% if step_count > 0 %}
                                    <td colspan="{{ step_count }}" class="activity-header" style="border-left: 3px solid lightgrey;">
                                        <div class="activity-card post-it activity-color"  id="activity-{{ activity.id }}"
                                        ondblclick="makeEditable(this);"
                                        onblur="save_element_text(this, '{{ activity.id }}', 'app_organization', 'Activity', 'name')"
                                        >
                                            {{ activity.name }} ({{ step_count }})
                                        </div>
                                    </td>
                                {% else %}
                                    <input type="hidden" {% if activity.name == 'Default Activity' %}data-default-activity-id="{{ activity.id }}"{% endif %}>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                
                    <!-- Steps Row -->
                    <tr id="steps-row">
                        <td width="3%">
                            <div class="content-header">Steps</div>
                        </td>
                        {% for activity in activities %}
                            {% with activity.activity_steps.all|filter_active as steps %}
                                {% for step in steps %}
                                    <td class="step-cell" style="border-left: {% if forloop.first %}3px solid lightgrey;{% else %}none;{% endif %}">
                                        <div class="step-card post-it step-color" draggable="true" id="step-{{ step.id }}"
                                             ondblclick="makeEditable(this);"
                                             onblur="save_element_text(this, '{{ step.id }}', 'app_organization', 'Step', 'name')">
                                            {{ step.name }}
                                        </div>
                                    </td>
                                {% endfor %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                
                    <!-- Releases Rows -->
                    {% if not project.project_release %}
                    <b>Please map this project with a release</b>
                    {% endif %}
                    {% for release in releases %}
                    {% if release.id == project.project_release.id %}
                        {% for iteration in release.org_release_org_iterations.all|filter_active %}
                        <tr id="release-row-{{ release.id }}">
                            <td width="3%">
                                <div class="content-header">{{ release.name }} / {{iteration.name}}</div>
                            </td>
                            {% for activity in activities %}
                                {% with activity.activity_steps.all|filter_active as steps %}
                                    {% for step in steps %}
                                        <td class="release-drop-zone"
                                            data-release-id="{{ release.id }}"
                                            data-iteration-id="{{ iteration.id }}"
                                            data-activity-id="{{ activity.id }}"
                                            data-step-id="{{ step.id }}"
                                            
                                            ondragover="allowDrop(event)"
                                            ondrop="drop(event)"
                                            style="border-left: {% if forloop.first %}3px solid lightgrey;{% else %}none;{% endif %};">
                                            
                                            {% for story_map in story_maps %}
                                                {% if story_map.release_id == release.id and story_map.activity_id == activity.id and story_map.step_id == step.id and story_map.iteration_id == iteration.id and story_map.active %}
                                                   
                                                        {% for backlog_item in backlog %}
                                                        {% if story_map.story_id == backlog_item.id and backlog_item.release_id != None and backlog_item.iteration_id != None %}
                                                        <div class="step-item post-it card draggable-backlog" draggable="true" id="backlog-{{ story_map.story_id }}"
                                                        ondblclick="makeEditable(this);" 
                                                        onblur="save_element_text(this, '{{ story_map.story_id }}', 'app_organization', 'Backlog', 'name')">{{ backlog_item.name }}
                                                            </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                        
                                                    
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                    {% endfor %}
                                {% endwith %}
                            {% endfor %}
                            <!-- Optional: Add extra empty cells if needed -->
                          
                        </tr>
                        {% endfor %}
                       
                        {% endif %}
                    {% endfor %}
                    
                </table>
            </div>
            

            </div>
        </div>
 

    <!-- Main content -->
    </div>

</div>

<script>
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'a') {
            // Focus on the activity input
            event.preventDefault(); // Prevent default Ctrl+A behavior (select all)
            document.getElementById('activity').focus();
        } else if (event.ctrlKey && event.key === 's') {
            // Focus on the step input
            event.preventDefault(); // Prevent default Ctrl+S behavior (save)
            document.getElementById('step_input').focus();
        } else if (event.ctrlKey && event.key === 'b') {
            // Focus on the detail input
            event.preventDefault(); // Prevent default behavior
            document.getElementById('detail').focus();
        }
    });
</script>

<script>

     // Event Delegation for dragstart
     document.addEventListener('dragstart', function(event) {
        if (event.target.classList.contains('draggable-backlog')) {
            event.dataTransfer.setData("text/plain", event.target.id);
        }
    });


    function makeEditable(element) {
        element.contentEditable = true;
        element.focus();
    }

    function save_element_text(element, id,  appName, modelName, fieldName) {
        element.contentEditable = false;
        $.ajax({
            url: '/common/common_ajax/ajax_save_element_text/',
            type: 'POST',
            data : {
            'csrfmiddlewaretoken': "{{ csrf_token }}",
            'model_name': modelName,
            'app_name': appName,
            'field_name': fieldName,
            'text': element.textContent, 
            'id': id,
            },
            dataType: 'json',
            success: function(data) {
                console.log("Success:");
                // console.log(data);
            },
            error: function(xhr, status, error) {
                console.error('SAVE ELEMENT Error:', status, error);
            }
        })
    }
    
</script>


    


<script>
    // Allow drop by preventing default behavior
    function allowDrop(event) {
        event.preventDefault();
    }
    
    // Handle the drag start event
    document.querySelectorAll('.draggable-backlog').forEach(item => {
        item.addEventListener('dragstart', function(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
        });
    });
    
    function drop(event) {
    event.preventDefault();

    // Get the dragged element's ID
    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    // Extract the backlog ID
    const backlogId = draggedId.split('-')[1];

    // Get the drop zone's data attributes
    const dropZone = event.target.closest('.release-drop-zone');
    const releaseId = dropZone.getAttribute('data-release-id');
    const iterationId = dropZone.getAttribute('data-iteration-id');
    const activityId = dropZone.getAttribute('data-activity-id');
    const stepId = dropZone.getAttribute('data-step-id');



    // Optional: Visual feedback for successful drop
    dropZone.classList.add('dropped');

    // Prepare the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        story_id: backlogId,
        release_id: releaseId,
        //iteration_id: '-1', // To skip iteration
        iteration_id: iterationId,
        activity_id: activityId,
        step_id: stepId,
        persona_id: {{ persona.id }},

    };

    // Send the AJAX request to the backend
    fetch("{% url 'ajax_recieve_story_mapped_details' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Move the dragged element to the drop zone
                const clonedElement = draggedElement.cloneNode(true);
                // Remove backlog-related classes
                clonedElement.classList.remove('backlog-item');

                // Add release-related classes
                clonedElement.classList.add('step-item', 'card');
                dropZone.appendChild(clonedElement);
                
                // Optionally, remove the element from the source container
                draggedElement.remove();
                

                console.log('Backlog item successfully assigned to the release.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error updating story location:', error.message);
            dropZone.classList.remove('dropped');
            //alert('Failed to assign backlog item: ' + error.message);
        });
}
</script>


<script>
    
function dropToBacklog(event) {
    event.preventDefault();

    // Get the dragged element's ID
    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    // Extract the backlog ID
    const backlogId = draggedId.split('-')[1];

    // Define the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        backlog_id: backlogId,
        persona_id: {{ persona.id }},
        release_id: null, // Remove release association
    };

    // Send the AJAX request to the backend
    fetch("{% url 'ajax_update_backlog_release' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Append the dragged element back to the backlog drop zone
                const backlogDropZone = document.querySelector('.backlog-drop-zone');
                clonedElement = draggedElement.cloneNode(true);
                // Remove release-related classes
                clonedElement.classList.remove('step-item', 'card');

                // Add backlog-related classes
                clonedElement.classList.add('backlog-item');
                backlogDropZone.appendChild(clonedElement);

                // Optional: Remove the dropped element from its previous release zone
                draggedElement.remove();

                console.log('Backlog item successfully moved back.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error moving backlog item back:', error.message);
        });
}

// AJAX UPDATE ALREADY MAPPED
// Add this JavaScript to your template to handle dynamic updates

// // Function to refresh the mapped items section
// function refreshMappedItems() {
//     $.ajax({
//         url: "{% url 'ajax_refresh_mapped_items' %}",
//         type: 'POST',
//         data: {
//             csrfmiddlewaretoken: '{{ csrf_token }}',
//             pro_id: '{{ pro_id }}',
//             persona_id: '{{ persona.id }}'
//         },
//         success: function(response) {
//             if (response.status === 'success') {
//                 $('#mapped-items-section').html(response.html);
//             }
//         },
//         error: function(xhr, status, error) {
//             console.error('refreshMappedItems: Error refreshing mapped items:', error);
//         }
//     });
// }

// Function to move item from mapped to unmapped section
function moveToUnmapped(storyId, storyName) {
    // Remove from mapped section
    $(`#mapped-${storyId}`).remove();
    
    // Add to unmapped section
    const unmappedContainer = $('.backlog-drop-zone');
    const newItem = `
        <div class="backlog-item post-it draggable-backlog" 
             draggable="true" 
             id="backlog-${storyId}"
             ondblclick="makeEditable(this);" 
             onblur="save_element_text(this, '${storyId}', 'app_organization', 'Backlog', 'name')"
             title="Moved back to unmapped">
            ${storyName}
            <small class="d-block text-muted" style="font-size: 0.6rem;">
                Available
            </small>
        </div>
    `;
    
    // Insert after the form but before other items
    const form = unmappedContainer.find('form');
    if (form.length) {
        form.after('<br>' + newItem);
    } else {
        unmappedContainer.prepend(newItem);
    }
    
    // Re-enable drag events for the new item
    const newElement = $(`#backlog-${storyId}`)[0];
    if (newElement) {
        newElement.addEventListener('dragstart', function(event) {
            event.dataTransfer.setData("text/plain", event.target.id);
        });
    }
}

// Function to move item from unmapped to mapped section
function moveToMapped(storyId, releaseData) {
    // Remove from unmapped section
    $(`#backlog-${storyId}`).remove();
    
    // Refresh the mapped items section to show the new mapping
    refreshMappedItems();
}

// Update the existing drop function to refresh mapped items
function drop(event) {
    event.preventDefault();

    // Get the dragged element's ID
    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    // Extract the backlog ID
    const backlogId = draggedId.split('-')[1];
    const storyName = draggedElement.textContent.trim();

    // Get the drop zone's data attributes
    const dropZone = event.target.closest('.release-drop-zone');
    const releaseId = dropZone.getAttribute('data-release-id');
    const iterationId = dropZone.getAttribute('data-iteration-id');
    const activityId = dropZone.getAttribute('data-activity-id');
    const stepId = dropZone.getAttribute('data-step-id');

    // Optional: Visual feedback for successful drop
    dropZone.classList.add('dropped');

    // Prepare the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        story_id: backlogId,
        release_id: releaseId,
        iteration_id: iterationId,
        activity_id: activityId,
        step_id: stepId,
        persona_id: {{ persona.id }},
    };

    // Send the AJAX request to the backend
    fetch("{% url 'ajax_recieve_story_mapped_details' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Move the dragged element to the drop zone
                const clonedElement = draggedElement.cloneNode(true);
                // Remove backlog-related classes
                clonedElement.classList.remove('backlog-item');

                // Add release-related classes
                clonedElement.classList.add('step-item', 'card');
                dropZone.appendChild(clonedElement);
                
                // Remove the element from the source container
                draggedElement.remove();
                
                // Update the mapped items section
                refreshMappedItems();

                console.log('Backlog item successfully assigned to the release.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error updating story location:', error.message);
            dropZone.classList.remove('dropped');
        });
}

// Update the dropToBacklog function to refresh mapped items
function dropToBacklog(event) {
    event.preventDefault();

    // Get the dragged element's ID
    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    // Extract the backlog ID
    const backlogId = draggedId.split('-')[1];
    const storyName = draggedElement.textContent.trim();

    // Define the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        backlog_id: backlogId,
        persona_id: {{ persona.id }},
        release_id: null, // Remove release association
    };

    // Send the AJAX request to the backend
    fetch("{% url 'ajax_update_backlog_release' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Append the dragged element back to the backlog drop zone
                const backlogDropZone = document.querySelector('.backlog-drop-zone');
                clonedElement = draggedElement.cloneNode(true);
                // Remove release-related classes
                clonedElement.classList.remove('step-item', 'card');

                // Add backlog-related classes
                clonedElement.classList.add('backlog-item', 'draggable-backlog');
                
                // Add draggable attribute and events
                clonedElement.setAttribute('draggable', 'true');
                clonedElement.addEventListener('dragstart', function(event) {
                    event.dataTransfer.setData("text/plain", event.target.id);
                });
                
                backlogDropZone.appendChild(clonedElement);

                // Remove the dropped element from its previous release zone
                draggedElement.remove();
                
                // Update the mapped items section
                refreshMappedItems();

                console.log('Backlog item successfully moved back.');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error moving backlog item back:', error.message);
        });
}

</script>



<script>
// Enhanced form submission with AJAX
$(document).ready(function() {
    $('#add-backlog-form').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const detailInput = $('#detail');
        const detailValue = detailInput.val().trim();
        
        if (!detailValue) {
            alert('Please enter a backlog item name.');
            return;
        }
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop('disabled', true).text('Adding...');
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('Form submission response:', response);
                
                if (response.status === 'success') {
                    // Create new backlog item element
                    const newItemHtml = `
                        <div class="backlog-item post-it draggable-backlog" 
                             draggable="true" 
                             id="backlog-${response.backlog_id}"
                             ondblclick="makeEditable(this);" 
                             onblur="save_element_text(this, '${response.backlog_id}', 'app_organization', 'Backlog', 'name')"
                             style="background-color: #fff3cd; border-color: #ffeaa7;"
                             title="New item created for this persona">
                            ${response.backlog_name}
                            <small class="d-block text-muted" style="font-size: 0.6rem;">
                                New
                            </small>
                        </div>
                    `;
                    
                    // Add to new items container
                    $('#new-items-container').append(newItemHtml);
                    
                    // Hide empty state if it exists
                    $('#empty-state').hide();
                    
                    // Enable drag functionality for the new item
                    const newElement = $(`#backlog-${response.backlog_id}`)[0];
                    if (newElement) {
                        newElement.addEventListener('dragstart', function(event) {
                            event.dataTransfer.setData("text/plain", event.target.id);
                        });
                    }
                    
                    // Clear the form
                    detailInput.val('');
                    
                    // Show success message
                    showMessage('Backlog item added successfully!', 'success');
                    
                } else {
                    showMessage(response.message || 'Error adding backlog item', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Form submission error:', error);
                showMessage('Error adding backlog item: ' + error, 'error');
            },
            complete: function() {
                // Reset button state
                submitBtn.prop('disabled', false).text(originalText);
            }
        });
    });
});

// Enhanced dropToBacklog function
function dropToBacklog(event) {
    event.preventDefault();

    // Get the dragged element's ID
    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    // Extract the backlog ID
    const backlogId = draggedId.split('-')[1];
    const storyName = draggedElement.textContent.trim();

    // Define the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        backlog_id: backlogId,
        persona_id: {{ persona.id }},
        release_id: null, // Remove release association
    };

    // Send the AJAX request to the backend
    fetch("{% url 'ajax_update_backlog_release' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
        .then((response) => {
            if (!response.ok) {
                return response.json().then((err) => {
                    throw new Error(err.message || 'Server Error');
                });
            }
            return response.json();
        })
        .then((data) => {
            if (data.status === 'success') {
                // Create new element for backlog
                const newItemHtml = `
                    <div class="backlog-item post-it draggable-backlog" 
                         draggable="true" 
                         id="backlog-${backlogId}"
                         ondblclick="makeEditable(this);" 
                         onblur="save_element_text(this, '${backlogId}', 'app_organization', 'Backlog', 'name')"
                         title="Moved back from story map">
                        ${storyName.split('\n')[0]}
                        <small class="d-block text-muted" style="font-size: 0.6rem;">
                            Available
                        </small>
                    </div>
                `;
                
                // Add to unmapped items container
                let container = document.getElementById('unmapped-items-container');
                if (!container) {
                    // Create container if it doesn't exist
                    const backlogDropZone = document.querySelector('.backlog-drop-zone');
                    const newContainer = document.createElement('div');
                    newContainer.innerHTML = `
                        <div class="mb-3">
                            <small class="text-muted"><strong>Available Items:</strong></small>
                            <div id="unmapped-items-container"></div>
                        </div>
                    `;
                    // Insert after the form
                    const form = backlogDropZone.querySelector('form');
                    form.parentNode.insertBefore(newContainer, form.nextSibling);
                    container = document.getElementById('unmapped-items-container');
                }
                
                container.insertAdjacentHTML('beforeend', newItemHtml);
                
                // Enable drag functionality for the new item
                const newElement = document.getElementById(`backlog-${backlogId}`);
                if (newElement) {
                    newElement.addEventListener('dragstart', function(event) {
                        event.dataTransfer.setData("text/plain", event.target.id);
                    });
                }

                // Remove the original element from the story map
                draggedElement.remove();
                
                // Update the mapped items section
                refreshMappedItems();

                console.log('Backlog item successfully moved back.');
                showMessage('Item moved back to backlog', 'success');
            } else {
                throw new Error(data.message);
            }
        })
        .catch((error) => {
            console.error('Error moving backlog item back:', error.message);
            showMessage('Error moving item back: ' + error.message, 'error');
        });
}

// Enhanced drag over effects
function allowDrop(event) {
    event.preventDefault();
    
    // Add visual feedback
    const dropZone = event.currentTarget;
    if (dropZone.classList.contains('backlog-drop-zone')) {
        dropZone.style.backgroundColor = '#f8f9ff';
        dropZone.style.border = '2px dashed #007bff';
    }
}

// Remove drag over effects
document.addEventListener('dragleave', function(event) {
    if (event.target.classList.contains('backlog-drop-zone')) {
        event.target.style.backgroundColor = '';
        event.target.style.border = '';
    }
});

document.addEventListener('drop', function(event) {
    if (event.target.classList.contains('backlog-drop-zone')) {
        event.target.style.backgroundColor = '';
        event.target.style.border = '';
    }
});

// Message display function
function showMessage(message, type = 'info') {
    const messageContainer = document.querySelector('.message_display');
    if (messageContainer) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        
        messageContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            const alert = messageContainer.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 3000);
    }
}
</script>

<script>
    // Enhanced JavaScript Functions for Persona Management

// Switch to different persona
function switchPersona(personaId) {
    if (!personaId) return;
    
    // Show loading state
    showMessage('Switching to persona...', 'info');
    
    // Redirect to the selected persona's story map
    const currentUrl = window.location.pathname;
    const newUrl = currentUrl.replace(/persona_id\/\d+/, `persona_id/${personaId}`);
    window.location.href = newUrl;
}

// // Unmap item from current persona
// function unmapFromPersona(storyId, storyName) {
//     if (!confirm(`Remove "${storyName}" from your persona mapping?`)) {
//         return;
//     }
    
//     // Show loading state
//     const button = event.target.closest('button');
//     const originalContent = button.innerHTML;
//     button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
//     button.disabled = true;
    
//     $.ajax({
//         url: "{% url 'ajax_update_backlog_release' %}",
//         type: 'POST',
//         data: {
//             csrfmiddlewaretoken: '{{ csrf_token }}',
//             backlog_id: storyId,
//             release_id: null,
//             persona_id: {{ persona.id }}
//         },
//         success: function(response) {
//             if (response.status === 'success') {
//                 // Remove from mapped section and add to unmapped
//                 moveFromMappedToUnmapped(storyId, storyName);
//                 showMessage('Item removed from your persona', 'success');
//                 updateMappingStats();
//             } else {
//                 showMessage('Error: ' + response.message, 'error');
//             }
//         },
//         error: function(xhr, status, error) {
//             console.error('unmapFromPersonaError refreshing mapped items:', error);
//             //showMessage('Error removing item: ' + error, 'error');
//         },
//         complete: function() {
//             // Reset button state
//             button.innerHTML = originalContent;
//             button.disabled = false;
//         }
//     });
// }

// Move item from mapped to unmapped section
function moveFromMappedToUnmapped(storyId, storyName) {
    // Remove from mapped section
    $(`#mapped-${storyId}`).fadeOut(300, function() {
        $(this).remove();
        
        // Add to unmapped section
        const newItemHtml = `
            <div class="backlog-item post-it draggable-backlog new-mapping" 
                 draggable="true" 
                 id="backlog-${storyId}"
                 ondblclick="makeEditable(this);" 
                 onblur="save_element_text(this, '${storyId}', 'app_organization', 'Backlog', 'name')"
                 title="Moved back from story map">
                ${storyName}
                <small class="d-block text-muted" style="font-size: 0.6rem;">
                    Available
                </small>
            </div>
        `;
        
        // Find or create unmapped container
        let container = $('#unmapped-items-container');
        if (container.length === 0) {
            const backlogDropZone = $('.backlog-drop-zone');
            const newContainer = $(`
                <div class="mb-3">
                    <small class="text-muted"><strong>Available Items:</strong></small>
                    <div id="unmapped-items-container"></div>
                </div>
            `);
            backlogDropZone.find('form').after(newContainer);
            container = $('#unmapped-items-container');
        }
        
        container.append(newItemHtml);
        
        // Enable drag functionality
        const newElement = $(`#backlog-${storyId}`)[0];
        if (newElement) {
            newElement.addEventListener('dragstart', function(event) {
                event.dataTransfer.setData("text/plain", event.target.id);
            });
        }
        
        // Remove empty state if no mapped items left
        if ($('.mapped-item').length === 0) {
            $('#mapped-items-section').hide();
        }
    });
}

// Update mapping statistics
function updateMappingStats() {
    const totalMapped = $('.mapped-item').length;
    const yourItems = $('.mapped-item[data-is-current="true"]').length;
    const conflicts = $('.mapped-item[data-personas*=","]').length;
    
    // Update stats display
    $('.mapping-stats .text-success').text(yourItems);
    $('#conflict-count').text(conflicts);
    
    // Update stats color based on conflicts
    if (conflicts > 0) {
        $('#conflict-count').removeClass('text-warning').addClass('text-danger');
    } else {
        $('#conflict-count').removeClass('text-danger').addClass('text-success');
    }
}

// // Enhanced refresh mapped items function
// function refreshMappedItems() {
//     $.ajax({
//         url: "{% url 'ajax_refresh_mapped_items' %}",
//         type: 'POST',
//         data: {
//             csrfmiddlewaretoken: '{{ csrf_token }}',
//             pro_id: '{{ pro_id }}',
//             persona_id: '{{ persona.id }}'
//         },
//         success: function(response) {
//             if (response.status === 'success') {
//                 $('#mapped-items-section').html(response.html);
//                 updateMappingStats();
                
//                 // Re-initialize tooltips and interactions
//                 initializeMappedItemsInteractions();
//             }
//         },
//         error: function(xhr, status, error) {
//             console.error('Error refreshing mapped items:', error);
//             //showMessage('Error refreshing mapped items', 'error');
//         }
//     });
// }

// Initialize interactions for mapped items
function initializeMappedItemsInteractions() {
    // Initialize tooltips
    $('[title]').tooltip({
        placement: 'top',
        trigger: 'hover'
    });
    
    // Add click handlers for persona markers
    $('.persona-marker').on('click', function(e) {
        e.stopPropagation();
        const personaName = $(this).attr('title').split(' - ')[0];
        showMessage(`This item is mapped by: ${personaName}`, 'info');
    });
    
    // Add double-click to highlight conflicts
    $('.mapped-item[data-personas*=","]').on('dblclick', function() {
        $(this).addClass('highlighted');
        setTimeout(() => {
            $(this).removeClass('highlighted');
        }, 2000);
        
        const personas = $(this).attr('data-personas').split(',');
        showMessage(`Conflict: Mapped by ${personas.join(', ')}`, 'warning');
    });
}

// Filter mapped items by persona
function filterMappedItemsByPersona(personaName) {
    if (!personaName) {
        $('.mapped-item').removeClass('filtered-out');
        return;
    }
    
    $('.mapped-item').each(function() {
        const itemPersonas = $(this).attr('data-personas');
        if (itemPersonas && itemPersonas.includes(personaName)) {
            $(this).removeClass('filtered-out');
        } else {
            $(this).addClass('filtered-out');
        }
    });
}

// Show conflict resolution dialog
function showConflictResolution(storyId, storyName, conflictingPersonas) {
    const dialogHtml = `
        <div class="modal fade" id="conflictModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Resolve Mapping Conflict</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>"${storyName}"</strong> is currently mapped by multiple personas:</p>
                        <ul>
                            ${conflictingPersonas.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                        <p>What would you like to do?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="forceMapToCurrentPersona(${storyId})">
                            Move to My Persona
                        </button>
                        <button type="button" class="btn btn-primary" onclick="createDuplicateItem('${storyName}')">
                            Create Duplicate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(dialogHtml);
    $('#conflictModal').modal('show');
    
    // Clean up modal after hide
    $('#conflictModal').on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

// Force map item to current persona (removes from others)
function forceMapToCurrentPersona(storyId) {
    $.ajax({
        url: "{% url 'ajax_force_move_item' %}",
        type: 'POST',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            story_id: storyId,
            target_persona_id: {{ persona.id }},
            pro_id: {{ pro_id }},
            force_move: 'true'
        },
        success: function(response) {
            if (response.status === 'success') {
                $('#conflictModal').modal('hide');
                refreshMappedItems();
                showMessage('Item moved to your persona', 'success');
            } else {
                showMessage('Error: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            showMessage('Error moving item: ' + error, 'error');
        }
    });
}

// Create duplicate item for current persona
function createDuplicateItem(originalName) {
    const duplicateName = prompt(`Enter name for duplicate item:`, `${originalName} (Copy)`);
    
    if (!duplicateName) return;
    
    $.ajax({
        url: window.location.href,
        type: 'POST',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            detail: duplicateName,
            submit_detail: 'submit_detail',
            project_id: {{ pro_id }},
            persona_id: {{ persona.id }}
        },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.status === 'success') {
                $('#conflictModal').modal('hide');
                
                // Add new item to unmapped section
                const newItemHtml = `
                    <div class="backlog-item post-it draggable-backlog new-mapping" 
                         draggable="true" 
                         id="backlog-${response.backlog_id}"
                         ondblclick="makeEditable(this);" 
                         onblur="save_element_text(this, '${response.backlog_id}', 'app_organization', 'Backlog', 'name')"
                         style="background-color: #fff3cd; border-color: #ffeaa7;"
                         title="Duplicate item created">
                        ${response.backlog_name}
                        <small class="d-block text-muted" style="font-size: 0.6rem;">
                            New (Duplicate)
                        </small>
                    </div>
                `;
                
                $('#new-items-container').append(newItemHtml);
                showMessage('Duplicate item created', 'success');
                
                // Enable drag functionality
                const newElement = $(`#backlog-${response.backlog_id}`)[0];
                if (newElement) {
                    newElement.addEventListener('dragstart', function(event) {
                        event.dataTransfer.setData("text/plain", event.target.id);
                    });
                }
            } else {
                showMessage('Error creating duplicate: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            showMessage('Error creating duplicate: ' + error, 'error');
        }
    });
}

// Initialize on document ready
$(document).ready(function() {
    updateMappingStats();
    initializeMappedItemsInteractions();
    
    // Add keyboard shortcut for persona switcher
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'p') {
            event.preventDefault();
            $('#persona-switcher').focus();
        }
    });
});
</script>

<script>
    // Updated JavaScript Functions for Multi-Persona Story Mapping

// Switch to different persona
function switchPersona(personaId) {
    if (!personaId) return;
    
    // Show loading state
    showMessage('Switching to persona...', 'info');
    
    // Redirect to the selected persona's story map
    const currentUrl = window.location.pathname;
    const newUrl = currentUrl.replace(/persona_id\/\d+/, `persona_id/${personaId}`);
    window.location.href = newUrl;
}

// Enhanced refresh mapped items function
function refreshMappedItems() {
    $.ajax({
        url: "{% url 'ajax_refresh_mapped_items' %}",
        type: 'POST',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            pro_id: '{{ pro_id }}',
            persona_id: '{{ persona.id }}'
        },
        success: function(response) {
            if (response.status === 'success') {
                $('#mapped-items-section').html(response.html);
                
                // Update any counters or stats displays
                if (response.current_persona_count !== undefined) {
                    $('#your-items-count').text(response.current_persona_count);
                }
                if (response.conflicts_count !== undefined) {
                    $('#conflict-count').text(response.conflicts_count);
                }
                
                // Re-initialize interactions
                initializeMappedItemsInteractions();
                
                console.log(`Refreshed: ${response.count} total items, ${response.current_persona_count} yours, ${response.conflicts_count} conflicts`);
            } else {
                console.error('refreshMappedItems Error refreshing mapped items:', response.message);
                //showMessage('Error refreshing mapped items', 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('refreshMappedItems outerror Error refreshing mapped items:', error);
            //showMessage('Error refreshing mapped items', 'error');
        }
    });
}

// Unmap item from current persona
function unmapFromPersona(storyId, storyName) {
    if (!confirm(`Remove "${storyName}" from your persona mapping?`)) {
        return;
    }
    
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Use the existing ajax_update_backlog_release endpoint
    const payload = {
        project_id: {{ pro_id }},
        backlog_id: storyId,
        persona_id: {{ persona.id }},
        release_id: null // Remove release association
    };

    fetch("{% url 'ajax_update_backlog_release' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Server Error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            // Move from mapped to unmapped section
            moveFromMappedToUnmapped(storyId, storyName);
            showMessage('Item removed from your persona', 'success');
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        console.error('UNMAPFROMPERSONA: Error removing item:', error.message);
        //showMessage('Error removing item: ' + error.message, 'error');
    })
    .finally(() => {
        // Reset button state
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

// Move item from mapped to unmapped section
function moveFromMappedToUnmapped(storyId, storyName) {
    // Remove from mapped section with animation
    $(`#mapped-${storyId}`).fadeOut(300, function() {
        $(this).remove();
        
        // Add to unmapped section
        const newItemHtml = `
            <div class="backlog-item post-it draggable-backlog new-mapping" 
                 draggable="true" 
                 id="backlog-${storyId}"
                 ondblclick="makeEditable(this);" 
                 onblur="save_element_text(this, '${storyId}', 'app_organization', 'Backlog', 'name')"
                 title="Moved back from story map">
                ${storyName}
                <small class="d-block text-muted" style="font-size: 0.6rem;">
                    Available
                </small>
            </div>
        `;
        
        // Find or create unmapped container
        let container = $('#unmapped-items-container');
        if (container.length === 0) {
            const backlogDropZone = $('.backlog-drop-zone');
            const newContainer = $(`
                <div class="mb-3">
                    <small class="text-muted"><strong>Available Items:</strong></small>
                    <div id="unmapped-items-container"></div>
                </div>
            `);
            backlogDropZone.find('form').after(newContainer);
            container = $('#unmapped-items-container');
        }
        
        container.append(newItemHtml);
        
        // Enable drag functionality
        const newElement = $(`#backlog-${storyId}`)[0];
        if (newElement) {
            newElement.addEventListener('dragstart', function(event) {
                event.dataTransfer.setData("text/plain", event.target.id);
            });
        }
        
        // Refresh mapped items to update counts and conflicts
        refreshMappedItems();
        
        // Hide mapped section if no items left
        if ($('.mapped-item').length === 0) {
            $('#mapped-items-section').hide();
        }
    });
}

// Initialize interactions for mapped items
function initializeMappedItemsInteractions() {
    // Add click handlers for persona markers
    $('.persona-marker').off('click').on('click', function(e) {
        e.stopPropagation();
        const title = $(this).attr('title');
        const personaName = title ? title.split(' - ')[0] : 'Unknown';
        showMessage(`This item is mapped by: ${personaName}`, 'info');
    });
    
    // Add double-click to highlight conflicts
    $('.mapped-item[data-personas*=","]').off('dblclick').on('dblclick', function() {
        $(this).addClass('highlighted');
        setTimeout(() => {
            $(this).removeClass('highlighted');
        }, 2000);
        
        const personas = $(this).attr('data-personas').split(',');
        showMessage(`Conflict: Mapped by ${personas.join(', ')}`, 'warning');
    });
    
    // Add hover effects for better UX
    $('.mapped-item').off('mouseenter mouseleave').hover(
        function() {
            $(this).addClass('shadow-sm');
        },
        function() {
            $(this).removeClass('shadow-sm');
        }
    );
}

// Update mapping statistics
function updateMappingStats() {
    const totalMapped = $('.mapped-item').length;
    const yourItems = $('.mapped-item[data-is-current="true"]').length; 
    const conflicts = $('.mapped-item[data-personas*=","]').length;
    
    // Update stats display
    $('#your-items-count').text(yourItems);
    $('#conflict-count').text(conflicts);
    
    // Update conflict indicator color
    const conflictElement = $('#conflict-count');
    if (conflicts > 0) {
        conflictElement.removeClass('text-success').addClass('text-danger');
    } else {
        conflictElement.removeClass('text-danger').addClass('text-success');
    }
    
    console.log(`Stats updated: ${yourItems} your items, ${conflicts} conflicts out of ${totalMapped} total`);
}

// Enhanced drop function to handle multi-persona conflicts
function drop(event) {
    event.preventDefault();

    const draggedId = event.dataTransfer.getData("text/plain");
    const draggedElement = document.getElementById(draggedId);

    if (!draggedElement) {
        console.error('Dragged element not found.');
        return;
    }

    const backlogId = draggedId.split('-')[1];
    const storyName = draggedElement.textContent.trim();

    // Check if item is already mapped to other personas
    const existingMappedItem = $(`.mapped-item[data-story-id="${backlogId}"]`);
    if (existingMappedItem.length > 0) {
        const personas = existingMappedItem.attr('data-personas');
        if (personas && personas.includes(',')) {
            // Show conflict warning
            const conflictPersonas = personas.split(',');
            if (!confirm(`Warning: "${storyName}" is already mapped by ${conflictPersonas.join(', ')}. Continue mapping to your persona?`)) {
                return;
            }
        }
    }

    // Get the drop zone's data attributes
    const dropZone = event.target.closest('.release-drop-zone');
    const releaseId = dropZone.getAttribute('data-release-id');
    const iterationId = dropZone.getAttribute('data-iteration-id');
    const activityId = dropZone.getAttribute('data-activity-id');
    const stepId = dropZone.getAttribute('data-step-id');

    // Visual feedback
    dropZone.classList.add('dropped');

    // Prepare the AJAX payload
    const payload = {
        project_id: {{ pro_id }},
        story_id: backlogId,
        release_id: releaseId,
        iteration_id: iterationId,
        activity_id: activityId,
        step_id: stepId,
        persona_id: {{ persona.id }},
    };

    // Send the AJAX request
    fetch("{% url 'ajax_recieve_story_mapped_details' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(payload),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Server Error');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            // Move the dragged element to the drop zone
            const clonedElement = draggedElement.cloneNode(true);
            clonedElement.classList.remove('backlog-item');
            clonedElement.classList.add('step-item', 'card');
            dropZone.appendChild(clonedElement);
            
            // Remove from source container
            draggedElement.remove();
            
            // Refresh mapped items to show updated mapping
            refreshMappedItems();
            
            showMessage(`"${storyName.split('\n')[0]}" mapped successfully`, 'success');
            console.log('Backlog item successfully assigned to the release.');
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        console.error('Error updating story location:', error.message);
        showMessage('Error mapping item: ' + error.message, 'error');
    })
    .finally(() => {
        dropZone.classList.remove('dropped');
    });
}

// Initialize on document ready
$(document).ready(function() {
    // Initialize interactions
    initializeMappedItemsInteractions();
    updateMappingStats();
    
    // Add keyboard shortcut for persona switcher
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'p') {
            event.preventDefault();
            $('#persona-switcher').focus();
        }
    });
    
    // Auto-update mapped items every 30 seconds to catch changes from other users
    setInterval(function() {
        refreshMappedItems();
    }, 30000);
    
    console.log('Multi-persona story mapping initialized');
});



function switchPersona(personaId) {
    if (!personaId) return;
    
    // Simple redirect to switch persona
    const currentUrl = window.location.pathname;
    const newUrl = currentUrl.replace(/persona_id\/\d+/, `persona_id/${personaId}`);
    window.location.href = newUrl;
}
</script>
{% endblock content %}
