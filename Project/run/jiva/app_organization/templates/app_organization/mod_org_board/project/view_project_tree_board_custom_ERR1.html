{% extends 'app_common/common_files/base_template.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load app_web_my_filters %}
{% load markdown_extras %}
{% load mptt_tags %}
{% block content %}
<style>
    
    /* Main Kanban Board Layout */
.kanban-board {
    display: flex;
    gap: 15px;
    overflow-x: auto; /* Enable horizontal scrolling */
    overflow-y: hidden; /* Disable vertical scrolling of the board */
    padding: 10px 0;
    height: 75vh; /* Use viewport height for responsive sizing */
    align-items: flex-start;
    width: 100%;
    margin-bottom: 20px;
    /* Better scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: #007bff #f1f5f8;
}

/* Ensure container doesn't create its own scrollbars */
.contentbar, .content-wrapper, .container-fluid {
    overflow: hidden !important; /* Prevent scrollbars on containers */
}

/* Make sure body doesn't create extra scrollbars */
body, html {
    overflow-x: hidden; /* Prevent body horizontal scrollbar */
}

/* Column Styling with Viewport-based Height */
.kanban-column {
    background: #f1f5f8;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 5vw; /* Reduced width */
    min-width: 1vw;
    height: 70vh; /* Use viewport height for responsive sizing */
    display: flex;
    flex-direction: column;
    box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.1);
    overflow-y: auto; /* Enable vertical scrolling within columns */
    padding: 5px;
    flex-shrink: 0; /* Prevent columns from shrinking */
}

/* Buffer column is wider */
.kanban-column.buffer-column {
    /* Width is controlled by column_header1 class below */
}

.column_title {
    display: flex;
    align-items: center;     /* Vertically center content */
    justify-content: center; /* Horizontally center content */
    height: 30px;            /* Fixed height for consistency */
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
}

.column_title h4 {
    margin: 0;               /* Remove default margin */
    font-size: 0.85rem;
    color: #333;
    font-weight: bold;
}

/* Swimlane Container - Takes remaining height after header */
.kanban-swimlane {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    height: calc(100% - 30px); /* Adjusted for header height */
    overflow-y: auto;
    padding: 5px 0;
}

/* Card Styling with responsive heights */
.kanban-card {
    background: #f0efed;
    border-radius: 6px;
    padding: 3px;
    border: 1px solid #e0e0e0;
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
    font-size: 0.55rem;
    display: flex;
    flex-direction: column;
    min-height: 6vh; /* Responsive minimum height */
    max-width: 10vw;
    text-overflow: ellipsis;
    overflow: hidden;
    word-wrap: break-word;
    margin-bottom: 5px;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-3px);
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
}

/* Card Header with Priority and ID */
.kanban-card-header {
    font-size: 0.5rem;
    color: #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.kanban-card .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.50rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

/* Priority colors */
.priority-High { background-color: #ff5252; }
.priority-Critical { background-color: #e91e63; }
.priority-Medium { background-color: #ff9800; }
.priority-Low { background-color: #b1ce11; }
.priority-Normal { background-color: #e00ecf; }
.priority-none { background-color: #9e9e9e; }
.priority-high { background-color: #ff5252; }
.priority-critical { background-color: #e91e63; }
.priority-medium { background-color: #ff9800; }
.priority-low { background-color: #4caf50; }

/* Card Content */
.kanban-card h5 {
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
    margin: 5px 0;
}

.kanban-card p {
    font-size: 0.7rem;
    color: #555;
    margin: 0;
    line-height: 1;
}

.kanban-card-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: auto; /* Push to bottom of card */
    font-size: 0.65rem;
}

/* Buffer Column Layout */
.kanban-buffer {
    display: flex;
    flex-direction: row;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f8f9fa;
    padding: 5px;
    width: 100%;
    gap: 5px;
    height: 100%; /* Take full height of parent */
}

.kanban-subcolumn {
    width: 100%;
    height: 100%; /* Take full height of parent */
    padding: 5px;
    background: #fdfdfd;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* Allow scrolling within subcolumn */
}

.kanban-subcolumn.doing {
    border: 2px dashed #ff9800;
    background-color: #fff8e1;
}

.kanban-subcolumn.done {
    border: 2px dashed #4caf50;
    background-color: #e8f5e9;
}

/* Card Status Colors */
.kanban-card { background-color: #dcdcdc; color: #333 !important; }
.kanban-card.todo { background-color: #bbdefb; color: #0d47a1 !important; }
.kanban-card.in-progress, .kanban-card.WIP, .kanban-card.wip { 
    background-color: #fff59d; 
    color: #f57f17 !important; 
}
.kanban-card.blocked { background-color: lightcoral; color: #ffffff !important; }
.kanban-card.done { background-color: #81c784; color: #1b5e20 !important; }

/* Placeholder for dragging */
.kanban-card-placeholder {
    background: #f0f0f0;
    border: 1px dashed #aaa;
    height: 50px; 
    border-radius: 6px;
    margin: 5px 0;
    width: 100%;
}

/* WIP Limit Visual Indicator */
@keyframes blinkBorder {
    0% { border-color: red; }
    50% { border-color: transparent; }
    100% { border-color: red; }
}

.blink-border {
    border: 3px solid red;
    animation: blinkBorder 1s infinite;
}

/* Highlight for droppable targets */
.kanban-subcolumn.kanban-droppable-hover,
.kanban-column.kanban-droppable-hover {
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
}

/* Loading Spinner */
.spinner-border {
    border: 0.25em solid #f3f3f3;
    border-top: 0.25em solid #007bff;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Fixed navbar */
.navbar {
    margin: 0 !important;
    padding: 0 !important;
    height: 50px;
}

/* Custom Select for Swimlane filter */
.custom-select {
    appearance: none;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 6px 8px;
    padding-right: 25px;
    font-size: 14px;
    cursor: pointer;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .kanban-column {
        min-width: 150px;
    }
    .kanban-card {
        max-width: 100px;
        padding: 5px;
    }
    
    /* Adjust heights for smaller screens */
    .kanban-board {
        height: 85vh; /* Slightly taller on small screens to accommodate scrolling */
    }
}

/* WIP Limit Counter Styling */
.column_header1 {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0; /* Prevent shrinking */
}

.column_header1 > span {
    font-size: 0.7rem; /* Smaller font */
    text-align: center;
    margin-bottom: 3px;
    font-weight: bold;
}

/* Make sure columns stay aligned */
.column_header1 .kanban-column {
    width: 175px;
    min-width: 175px;
}

.column_header1 .kanban-column.buffer-column {
    width: 400px;
    min-width: 400px;
}

/* Ensure loading spinner doesn't affect layout */
#loading-spinner {
    position: fixed;
    z-index: 9999;
}

/* Add padding to the bottom of content area to ensure scrollbar is visible */
.container-fluid {
    padding-bottom: 15px;
}

/* WIP Limit Counter Styling - Enhanced */
.column_header1 {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0; /* Prevent shrinking */
}

.column_header1 > span {
    font-size: 0.7rem;
    text-align: center;
    margin-bottom: 3px;
    font-weight: bold;
    min-height: 20px; /* Ensure consistent spacing for all columns */
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* Styling for WIP counts in buffer column titles */
.kanban-subcolumn b {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 5px;
    margin-bottom: 5px;
    border-radius: 4px;
    background-color: rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s ease;
}

.kanban-subcolumn b .wip-count {
    font-size: 0.65rem;
    opacity: 0.9;
    padding: 0 5px;
    border-radius: 3px;
    background-color: rgba(0, 0, 0, 0.1);
    margin-left: 5px;
    transition: all 0.3s ease;
}

/* Styling for exceeded WIP count */
.kanban-subcolumn b .wip-count.exceeded {
    background-color: rgba(255, 0, 0, 0.2);
    color: #d00;
    font-weight: bold;
    box-shadow: 0 0 3px rgba(255, 0, 0, 0.3);
}

/* Buffer column exceeded styling */
.buffer-exceeded {
    background-color: rgba(255, 0, 0, 0.05) !important;
    border: 2px solid rgba(255, 0, 0, 0.3) !important;
}

/* Individual subcolumn exceeded styling */
.subcolumn-exceeded {
    border: 2px dashed rgba(255, 0, 0, 0.5) !important;
    background-color: rgba(255, 0, 0, 0.08) !important;
    box-shadow: inset 0 0 8px rgba(255, 0, 0, 0.1);
}

.subcolumn-exceeded b {
    background-color: rgba(255, 0, 0, 0.1);
    color: #900;
    font-weight: bold;
}

/* More prominent WIP limit visualization */
.blink-border {
    border: 3px solid red !important;
    animation: blinkBorder 1s infinite;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
}

@keyframes blinkBorder {
    0% { border-color: red !important; }
    50% { border-color: rgba(255, 0, 0, 0.3) !important; }
    100% { border-color: red !important; }
}
/* Base Kanban Table Layout - Applied to all themes */
.kanban-table-layout {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: minmax(175px, 1fr);
    width: 100%;
    height: 75vh;
    overflow-x: auto;
    gap: 0;
    border-collapse: collapse;
}

.kanban-table-layout .column_header1 {
    display: contents;
}

.kanban-table-layout .kanban-column {
    border-radius: 0;
    margin: 0;
    padding: 0;
    height: 100%;
    min-width: unset;
    width: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.kanban-table-layout .kanban-column.buffer-column {
    width: 100%;
    min-width: unset;
}

.kanban-table-layout .column_title {
    border-radius: 0;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    height: 40px;
    padding: 0;
    flex-shrink: 0;
}

.kanban-table-layout .column_title h4 {
    margin: 0;
    padding: 0;
}

.kanban-table-layout .wip-circle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
}

.kanban-table-layout .kanban-swimlane {
    padding: 5px;
    overflow-y: auto;
    height: calc(100% - 40px);
}

.kanban-table-layout .kanban-card {
    max-width: none;
    margin-bottom: 8px;
    border-radius: 4px;
}

.kanban-table-layout .kanban-buffer {
    height: 100%;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    padding: 0;
}

.kanban-table-layout .kanban-subcolumn {
    padding: 5px;
    overflow-y: auto;
    height: 100%;
}

.kanban-table-layout .kanban-card-placeholder {
    margin: 0 0 8px 0;
    border-radius: 4px;
    height: 60px;
}

/* Swimlane layout */
.vertical-swimlane-labels {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    grid-row: 1 / span 1;
    grid-column: 1 / span 1;
}

.vertical-swimlane-header {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    font-weight: bold;
}

.vertical-swimlane-container {
    display: flex;
    flex-grow: 1;
}

.vertical-swimlane-labels-container {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 40px;
    flex-shrink: 0;
}

.vertical-swimlane-label {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    text-align: center;
    padding: 5px 0;
    font-weight: bold;
    font-size: 11px;
    border-top: 1px solid var(--border-color);
}

.swimlanes-grid {
    display: grid;
    grid-template-columns: 40px repeat(auto-fit, minmax(175px, 1fr));
    width: 100%;
    overflow: hidden;
    height: 75vh;
}

.swimlanes-content {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: minmax(175px, 1fr);
    overflow-x: auto;
    grid-column: 2 / -1;
    grid-row: 1;
}

/* Theme 1: Professional Light */
.theme1 {
    --bg-color: #f8f9fa;
    --column-bg: #ffffff;
    --column-header-bg: #e9ecef;
    --card-bg: #ffffff;
    --text-color: #212529;
    --border-color: #dee2e6;
    --border-hover: #adb5bd;
    --priority-high: #dc3545;
    --priority-medium: #fd7e14;
    --priority-low: #198754;
    --priority-normal: #0d6efd;
    --todo-color: #e9f2ff;
    --todo-border: #90c5ff;
    --wip-color: #fff2e6;
    --wip-border: #ffcc99;
    --blocked-color: #ffe6e6;
    --blocked-border: #ff9999;
    --done-color: #e6fff0;
    --done-border: #99e6b3;
    --wip-exceeded: #dc3545;
    --wip-normal: #198754;
}

.theme1.kanban-table-layout {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
}

.theme1 .kanban-column {
    background-color: var(--column-bg);
    border-right: 1px solid var(--border-color);
}

.theme1 .column_title {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.theme1 .wip-circle {
    background-color: white;
    border: 1px solid var(--border-color);
    color: var(--wip-normal);
}

.theme1 .wip-exceeded {
    color: var(--wip-exceeded);
    font-weight: bold;
}

.theme1 .kanban-card {
    background-color: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}

.theme1 .kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-color: var(--border-hover);
}

.theme1 .kanban-card-header {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.theme1 .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.5rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

.theme1 .priority-High,
.theme1 .priority-Critical { background-color: var(--priority-high); }
.theme1 .priority-Medium { background-color: var(--priority-medium); }
.theme1 .priority-Low { background-color: var(--priority-low); }
.theme1 .priority-Normal { background-color: var(--priority-normal); }

.theme1 .kanban-buffer {
    background-color: var(--column-bg);
}

.theme1 .kanban-subcolumn {
    background-color: var(--bg-color);
}

.theme1 .kanban-subcolumn.doing {
    border-right: 2px dotted var(--priority-medium);
}

.theme1 .kanban-subcolumn b {
    display: block;
    padding: 3px 5px;
    font-size: 0.75rem;
    background-color: var(--column-header-bg);
    margin-bottom: 5px;
    border-radius: 3px;
    text-align: center;
}

.theme1 .kanban-card.todo { 
    background-color: var(--todo-color); 
    border-left: 3px solid var(--todo-border);
}
.theme1 .kanban-card.wip, 
.theme1 .kanban-card.WIP { 
    background-color: var(--wip-color); 
    border-left: 3px solid var(--wip-border);
}
.theme1 .kanban-card.blocked { 
    background-color: var(--blocked-color); 
    border-left: 3px solid var(--blocked-border);
}
.theme1 .kanban-card.done { 
    background-color: var(--done-color); 
    border-left: 3px solid var(--done-border);
}

.theme1 .blink-border {
    border: 2px solid var(--wip-exceeded) !important;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}

/* Vertical swimlane styling for Theme 1 */
.theme1 .vertical-swimlane-header {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.theme1 .vertical-swimlane-label {
    background-color: var(--bg-color);
    border-top: 1px solid var(--border-color);
    color: var(--text-color);
}

.theme1 .swimlane-expedite {
    background-color: rgba(220, 53, 69, 0.05);
}

.theme1 .swimlane-fixed {
    background-color: rgba(13, 110, 253, 0.05);
}

.theme1 .swimlane-standard {
    background-color: rgba(25, 135, 84, 0.05);
}

.theme1 .swimlane-intangible {
    background-color: rgba(108, 117, 125, 0.05);
}

/* Theme 2: Professional Dark */
.theme2 {
    --bg-color: #212529;
    --column-bg: #2b3035;
    --column-header-bg: #343a40;
    --card-bg: #2b3035;
    --text-color: #dee2e6;
    --border-color: #495057;
    --border-hover: #6c757d;
    --priority-high: #dc3545;
    --priority-medium: #fd7e14;
    --priority-low: #198754;
    --priority-normal: #0d6efd;
    --todo-color: #132a42;
    --todo-border: #0d6efd;
    --wip-color: #3a2a17;
    --wip-border: #fd7e14;
    --blocked-color: #3a1a1d;
    --blocked-border: #dc3545;
    --done-color: #132a17;
    --done-border: #198754;
    --wip-exceeded: #dc3545;
    --wip-normal: #198754;
}

.theme2.kanban-table-layout {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
}

.theme2 .kanban-column {
    background-color: var(--column-bg);
    border-right: 1px solid var(--border-color);
}

.theme2 .column_title {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.theme2 .column_title h4 {
    color: var(--text-color);
}

.theme2 .wip-circle {
    background-color: var(--column-bg);
    border: 1px solid var(--border-color);
    color: var(--wip-normal);
}

.theme2 .wip-exceeded {
    color: var(--wip-exceeded);
    font-weight: bold;
}

.theme2 .kanban-card {
    background-color: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
}

.theme2 .kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    border-color: var(--border-hover);
}

.theme2 .kanban-card-header {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.theme2 .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.5rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

.theme2 .priority-High,
.theme2 .priority-Critical { background-color: var(--priority-high); }
.theme2 .priority-Medium { background-color: var(--priority-medium); }
.theme2 .priority-Low { background-color: var(--priority-low); }
.theme2 .priority-Normal { background-color: var(--priority-normal); }

.theme2 .kanban-buffer {
    background-color: var(--column-bg);
}

.theme2 .kanban-subcolumn {
    background-color: var(--bg-color);
}

.theme2 .kanban-subcolumn.doing {
    border-right: 2px dotted var(--priority-medium);
}

.theme2 .kanban-subcolumn b {
    display: block;
    padding: 3px 5px;
    font-size: 0.75rem;
    background-color: var(--column-header-bg);
    margin-bottom: 5px;
    border-radius: 3px;
    text-align: center;
    color: var(--text-color);
}

.theme2 .kanban-card.todo { 
    background-color: var(--todo-color); 
    border-left: 3px solid var(--todo-border);
    color: #dee2e6 !important;
}
.theme2 .kanban-card.wip, 
.theme2 .kanban-card.WIP { 
    background-color: var(--wip-color); 
    border-left: 3px solid var(--wip-border);
    color: #dee2e6 !important;
}
.theme2 .kanban-card.blocked { 
    background-color: var(--blocked-color); 
    border-left: 3px solid var(--blocked-border);
    color: #dee2e6 !important;
}
.theme2 .kanban-card.done { 
    background-color: var(--done-color); 
    border-left: 3px solid var(--done-border);
    color: #dee2e6 !important;
}

.theme2 .blink-border {
    border: 2px solid var(--wip-exceeded) !important;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}

.theme2 a {
    color: #6ea8fe;
}

/* Vertical swimlane styling for Theme 2 */
.theme2 .vertical-swimlane-header {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.theme2 .vertical-swimlane-label {
    background-color: var(--bg-color);
    border-top: 1px solid var(--border-color);
    color: var(--text-color);
}

.theme2 .swimlane-expedite {
    background-color: rgba(220, 53, 69, 0.1);
}

.theme2 .swimlane-fixed {
    background-color: rgba(13, 110, 253, 0.1);
}

.theme2 .swimlane-standard {
    background-color: rgba(25, 135, 84, 0.1);
}

.theme2 .swimlane-intangible {
    background-color: rgba(108, 117, 125, 0.1);
}

/* Theme 3: Handwritten / Natural */
.theme3 {
    --bg-color: #fffaf0;
    --column-bg: #fffef7;
    --column-header-bg: #fffef7;
    --card-bg: #fffef7;
    --text-color: #5d4037;
    --border-color: #bcaaa4;
    --border-hover: #8d6e63;
    --priority-high: #ef9a9a;
    --priority-medium: #ffcc80;
    --priority-low: #a5d6a7;
    --priority-normal: #90caf9;
    --todo-color: #e3f2fd;
    --todo-border: #bbdefb;
    --wip-color: #fff8e1;
    --wip-border: #ffe082;
    --blocked-color: #ffebee;
    --blocked-border: #ffcdd2;
    --done-color: #e8f5e9;
    --done-border: #c8e6c9;
    --wip-exceeded: #c62828;
    --wip-normal: #2e7d32;
    --handwritten-font: 'Kalam', 'Comic Sans MS', cursive;
}

.theme3 {
    font-family: var(--handwritten-font);
}

.theme3.kanban-table-layout {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    background-image: 
        repeating-linear-gradient(
            var(--bg-color) 0px, 
            var(--bg-color) 24px, 
            #e5e5dd 25px
        );
}

.theme3 .kanban-column {
    background-color: transparent;
    border-right: 1px dashed var(--border-color);
}

.theme3 .column_title {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px dashed var(--border-color);
}

.theme3 .column_title h4 {
    font-family: var(--handwritten-font);
    font-weight: 400;
    font-size: 1.1rem;
}

.theme3 .wip-circle {
    background-color: transparent;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    color: var(--text-color);
    font-family: var(--handwritten-font);
}

.theme3 .wip-exceeded {
    color: var(--wip-exceeded);
    border-color: var(--wip-exceeded);
}

.theme3 .kanban-card {
    background-color: var(--card-bg);
    color: var(--text-color);
    border: none;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    font-family: var(--handwritten-font);
    position: relative;
    transform: rotate(-0.5deg);
}

.theme3 .kanban-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        repeating-linear-gradient(
            transparent, 
            transparent 18px, 
            rgba(0,0,0,0.05) 18px, 
            rgba(0,0,0,0.05) 19px
        );
    z-index: -1;
    opacity: 0.7;
}

.theme3 .kanban-card:nth-child(odd) {
    transform: rotate(0.7deg);
}

.theme3 .kanban-card:hover {
    transform: translateY(-2px) rotate(-0.5deg);
    box-shadow: 3px 3px 7px rgba(0,0,0,0.15);
}

.theme3 .kanban-card:nth-child(odd):hover {
    transform: translateY(-2px) rotate(0.7deg);
}

.theme3 .kanban-card-header {
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.theme3 .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.5rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: var(--text-color);
    border: 1px solid var(--text-color);
}

.theme3 .priority-High,
.theme3 .priority-Critical { background-color: var(--priority-high); }
.theme3 .priority-Medium { background-color: var(--priority-medium); }
.theme3 .priority-Low { background-color: var(--priority-low); }
.theme3 .priority-Normal { background-color: var(--priority-normal); }

.theme3 .kanban-buffer {
    background-color: transparent;
}

.theme3 .kanban-subcolumn {
    background-color: transparent;
}

.theme3 .kanban-subcolumn.doing {
    border-right: 2px dashed var(--border-color);
}

.theme3 .kanban-subcolumn b {
    display: block;
    padding: 3px 5px;
    font-size: 0.85rem;
    border-bottom: 1px dashed var(--border-color);
    margin-bottom: 5px;
    text-align: center;
    font-weight: normal;
    font-family: var(--handwritten-font);
}

.theme3 .kanban-card.todo { 
    background-color: var(--todo-color); 
}
.theme3 .kanban-card.wip, 
.theme3 .kanban-card.WIP { 
    background-color: var(--wip-color); 
}
.theme3 .kanban-card.blocked { 
    background-color: var(--blocked-color); 
}
.theme3 .kanban-card.done { 
    background-color: var(--done-color); 
}

.theme3 .blink-border {
    border: 2px dashed var(--wip-exceeded) !important;
    box-shadow: 0 0 5px rgba(198, 40, 40, 0.3);
}

.theme3 a {
    color: #795548;
    text-decoration: underline;
}

/* Vertical swimlane styling for Theme 3 */
.theme3 .vertical-swimlane-header {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px dashed var(--border-color);
    font-family: var(--handwritten-font);
}

.theme3 .vertical-swimlane-label {
    background-color: transparent;
    border-top: 1px dashed var(--border-color);
    color: var(--text-color);
    font-family: var(--handwritten-font);
}

.theme3 .swimlane-expedite {
    background-color: rgba(239, 154, 154, 0.2);
}

.theme3 .swimlane-fixed {
    background-color: rgba(144, 202, 249, 0.2);
}

.theme3 .swimlane-standard {
    background-color: rgba(165, 214, 167, 0.2);
}

.theme3 .swimlane-intangible {
    background-color: rgba(188, 170, 164, 0.1);
}

/* Theme 4: Swimlanes */
.theme4 {
    --bg-color: #f8f9fa;
    --column-bg: #ffffff;
    --column-header-bg: #e9ecef;
    --card-bg: #ffffff;
    --text-color: #212529;
    --border-color: #dee2e6;
    --border-hover: #adb5bd;
    --swimlane-border: #dee2e6;
    --swimlane-heading: #6c757d;
    --swimlane-general: #f8f9fa;
    --swimlane-expedite: #fff3f3;
    --swimlane-fixed: #f0f5ff;
    --swimlane-standard: #f0fff4;
    --swimlane-intangible: #faf6ff;
    --expedite-color: #dc3545;
    --fixed-color: #0d6efd;
    --standard-color: #198754;
    --intangible-color: #6f42c1;
    --todo-border: #0d6efd;
    --wip-border: #fd7e14;
    --blocked-border: #dc3545;
    --done-border: #198754;
    --wip-exceeded: #dc3545;
    --wip-normal: #198754;
}

.theme4.kanban-table-layout {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
}

.theme4 .kanban-column {
    background-color: var(--column-bg);
    border-right: 1px solid var(--border-color);
}

.theme4 .column_title {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.theme4 .wip-circle {
    background-color: white;
    border: 1px solid var(--border-color);
    color: var(--wip-normal);
}

.theme4 .wip-exceeded {
    color: var(--wip-exceeded);
    font-weight: bold;
}

.theme4 .kanban-card {
    background-color: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    margin-bottom: 5px;
}

.theme4 .kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
    border-color: var(--border-hover);
}

.theme4 .kanban-card-header {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.theme4 .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.5rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

.theme4 .priority-High,
.theme4 .priority-Critical { background-color: var(--expedite-color); }
.theme4 .priority-Medium { background-color: var(--standard-color); }
.theme4 .priority-Low { background-color: var(--intangible-color); }
.theme4 .priority-Normal { background-color: var(--fixed-color); }

.theme4 .kanban-buffer {
    background-color: var(--column-bg);
}

.theme4 .kanban-subcolumn {
    background-color: var(--bg-color);
}

.theme4 .kanban-subcolumn.doing {
    border-right: 2px dotted var(--wip-border);
}

.theme4 .kanban-subcolumn b {
    display: block;
    padding: 3px 5px;
    font-size: 0.75rem;
    background-color: var(--column-header-bg);
    margin-bottom: 5px;
    border-radius: 3px;
    text-align: center;
}

.theme4 .kanban-card.todo { 
    border-left: 3px solid var(--todo-border);
}
.theme4 .kanban-card.wip, 
.theme4 .kanban-card.WIP { 
    border-left: 3px solid var(--wip-border);
}
.theme4 .kanban-card.blocked { 
    border-left: 3px solid var(--blocked-border);
}
.theme4 .kanban-card.done { 
    border-left: 3px solid var(--done-border);
}

.theme4 .blink-border {
    border: 2px solid var(--wip-exceeded) !important;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
}

/* Vertical swimlane styling for Theme 4 */
.theme4 .vertical-swimlane-labels {
    border-right: 1px solid var(--border-color);
}

.theme4 .vertical-swimlane-header {
    background-color: var(--column-header-bg);
    color: var(--text-color);
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
}

.theme4 .vertical-swimlane-label {
    background-color: var(--bg-color);
    border-top: 1px solid var(--border-color);
    color: var(--text-color);
    font-weight: bold;
}

.theme4 .vertical-swimlane-label.swimlane-general {
    color: var(--swimlane-heading);
}

.theme4 .vertical-swimlane-label.swimlane-expedite {
    color: var(--expedite-color);
}

.theme4 .vertical-swimlane-label.swimlane-fixed {
    color: var(--fixed-color);
}

.theme4 .vertical-swimlane-label.swimlane-standard {
    color: var(--standard-color);
}

.theme4 .vertical-swimlane-label.swimlane-intangible {
    color: var(--intangible-color);
}

.theme4 .swimlane-general {
    background-color: var(--swimlane-general);
}

.theme4 .swimlane-expedite {
    background-color: var(--swimlane-expedite);
    border-top: 3px solid var(--expedite-color);
}

.theme4 .swimlane-fixed {
    background-color: var(--swimlane-fixed);
    border-top: 3px solid var(--fixed-color);
}

.theme4 .swimlane-standard {
    background-color: var(--swimlane-standard);
    border-top: 3px solid var(--standard-color);
}

.theme4 .swimlane-intangible {
    background-color: var(--swimlane-intangible);
    border-top: 3px solid var(--intangible-color);
}

/* Theme switcher */
.theme-switcher {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.theme-button {
    padding: 6px 15px;
    border: 1px solid #ced4da;
    background: #fff;
    cursor: pointer;
    border-radius: 4px;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s;
}

.theme-button:hover {
    background: #e9ecef;
}

.theme-button.active {
    background: #0d6efd;
    color: white;
    border-color: #0a58ca;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .kanban-table-layout {
        grid-auto-columns: minmax(150px, 1fr);
    }
    
    .theme1 .column_title h4,
    .theme2 .column_title h4,
    .theme4 .column_title h4 {
        font-size: 0.8rem;
    }
    
    .theme3 .column_title h4 {
        font-size: 0.9rem;
    }
    
    .vertical-swimlane-labels-container {
        width: 30px;
    }
    
    .vertical-swimlane-label {
        font-size: 9px;
    }
    
    .swimlanes-grid {
        grid-template-columns: 30px repeat(auto-fit, minmax(150px, 1fr));
    }
}

@media (max-width: 576px) {
    .theme-switcher {
        flex-wrap: wrap;
    }
    
    .theme-button {
        flex: 1 1 40%;
    }
}

/* WIP Count specific styles */
.wip-count {
    font-size: 0.7rem;
    background-color: rgba(0, 0, 0, 0.05);
    padding: 1px 4px;
    border-radius: 3px;
    margin-left: 5px;
}

.wip-count.exceeded {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    font-weight: bold;
}

/* Buffer column styles */
.buffer-exceeded {
    background-color: rgba(220, 53, 69, 0.05) !important;
}

.subcolumn-exceeded {
    background-color: rgba(220, 53, 69, 0.05) !important;
    border-color: rgba(220, 53, 69, 0.3) !important;
}

/* Additional theme-specific buffer column adjustments */
.theme1 .kanban-buffer, .theme2 .kanban-buffer {
    padding: 0;
    gap: 0;
}

.theme3 .kanban-buffer {
    padding: 0;
    gap: 0;
    background-color: transparent;
}

.theme4 .kanban-buffer {
    padding: 0;
    gap: 0;
}

/* Improved drag and drop styling */
.kanban-droppable-hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

.theme1 .kanban-droppable-hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
    border: 2px dashed rgba(13, 110, 253, 0.3) !important;
}

.theme2 .kanban-droppable-hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
    border: 2px dashed rgba(110, 168, 254, 0.3) !important;
}

.theme3 .kanban-droppable-hover {
    background-color: rgba(121, 85, 72, 0.05) !important;
    border: 2px dashed rgba(121, 85, 72, 0.3) !important;
}

.theme4 .kanban-droppable-hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
    border: 2px dashed rgba(13, 110, 253, 0.3) !important;
}

/* Cleaner loading spinner */
#loading-spinner {
    background: rgba(255, 255, 255, 0.8);
}

.theme2 #loading-spinner {
    background: rgba(33, 37, 41, 0.8);
}

.theme2 .spinner-border {
    border-color: rgba(222, 226, 230, 0.25);
    border-right-color: #dee2e6;
}
</style>
<!--
1. This is default or when get_swimlane_id is -1 where we need to display 
Project Iteration Board
-->

{% if project_iteration_flag == True %}

<div class="content-wrapper">


    <div class="contentbar mb-5" id="contentbar">
        {% if project.project_details.template.name == 'Kanban' %}
        <div class="container-fluid mb-1">
            <div class="row">
                <div class="col col-md-6">
                    <b class="me-2">Project: </b>
                    {{project}} 
                    <b class="mb-2 me-2">Release: </b>
                    {{project.project_release}}
                    <b class="mb-2 me-2">Iteration: </b>
                    {{current_iteration}}
                <b class="mb-2 me-2">Project Board: </b>
                    {{project_board}}
                    
                </div>

                <div class="col col-md-6 text-end">
                    {% if page == 'custom' %}
                    <a href="{% url 'view_project_tree_board_smart_kanban' project.id %}" class="me-2">SMART</a>
                    <b>Custom</b>
                    {% else %}
                    <b>SMART</b>
                    <a href="{% url 'view_project_tree_board_custom' project.id %}" class="me-2">Custom</a>
                    
                    {% endif %}
                    
                    
                     <a href="{% url 'list_project_boards' project.id %}" class="btn btn-sm btn-primary me-2">Board</a>
                     <a href="{% url 'board_card_settings' project_board.id %}" class="btn btn-sm btn-success me-2">Card</a>
                    <select id="parentFilter" class="custom-select">
                        <option value="">-- Select SwimLane --</option>
                        <option value="0">-- All SwimLanes --</option>
                        <option value="-1" selected>-- Project Iteration --</option>
                        {% for efcc in efcc_backlog_items %}
                            <option value="{{ efcc.id }}">{{ efcc }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="container-fluid">
            <div class="d-flex justify-content-end align-items-center">
                <div class="display_topic"></div>
                <div class="view_options"></div>
                <div class="dropdown"></div>
                <div class="menu"></div>
            </div>
            
            <!-- Board-->
            <div id="kanban-board" data-board-id="{{ project_board.id }}" class="kanban-board mb-5">
                <!-- Backlog Column -->
                <div class="column_header1">
                    <span style="color: red;" id="card-count-0">∞</span>                    
                    <div class="kanban-column" data-id="0" id="backlog"
                    data-apply-wip-limit="false"
                    >
                        <div class="column_title"><h4>Backlog</h4></div>
                        <div class="kanban-swimlane">
                        {% for item in backlog_items %}
                            <div class="kanban-card" data-id="{{ item.id }}">
                                <div class="kanban-card-header">
                                    <span class="priority priority-{{item.priority}}">{{item.priority|get_first_letter_caps}}</span>
                                    <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.id %}?back_to=view_project_tree_board&project_id={{project.id}}">#{{item.id}}</a> {{item.iteration| display_if_not_none }}</span>
                                </div>
                                <b>{{ item }}</b>
                                <p>{{ item.description | display_if_not_none }}</p>
                                <div class="kanban-card-footer">
                                    <div class="parent"></div>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                </div>
                {% for state in project_board_states %}
                <div class="column_header1">
                    {% if state.apply_wip_limit %}                            
                    <span id="card-count-{{ state.id }}" style="color: green;">0</span>
                    {% else %}
                    <span id="card-count-{{ state.id }}" style="color: red;">∞</span>  
                    {% endif %}  
                    
                <!-- Kanban Column -->
                <div class="kanban-column {% if state.buffer_column %}buffer-column{% endif %}" data-id="{{ state.id }}" id="column-{{ state.name }}" 
                        data-column-type="{{ state.column_type }}" data-wip-limit="{{ state.wip_limit }}" 
                        data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                        <!-- Column Header with Dynamic Card Count -->                        
                        <div class="column_title"><h4>{{ state.name }}</h4></div>
                    <!-- Split column if buffer_column=True -->
                    {% if state.buffer_column %}
                        <div class="kanban-buffer">
                            {% with subcolumns=state.get_subcolumns %}
                            {% for substate_choice in subcolumns %}
                                <div class="kanban-subcolumn {{ substate_choice|lower|slugify }}"
                                     data-id="{{ state.id }}"
                                     id="{{ substate_choice|lower|slugify }}-{{ state.id }}"
                                     data-substate="{{ substate_choice }}"
                                     data-buffer-subcolumn-wip-limit="2">
                                     
                                    <b>{{ state.name }}: {{ substate_choice }}</b>
                        
                                    {% for item in state_items|get_item:state.id %}
                                        {% if item.backlog.iteration.id == current_iteration.id and item.substate == substate_choice %}
                                            <!-- Card HTML here -->
                                            <div class="kanban-card {{ state.column_type|lower }}" style="color: white;" data-id="{{ item.id }}">
                                                <div class="kanban-card-header">
                                                    <span class="priority priority-{{ item.backlog.priority }}">{{ item.backlog.priority|get_first_letter_caps }}</span>
                                                    <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.backlog.id %}?back_to=view_project_tree_board&project_id={{ project.id }}">
                                                        #{{ item.backlog.id }}</a> {{ item.backlog.iteration }}</span>
                                                </div>
                                                <b>{{ item }}</b>
                                                <p>{{ item.description | display_if_not_none }}
                                                   
                                                </p>
                                                <div class="kanban-card-footer">
                                                    <div class="parent"></div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                        
                                </div>
                            {% endfor %}
                        {% endwith %}
                        

                           
                        </div>
                    {% else %}
                        <div class="kanban-swimlane">
                        {% for item in state_items|get_item:state.id %}
                            {% if item.backlog.iteration.id == current_iteration.id %}
                                <div class="kanban-card {{ state.column_type|lower }}" style="color: white;" data-id="{{ item.id }}">
                                    <div class="kanban-card-header">
                                        <span class="priority priority-{{ item.backlog.priority }}">{{ item.backlog.priority|get_first_letter_caps }}</span>
                                        <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.backlog.id %}?back_to=view_project_tree_board&project_id={{ project.id }}">#{{ item.backlog.id }}</a> {{ item.backlog.iteration }}</span>
                                    </div>
                                    <b>{{ item }}</b>
                                    <p>{{ item.description | display_if_not_none }}</p>
                                    <div class="kanban-card-footer">
                                        <div class="parent"></div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    {% endif %}
                </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


{% endif %}
<div id="loading-spinner" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
 // Enhanced WIP Count function with dynamic substates
function updateWIPCounts() {
    document.querySelectorAll(".kanban-column").forEach(column => {
        let stateId = column.getAttribute("data-id");
        let wipLimit = parseInt(column.getAttribute("data-wip-limit"), 10);
        let applyWipLimit = column.getAttribute("data-apply-wip-limit") === "true";
        let isBufferColumn = column.classList.contains("buffer-column");
        
        // Set default WIP limit of 2 for buffer columns if not already set
        if (isBufferColumn && (!wipLimit || isNaN(wipLimit))) {
            wipLimit = 2;
            column.setAttribute("data-wip-limit", "2");
            column.setAttribute("data-apply-wip-limit", "true");
            applyWipLimit = true;
        }
        
        // Count cards differently for regular vs buffer columns
        let cardCount = 0;
        
        if (isBufferColumn) {
            // Get all subcolumns (now we might have more than just Doing and Done)
            const subcolumns = column.querySelectorAll(".kanban-subcolumn");
            let subcolumnCounts = {};
            let totalCount = 0;
            
            // Count cards in each subcolumn
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const count = subcolumn.querySelectorAll(".kanban-card").length;
                subcolumnCounts[substate] = count;
                totalCount += count;
            });
            
            cardCount = totalCount;
            
            // Update top column count display with just the total
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Display Total: count/wipLimit or Total: count/∞ if no WIP limit
                const limitDisplay = applyWipLimit ? wipLimit : "∞";
                countElement.innerHTML = `<span>Total: ${cardCount}/${limitDisplay}</span>`;
                countElement.style.color = (!applyWipLimit || cardCount <= wipLimit) ? "green" : "red";
            }
            
            // Update each subcolumn title with its count
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const wip_limit_attr = subcolumn.getAttribute("data-buffer-subcolumn-wip-limit");
                const subWipLimit = wip_limit_attr ? parseInt(wip_limit_attr) : 2;
                const count = subcolumnCounts[substate];
                
                // Set the WIP limit attribute if not already set
                if (!wip_limit_attr) {
                    subcolumn.setAttribute("data-buffer-subcolumn-wip-limit", subWipLimit);
                }
                
                // Update the title
                const title = subcolumn.querySelector("b");
                if (title) {
                    const columnName = title.textContent.split(":")[0];
                    title.innerHTML = `${columnName}: ${substate} <span class="wip-count ${count > subWipLimit ? 'exceeded' : ''}">${count}/${subWipLimit}</span>`;
                }
                
                // Highlight subcolumn if count exceeds limit
                if (count > subWipLimit) {
                    subcolumn.classList.add("subcolumn-exceeded");
                } else {
                    subcolumn.classList.remove("subcolumn-exceeded");
                }
            });
            
            // Highlight whole column if total exceeds limit
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
                column.querySelector(".kanban-buffer").classList.add("buffer-exceeded");
            } else {
                column.classList.remove("blink-border");
                column.querySelector(".kanban-buffer").classList.remove("buffer-exceeded");
            }
            
        } else {
            // For regular columns, just count all cards
            cardCount = column.querySelectorAll(".kanban-card").length;
            
            // Update the count display
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Check if WIP limit is applied and format accordingly (count/wipLimit or count/∞)
                if (applyWipLimit) {
                    countElement.innerText = `${cardCount}/${wipLimit}`;
                    countElement.style.color = (cardCount <= wipLimit) ? "green" : "red";
                } else {
                    countElement.innerHTML = `${cardCount}/∞`;
                    countElement.style.color = "green"; // Always green for unlimited columns
                }
            }
            
            // Add blinking border if WIP limit is exceeded
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
            } else {
                column.classList.remove("blink-border");
            }
        }
    });
}

// Run when page loads
window.addEventListener("load", updateWIPCounts);

// Also run after any drag-and-drop operations
$(document).on("sortreceive sortstop", function() {
    setTimeout(updateWIPCounts, 100);
});
</script>

<script>
    document.getElementById('parentFilter').addEventListener('change', function () {
        let selectedValue = this.value;
        let url = new URL(window.location.href);

        if (url.searchParams.has('swimlane_id')) {
            url.searchParams.set('swimlane_id', selectedValue);
        } else {
            url.searchParams.append('swimlane_id', selectedValue);
        }

        window.location.href = url.toString();
    });
</script>

<script>
    const columnColorMapping = {
        "Backlog": "kanban-card",
        "ToDo": "kanban-card todo",
        "In Progress": "kanban-card WIP",
        "WIP": "kanban-card WIP",
        "Blocked": "kanban-card blocked",
        "Done": "kanban-card done"
    };
</script>

<script>
   $(function() {
    $(".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn").sortable({
        connectWith: ".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn",
        placeholder: "kanban-card-placeholder",
        tolerance: 'pointer',
        scroll: true,
        scrollSensitivity: 100,
        scrollSpeed: 10,
        appendTo: "body",
        helper: "clone",
        forcePlaceholderSize: true,
        items: ".kanban-card",
        cancel: ".non-draggable",
        over: function(event, ui) {
            $(this).addClass("kanban-droppable-hover");
        },
        out: function(event, ui) {
            $(this).removeClass("kanban-droppable-hover");
        },
        
        start: function(event, ui) {
            var fromColumn;
            if (ui.item.closest(".kanban-subcolumn").length) {
                fromColumn = ui.item.closest(".kanban-subcolumn").closest(".kanban-column");
            } else {
                fromColumn = ui.item.closest(".kanban-column");
            }
            ui.item.data("start-state", fromColumn.data("id"));
            ui.item.data("from-column", fromColumn.find("h4").text().trim());
            
            // Make item visible during drag
            ui.helper.css('z-index', 1000);
        },

        stop: function(event, ui) {
            var projectId = {{ project.id }};
            var cardId = ui.item.data("id");
            var boardId = {{ project_board.id }};
            var fromStateId = ui.item.data("start-state");
            var fromColumn = ui.item.data("from-column");

            var toColumn = ui.item.closest(".kanban-subcolumn, .kanban-column");
            var toStateId = toColumn.data("id");
            var subState = toColumn.attr("data-substate");
            var destColumn = toColumn.attr("id").replace("column-", "").trim().toLowerCase();
            var columnType = toColumn.closest(".kanban-column").data("column-type");
            
            var destPositions = [];
            toColumn.find(".kanban-card").each(function(index) {
                var id = $(this).data("id");
                destPositions.push({ card_id: id, position: index + 1 });
            });
            
            const card = ui.item;
            card.removeClass("todo wip blocked done");
            const newClass = columnColorMapping[columnType] || "kanban-card";
            card.attr("class", newClass);
            
            if (subState) {                
                setTimeout(function() {
                    updateCardSubstate(cardId, toStateId, subState);
                }, 3);
            }
            
            setTimeout(function() {
                updateCardState(cardId, fromStateId, toStateId, destPositions, destColumn, {{ project.id }}, boardId, fromColumn);
            }, 3);
            
            ui.item.removeData("start-state").removeData("from-column");
            ui.item.data("start-state", toStateId);
            ui.item.data("from-column", destColumn);

            if (fromColumn == 'Backlog' || destColumn == 'Backlog') {
                refreshKanbanBoard();
            }

            updateWIPCounts();
        }
    }).disableSelection();
});

function updateCardSubstate(id, stateId, subState) {
    console.log(`Updating substate for Card ${id} -> ${subState}`);

    let formData = new FormData();
    formData.append("id", id);
    formData.append("model_name", "ProjectBoardCard");
    formData.append("app_name", "app_organization");
    formData.append("field_name", "substate");
    formData.append("new_value", subState);

    fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error:", data.error);
        } else {
            console.log("Substate Update Success:", data);
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

function updateCardState(cardId, fromStateId, toStateId, destPositions, destColumn, projectId, boardId, fromColumn) {
    fetch("{% url 'ajax_update_project_board_card_state' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            card_id: cardId,
            board_id: {{ project_board.id }},
            from_state_id: fromStateId,
            to_state_id: toStateId,
            positions: destPositions,
            dest_column: destColumn,
            project_id: projectId,
            board_id: boardId,
            from_column: fromColumn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error:", data.error);
        } else {
            console.log("Success:", data);
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

function refreshKanbanBoard() {
    document.getElementById("loading-spinner").style.display = "flex";
    setTimeout(() => {
        location.reload();
    }, 200);
}

window.addEventListener('load', function() {
    document.getElementById("loading-spinner").style.display = "none";
    
    // Re-initialize sortable after page load to ensure it works properly
    setTimeout(function() {
        $(".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn").sortable("refresh");
    }, 100);
});
</script>

<script>
    function makeEditable(element) {
        element.contentEditable = true;
        element.focus();
    }

    function save_element_text(element, id, appName, modelName, fieldName) {
        element.contentEditable = false;
        $.ajax({
            url: '/common/common_ajax/ajax_save_element_text/',
            type: 'POST',
            data : {
                'csrfmiddlewaretoken': "{{ csrf_token }}",
                'model_name': modelName,
                'app_name': appName,
                'field_name': fieldName,
                'text': element.textContent, 
                'id': id,
            },
            dataType: 'json',
            success: function(data) {
                console.log(data);
            }
        });
    }
</script>
<script>
    // Core function to initialize the table layout
function initTableLayoutTheme() {
    // Add table layout class to the kanban board
    const kanbanBoard = document.getElementById('kanban-board');
    if (!kanbanBoard) return;
    
    kanbanBoard.classList.add('kanban-table-layout');
    
    // Convert card counts to circles with properly formatted data
    convertCardCountsToCircles();
    
    // Update all card counts
    updateWIPCounts();
}

// Format WIP count circles for better visibility
function convertCardCountsToCircles() {
    document.querySelectorAll('[id^="card-count-"]').forEach(countElement => {
        // Get current text content
        const currentText = countElement.textContent.trim();
        
        // Get state id from element id
        const stateId = countElement.id.replace('card-count-', '');
        const column = document.querySelector(`.kanban-column[data-id="${stateId}"]`);
        
        if (!column) return;
        
        // Check if WIP limit is applied
        const applyWipLimit = column.getAttribute('data-apply-wip-limit') === 'true';
        const wipLimit = parseInt(column.getAttribute('data-wip-limit'), 10) || Infinity;
        
        // Format count for display
        let formattedCount;
        if (currentText === '∞') {
            formattedCount = '∞';
        } else if (currentText.includes('/')) {
            formattedCount = currentText;
        } else {
            formattedCount = applyWipLimit ? `0/${wipLimit}` : '0/∞';
        }
        
        // Add circle class
        countElement.className = 'wip-circle';
        countElement.textContent = formattedCount;
        
        // Move to column title for better positioning
        const columnTitle = column.querySelector('.column_title');
        if (columnTitle) {
            columnTitle.appendChild(countElement);
        }
    });
}

// Enhanced WIP count function with improved styling
function updateWIPCounts() {
    document.querySelectorAll(".kanban-column").forEach(column => {
        let stateId = column.getAttribute("data-id");
        let wipLimit = parseInt(column.getAttribute("data-wip-limit"), 10) || Infinity;
        let applyWipLimit = column.getAttribute("data-apply-wip-limit") === "true";
        let isBufferColumn = column.classList.contains("buffer-column");
        
        // Count cards differently for regular vs buffer columns
        let cardCount = 0;
        
        if (isBufferColumn) {
            // Get all subcolumns
            const subcolumns = column.querySelectorAll(".kanban-subcolumn");
            let subcolumnCounts = {};
            let totalCount = 0;
            
            // Count cards in each subcolumn
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const count = subcolumn.querySelectorAll(".kanban-card").length;
                subcolumnCounts[substate] = count;
                totalCount += count;
            });
            
            cardCount = totalCount;
            
            // Update top column count display with just the total
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Display count/wipLimit or count/∞ if no WIP limit
                const limitDisplay = applyWipLimit ? wipLimit : "∞";
                countElement.textContent = `${cardCount}/${limitDisplay}`;
                
                // Add exceeded class if limit is exceeded
                if (applyWipLimit && cardCount > wipLimit) {
                    countElement.classList.add('wip-exceeded');
                } else {
                    countElement.classList.remove('wip-exceeded');
                }
            }
            
            // Update each subcolumn title with its count
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const wip_limit_attr = subcolumn.getAttribute("data-buffer-subcolumn-wip-limit");
                const subWipLimit = wip_limit_attr ? parseInt(wip_limit_attr) : 2;
                const count = subcolumnCounts[substate];
                
                // Set the WIP limit attribute if not already set
                if (!wip_limit_attr) {
                    subcolumn.setAttribute("data-buffer-subcolumn-wip-limit", subWipLimit);
                }
                
                // Update the title
                const title = subcolumn.querySelector("b");
                if (title) {
                    const columnName = title.textContent.split(":")[0];
                    title.innerHTML = `${columnName}: ${substate} <span class="wip-count ${count > subWipLimit ? 'exceeded' : ''}">${count}/${subWipLimit}</span>`;
                }
                
                // Highlight subcolumn if count exceeds limit
                if (count > subWipLimit) {
                    subcolumn.classList.add("subcolumn-exceeded");
                } else {
                    subcolumn.classList.remove("subcolumn-exceeded");
                }
            });
            
            // Highlight whole column if total exceeds limit
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
                column.querySelector(".kanban-buffer").classList.add("buffer-exceeded");
            } else {
                column.classList.remove("blink-border");
                column.querySelector(".kanban-buffer").classList.remove("buffer-exceeded");
            }
            
        } else {
            // For regular columns, just count all cards
            cardCount = column.querySelectorAll(".kanban-card").length;
            
            // Update the count display
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Check if WIP limit is applied and format accordingly
                if (applyWipLimit) {
                    countElement.textContent = `${cardCount}/${wipLimit}`;
                    
                    // Add exceeded class if limit is exceeded
                    if (cardCount > wipLimit) {
                        countElement.classList.add('wip-exceeded');
                    } else {
                        countElement.classList.remove('wip-exceeded');
                    }
                } else {
                    countElement.textContent = `${cardCount}/∞`;
                    countElement.classList.remove('wip-exceeded');
                }
            }
            
            // Add blinking border if WIP limit is exceeded
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
            } else {
                column.classList.remove("blink-border");
            }
        }
    });
}

// Setup for the swimlanes theme with vertical labels
function setupSwimlanesStructure() {
    if (!document.body.classList.contains('theme4')) return;
    
    const kanbanBoard = document.getElementById('kanban-board');
    if (!kanbanBoard || kanbanBoard.querySelector('.vertical-swimlane-header')) return;
    
    // Create the swimlanes grid structure
    const swimlanesGrid = document.createElement('div');
    swimlanesGrid.className = 'swimlanes-grid';
    
    // Create the vertical labels column
    const verticalLabels = document.createElement('div');
    verticalLabels.className = 'vertical-swimlane-labels';
    
    // Create the header for the labels column
    const verticalHeader = document.createElement('div');
    verticalHeader.className = 'vertical-swimlane-header';
    verticalHeader.textContent = 'Swimlanes';
    verticalLabels.appendChild(verticalHeader);
    
    // Create the container for the vertical labels
    const labelsContainer = document.createElement('div');
    labelsContainer.className = 'vertical-swimlane-labels-container';
    
    // Add the swimlane labels
    const swimlanes = [
        { class: 'general', name: 'General' },
        { class: 'expedite', name: 'Expedite' },
        { class: 'fixed', name: 'Fixed Date' },
        { class: 'standard', name: 'Standard' },
        { class: 'intangible', name: 'Intangible' }
    ];
    
    swimlanes.forEach(lane => {
        const label = document.createElement('div');
        label.className = `vertical-swimlane-label swimlane-${lane.class}`;
        label.textContent = lane.name;
        labelsContainer.appendChild(label);
    });
    
    verticalLabels.appendChild(labelsContainer);
    swimlanesGrid.appendChild(verticalLabels);
    
    // Create the content area for the columns
    const swimlanesContent = document.createElement('div');
    swimlanesContent.className = 'swimlanes-content';
    
    // Move all existing columns to the content area
    while (kanbanBoard.firstChild) {
        swimlanesContent.appendChild(kanbanBoard.firstChild);
    }
    
    swimlanesGrid.appendChild(swimlanesContent);
    kanbanBoard.appendChild(swimlanesGrid);
    
    // Reorganize each swimlane into sections
    document.querySelectorAll('.kanban-swimlane').forEach(swimlane => {
        // Save original cards
        const originalCards = Array.from(swimlane.querySelectorAll('.kanban-card'));
        
        // Clear the swimlane
        swimlane.innerHTML = '';
        
        // Create swimlane sections
        swimlanes.forEach(lane => {
            const section = document.createElement('div');
            section.className = `swimlane-${lane.class}`;
            swimlane.appendChild(section);
        });
        
        // Distribute cards based on priority
        originalCards.forEach(card => {
            const priorityElement = card.querySelector('.priority');
            const priority = priorityElement ? priorityElement.className.replace('priority priority-', '').toLowerCase() : '';
            
            let targetSection;
            if (priority === 'critical' || priority === 'high') {
                targetSection = 'swimlane-expedite';
            } else if (priority === 'normal') {
                targetSection = 'swimlane-fixed';
            } else if (priority === 'medium') {
                targetSection = 'swimlane-standard';
            } else if (priority === 'low') {
                targetSection = 'swimlane-intangible';
            } else {
                targetSection = 'swimlane-general';
            }
            
            const sectionElement = swimlane.querySelector('.' + targetSection);
            if (sectionElement) {
                sectionElement.appendChild(card.cloneNode(true));
            }
        });
    });
    
    // Reinitialize sortable for the new structure
    initializeSwimlanesSortable();
}

// Initialize sortable for the swimlanes structure
function initializeSwimlanesSortable() {
    if (!document.body.classList.contains('theme4')) return;
    
    try {
        // Reconnect sortable with new swimlane structure
        $('.swimlane-general, .swimlane-expedite, .swimlane-fixed, .swimlane-standard, .swimlane-intangible').sortable({
            connectWith: '.swimlane-general, .swimlane-expedite, .swimlane-fixed, .swimlane-standard, .swimlane-intangible',
            placeholder: 'kanban-card-placeholder',
            tolerance: 'pointer',
            items: '.kanban-card',
            scroll: true,
            scrollSensitivity: 100,
            scrollSpeed: 10,
            // Other sortable options inherited from original
        }).disableSelection();
    } catch (error) {
        console.error('Error initializing swimlanes sortable:', error);
    }
}

// Add theme switcher with Bootstrap styling
function addThemeSwitcher() {
    const themeSwitcher = `
        <div class="theme-switcher">
            <button class="theme-button" data-theme="theme1">Professional Light</button>
            <button class="theme-button" data-theme="theme2">Professional Dark</button>
            <button class="theme-button" data-theme="theme3">Handwritten</button>
            <button class="theme-button" data-theme="theme4">Swimlanes</button>
        </div>
    `;
    
    // Insert the theme switcher before the kanban board
    const kanbanBoard = document.getElementById('kanban-board');
    if (kanbanBoard) {
        kanbanBoard.insertAdjacentHTML('beforebegin', themeSwitcher);
    }
}

// Set active theme with improved handling
function setActiveTheme(themeName) {
    // First clean up any special structures from old theme
    if (document.body.classList.contains('theme4') && themeName !== 'theme4') {
        resetFromSwimlanes();
    }

    // Remove all theme classes
    document.body.classList.remove('theme1', 'theme2', 'theme3', 'theme4');
    
    // Add the selected theme class
    document.body.classList.add(themeName);
    
    // Update active button state
    document.querySelectorAll('.theme-button').forEach(button => {
        button.classList.remove('active');
    });
    
    const activeButton = document.querySelector(`.theme-button[data-theme="${themeName}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
    
    // Save preference in localStorage
    localStorage.setItem('kanbanTheme', themeName);
    
    // Handle theme-specific initialization
    if (themeName === 'theme4') {
        setupSwimlanesStructure();
    }
    
    // Special handling for Theme 3 (add Google Font for handwritten style)
    if (themeName === 'theme3') {
        if (!document.getElementById('handwritten-font')) {
            const link = document.createElement('link');
            link.id = 'handwritten-font';
            link.rel = 'stylesheet';
            link.href = 'https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&display=swap';
            document.head.appendChild(link);
        }
    }
    
    // Update WIP counts for the new theme
    setTimeout(updateWIPCounts, 100);
}

// Reset from swimlanes layout to standard layout
function resetFromSwimlanes() {
    // Simplest approach is to refresh the page, but we can try to be more elegant
    location.reload();
}

// Main initialization function for all themes
function initThemes() {
    // Initialize table layout
    initTableLayoutTheme();
    
    // Add theme switcher
    addThemeSwitcher();
    
    // Set the theme from localStorage or default to theme1
    const savedTheme = localStorage.getItem('kanbanTheme') || 'theme1';
    setActiveTheme(savedTheme);
    
    // Add event listeners to theme buttons
    document.querySelectorAll('.theme-button').forEach(button => {
        button.addEventListener('click', function() {
            setActiveTheme(this.dataset.theme);
        });
    });
}

// Initialize when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    initThemes();
});


// Update counts after any drag-and-drop operations
$(document).on("sortreceive sortstop", function() {
    setTimeout(updateWIPCounts, 100);
});
</script>
{% endblock content %}