{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load app_web_my_filters %}
{% load markdown_extras %}
{% load mptt_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsive Kanban Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Load Font Awesome for icons -->
  <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
 <!-- Using Font Awesome 6 with CDN -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">


  <style>

  /* Kanban Board Container */
  .kanban-board-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 15px;
    overflow-x: auto;
  }
  
  /* Responsive table wrapper */
  .kanban-table-wrapper {
    margin: 0 auto;
    max-width: 100%;
    overflow-x: auto;
  }
  
  /* Main kanban table */
  .kanban-table {
    width: 100%;
    min-width: 800px; /* Minimum width to prevent crushing */
    margin: 0 auto;
    table-layout: auto;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .placeholder_column {
    width: 2%;
    min-width: 30px;
  }
  .kanban_column, .count_column {
    width: auto;
    min-width: 150px;
    max-width: 250px;
    vertical-align: top;
    padding: 8px;
  }
  .third_row {
    vertical-align: top;
  }
  
  /* Responsive adjustments */
  @media (max-width: 1200px) {
    .kanban_column, .count_column {
      min-width: 120px;
    }
  }
  
  @media (max-width: 768px) {
    .kanban-table {
      min-width: 600px;
    }
    .kanban_column, .count_column {
      min-width: 100px;
      font-size: 0.85rem;
    }
  }

  /* Additional responsive and centering styles */
  .kanban-board-container {
    display: flex;
    justify-content: center;
    width: 100%;
  }
  
  .kanban-table-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
  }
  
  /* Make columns grow to fill available space */
  @media (min-width: 1200px) {
    .kanban_column, .count_column {
      width: auto;
      flex: 1;
    }
  }

  /* Thin divider line below table header */
  .header-divider-line {
    border-bottom: 2px solid #e9ecef;
    height: 0;
    line-height: 0;
    padding: 0;
    margin: 0;
  }

  /* Draw divider at the bottom of the tallest header row */
  .header-bottom-divider td { border-bottom: 2px solid #e9ecef; }
  .header-bottom-divider .placeholder_column { border-bottom: none; }
  .header-bottom-divider-cell { border-bottom: 2px solid #e9ecef; }

  /* Header rows subtle separators for clarity */
  thead tr.header-row td { border-bottom: 2px solid #e9ecef; }
  thead tr.header-row .placeholder_column { border-bottom: none; }

  /* Column Policies Styles */
  .column-policies {
    background-color: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 8px;
    margin: 5px;
    font-size: 0.75rem;
  position: relative; /* for positioning the + button */
  }
  
  .policies-toggle {
    margin-bottom: 8px;
    text-align: center;
  }
  
  .policies-checkbox {
    margin-right: 5px;
  }
  
  .policies-list {
    background-color: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  min-height: 40px;
    padding: 6px;
    margin-top: 5px;
  /* Allow natural height for general policies; column policies will stay compact */
  max-height: none;
  overflow-y: visible;
  padding-right: 28px; /* space for the + icon */
  }
  
  .policy-item {
    display: flex;
    align-items: center;
    padding: 4px 2px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.7rem;
    transition: background-color 0.2s ease;
    border-radius: 2px;
    position: relative;
  }
  
  .policy-item:hover {
    background-color: #f8f9fa;
  }
  
  .policy-item:last-child {
    border-bottom: none;
  }
  
  .policy-text {
    flex: 1;
    margin-left: 4px;
    padding-right: 50px; /* Space for hover icons */
  }
  
  .policy-actions {
    position: absolute;
    right: 4px;
    display: none;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .policy-item:hover .policy-actions {
    display: flex;
    opacity: 1;
  }
  
  .policy-actions button {
    padding: 2px 4px;
    font-size: 0.7rem;
    border: none;
    border-radius: 2px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s ease;
  }
  
  .policy-actions button:hover {
    transform: scale(1.1);
  }
  
  .btn-edit-policy {
    background-color: #17a2b8;
    color: white;
  }
  
  .btn-edit-policy:hover {
    background-color: #138496;
  }
  
  .btn-delete-policy {
    background-color: #dc3545;
    color: white;
  }
  
  .btn-delete-policy:hover {
    background-color: #c82333;
  }
  
  .policy-form {
    margin-top: 5px;
    padding: 6px;
    background-color: #f8f9fa;
    border-radius: 4px;
    display: none;
  }
  
  .policy-form.active {
    display: block;
  }
  
  .policy-form input {
    width: 100%;
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 0.7rem;
  }
  
  .policy-form-buttons {
    margin-top: 4px;
    display: flex;
    gap: 4px;
  }
  
  .policy-form-buttons button {
    padding: 2px 8px;
    font-size: 0.65rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  
  .btn-save-policy {
    background-color: #28a745;
    color: white;
  }
  
  .btn-cancel-policy {
    background-color: #6c757d;
    color: white;
  }
  
  .add-policy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background-color: #007bff;
    color: #fff;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 16px;
    line-height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .add-policy-btn:hover { background-color: #0056b3; }
  
  .policies-hidden {
    display: none;
  }

  /* Delete Confirmation Modal */
  .delete-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(2px);
  }
  
  .delete-modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .delete-modal-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    color: #dc3545;
  }
  
  .delete-modal-header i {
    font-size: 1.5rem;
    margin-right: 10px;
  }
  
  .delete-modal-header h4 {
    margin: 0;
    font-size: 1.1rem;
  }
  
  .delete-modal-body {
    margin-bottom: 20px;
    font-size: 0.9rem;
    color: #333;
  }
  
  .policy-preview {
    background-color: #f8f9fa;
    border-left: 4px solid #dc3545;
    padding: 8px;
    margin: 10px 0;
    font-style: italic;
    border-radius: 4px;
  }
  
  .delete-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  
  .btn-modal {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s ease;
  }
  
  .btn-confirm-delete {
    background-color: #dc3545;
    color: white;
  }
  
  .btn-confirm-delete:hover {
    background-color: #c82333;
  }
  
  .btn-cancel-delete {
    background-color: #6c757d;
    color: white;
  }
  
  .btn-cancel-delete:hover {
    background-color: #5a6268;
  }
  /* General policies container */
  .common-policies-section {
    background-color: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px 8px 12px 8px;
  }
  .policies-header-common h6 { font-weight: 600; }
  .common-policies-content .policies-list {
    min-height: 40px;
    max-height: none;
    overflow: visible; /* no scrollbar */
  }
  .add-general-policy-btn {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    white-space: nowrap;
  }
  .add-general-policy-btn:hover { background-color: #0056b3; }
  /** display headers */
  .column_title {
    font-size: 0.75rem;
    font-weight: bold;
  }
  .count_wip {
    font-size: 0.65rem;
    font-weight: bold;
    color: #707070;
  }
  .column_number {
    font-size: 0.55rem;
    font-weight: bold;
    color: #707070;
    font-family: 'Pacifico', cursive;    
  }

  /** swimlane **/
  /* Swimlane title rotated vertically */
  .swimlane_title {
    writing-mode: vertical-rl;
    transform: rotate(180deg); /* Makes text go bottom to top */
    text-align: center;
    background-color: #eedf13;  /* Light beige or choose your own */
    border-top-left-radius: 0px;
    border-bottom-left-radius: 0px;
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    padding: 8px;
    font-weight: bold;
    color: #333;  
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Visual separation for each swimlane row */
  .swimlane_row td { border-top: 2px solid #e9ecef; }
  .swimlane_row:first-of-type td { border-top: 2px solid #d9dee3; }
  .swimlane_row + .policies_row td { border-top: 2px solid #e9ecef; }

  /* CoS badge toggle target */
  .cos-badge { display: inline-block; }

  /* Orange swimlane tabs for Policies rows */
  .swimlane_title.policies-tab,
  .swimlane_title.general-policies-tab {
    background-color: #ff8c00; /* orange */
    color: #fff; /* white */
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
  }


  /** card display **/
  .card {
    background-color: #f0c506;
    border-radius: 5px;
    padding: 5px;
    margin: 12px;
    font-size: 0.55rem;
    color: #333;
    cursor: move; /* Cursor style for draggable cards */
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: background-color 0.3s, box-shadow 0.3s;

    min-height: 10vh;
  }
  .card.orange { background-color: #ff9800; color: #000; }
  .card.blue { background-color: #2196f3; color: #fff; }
  .card.green { background-color: #4caf50; color: #fff; }
  .card.red { background-color: #f44336; color: #fff; }
  .card.purple { background-color: #9c27b0; color: #fff; }
  .card.teal { background-color: #80deea; color: #006064; }
/* 
  .card.High { background-color: #ff9800; color: #000; }
  .card.Medium { background-color: #2196f3; color: #fff; }
  .card.Normal { background-color: #4caf50; color: #fff; }
  .card.Critical { background-color: #f44336; color: #fff; }
  .card.Low { background-color: #9c27b0; color: #fff; } */
  /* Enhanced Card Styling */
.card {
  background: rgb(233, 200, 11);
  border-radius: 8px;
  padding: 12px;
  margin: 10px;
  font-size: 0.65rem;
  color: #333;
  cursor: move;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  border-left: 4px solid #4a6cf7;
  min-height: auto;
  position: relative;
  overflow: hidden;
}
/* Improved Card Styling without footer buttons */
.card {
  background-color: white;
  border-radius: 8px;
  padding: 0;
  margin: 10px;
  font-size: 0.65rem;
  color: #333;
  cursor: move;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  border-left: 4px solid #4a6cf7;
  position: relative;
  overflow: hidden;
  min-height: auto;
}
.card_action {
    font-size: 12px;
    font-weight: bold;
  }
  .card_action.edit {
    font-size: 13px;
  }
  .card_action.delete {
    font-size: 10px;
  }
.card:hover {
  box-shadow: 0 5px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

/* Priority Colors */
.card.Critical { border-left-color: #e53935; }
.card.High { border-left-color: #ff9800; }
.card.Medium { border-left-color: #ffeb3b; }
.card.Low { border-left-color: #4caf50; }
.card.Normal { border-left-color: #2196f3; }

/* Card Header */
.card_header {
  padding: 8px 10px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  font-size: 0.7rem;
}

.card_header_left {
  display: flex;
  gap: 6px;
}

.card_header_right {
  display: flex;
  gap: 6px;
}

.card_tag {
  background-color: #e3f2fd;
  color: #1976d2;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.65rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80px;
}

.card_tag.priority-Critical { background-color: #ffcdd2; color: #c62828; }
.card_tag.priority-High { background-color: #ffe0b2; color: #e65100; }
.card_tag.priority-Medium { background-color: #fff9c4; color: #f57f17; }
.card_tag.priority-Low { background-color: #c8e6c9; color: #2e7d32; }
.card_tag.priority-Normal { background-color: #bbdefb; color: #0d47a1; }

.card_tag.size-Small { background-color: #e8f5e9; color: #2e7d32; }
.card_tag.size-Medium { background-color: #e3f2fd; color: #0d47a1; }
.card_tag.size-Large { background-color: #fff3e0; color: #e65100; }
.card_tag.size-XLarge { background-color: #ffebee; color: #c62828; }

.card_tag.release { background-color: #e8eaf6; color: #3949ab; }
.card_tag.iteration { background-color: #f3e5f5; color: #7b1fa2; }

/* Card Content */
.card_content {
  padding: 10px;
  position: relative;
}

.card_title {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 0.85rem;
  padding-right: 30px; /* Space for the hover actions */
}

.card_description {
  font-size: 0.75rem;
  color: #666;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Card Actions */
.card_actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 5px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.card:hover .card_actions {
  opacity: 1;
}

.card_action {
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f0f0f0;
  border-radius: 50%;
  color: #555;
  border: none;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s ease;
}

.card_action:hover {
  background-color: #e0e0e0;
  color: #1976d2;
}

.card_action.edit:hover {
  background-color: #bbdefb;
  color: #0d47a1;
}

.card_action.link:hover {
  background-color: #c8e6c9;
  color: #2e7d32;
}

.card_action.delete:hover {
  background-color: #ffcdd2;
  color: #c62828;
}

/* Card ID Badge */
.card_id_badge {
  position: absolute;
  bottom: 8px;
  right: 8px;
  font-size: 0.65rem;
  color: #999;
  background-color: #f5f5f5;
  padding: 1px 5px;
  border-radius: 8px;
}
.card:hover {
  box-shadow: 0 5px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

/* Priority Colors */
.card.Critical {
  border-left-color: #e53935;
}
.card.High {
  border-left-color: #cc9a11;
}
.card.Medium {
  border-left-color: #ff9800;
}

.card.Low {
  border-left-color: #4caf50;
}

.card.Normal {
  border-left-color: #4a6cf7;
}

/* Card Content Layout */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-weight: bold;
}

.card-id {
  font-size: 0.7rem;
  color: #888;
  background: #f1f1f1;
  padding: 2px 6px;
  border-radius: 10px;
}

.card-title {
  font-weight: 500;
  line-height: 1.3;
  margin-bottom: 8px;
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  font-size: 0.65rem;
}

.card-meta {
  display: flex;
  gap: 8px;
}

.card-tag {
  background: #e3f2fd;
  color: #1976d2;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.65rem;
}

/* Visual indicator for dragging */
.card.dragging {
  opacity: 0.7;
  transform: scale(1.05);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* Insertion indicators */
.card.insert-above {
  border-top: 2px solid #2196f3;
  padding-top: 10px;
}

.card.insert-below {
  border-bottom: 2px solid #2196f3;
  padding-bottom: 10px;
}


  /** BORDERS */

  .left_border {
    border-left: 1px solid lightgrey;
  }

  .right_border {
    border-right: 1px solid lightgrey;
  }

  .top_border {
    border-top: 1px solid lightgrey;
  }

  .bottom_border {
    border-bottom: 1px solid lightgrey;
  }

  .sketchy_dotted_border {
    border: 1px dotted lightgrey;
    border-left-style: dashed;
    border-right-style: dotted;
  }
  .sketchy_right_dotted_border {
    border-right: 2px dotted lightgrey;  
  }
  .sketchy_right_dashed_border {
    border-right: 2px dashed lightgrey;  
  }
  .sketchy_right_solid_border {
    border-right: 2px solid lightgrey;  
  }

  .sketchy_left_solid_border {
    border-left: 2px solid lightgrey;  
  }

  .sketchy_top_solid_border {
    border-top: 2px solid lightgrey;  
  }

  .sketchy_bottom_solid_border {
    border-bottom: 2px solid lightgrey;  
  }

  .sketchy_bottom_solid_white_border {
    border-bottom: 2px solid white;  
  }



  .kanban_column.drag-over {
    background-color: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff !important;
  }

  
  </style>
  
<style>
  /* Design 5: Corporate & Structured */
  .card-design-5 {
      border: none;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      background: white;
    }
    
    .card-design-5 .card-header {
      background: #f8f9fa;
      padding: 10px 15px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
    }
    
    .card-design-5 .card-id {
      font-size: 0.75rem;
      color: #555;
      font-weight: 600;
    }
    
    .card-design-5 .status {
      font-size: 0.7rem;
      color: white;
      background: #2196f3;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .card-design-5 .card-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .card-design-5 .card-body {
      padding: 12px 15px;
    }
    
    .card-design-5 .card-text {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 15px;
    }
    
    .card-design-5 .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.7rem;
      color: #666;
    }
    
    .card-design-5 .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
</style>

<!-- CSS Styles for the Modal -->
<style>
  .modal-content {
    display: flex;
    flex-direction: column;
  }
  
  .modal-body {
    flex: 1;
    overflow-y: auto;
  }
  
  .info-header {
    font-weight: 600;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 6px;
    margin-bottom: 10px;
  }
  
  .card-info-panel, .card-description-panel {
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    height: 100%;
  }
  
  .card-description-display {
    background-color: white;
    border-radius: 4px;
    min-height: 150px;
    border: 1px solid #ced4da;
    padding: 10px;
  }
  
  /* Priority Tag Colors */
  .priority-tag {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .priority-Critical {
    background-color: #ffcdd2;
    color: #d32f2f;
  }
  
  .priority-High {
    background-color: #ffebee;
    color: #e53935;
  }
  
  .priority-Medium {
    background-color: #fff3e0;
    color: #ff9800;
  }
  
  .priority-Low {
    background-color: #e8f5e9;
    color: #4caf50;
  }
  
  .priority-Normal {
    background-color: #e3f2fd;
    color: #1976d2;
  }
</style>
</head>
<body>
  
<!-- Begin:  Kanban Board -->
<div class="container-fluid">
  <div class="row mt-2 align-items-start">
    <div class="col-md-4">
      <b class="">Project:</b>
       <a href="{% url 'project_homepage' project.org.id project.id %}">{{project}}</a>
      <b class="">Project Board:</b>
      {{project_board}}
    </div>

  <div class="col-md-4 d-flex justify-content-center">
      <div class="policies-toggle mb-2 text-center">
        <input type="checkbox" id="showColumnPolicies" class="policies-checkbox" checked>
        <label for="showColumnPolicies"><small>Show Column Policies</small></label>
      </div>
    </div>

    <div class="col-md-4">
      <div class="d-flex justify-content-end align-items-start gap-2 flex-wrap">
        <b class="me-2">Kanban Board</b>
        <a href="{% url 'list_project_boards' project.id %}" class="btn btn-sm btn-primary">Board <i class="fas fa-edit"></i></a>
        <a href="{% url 'board_card_settings' project_board.id %}" class="btn btn-sm btn-success">Card <i class="fas fa-cog"></i></a>
  <a href="{% url 'list_project_board_swimlanes' project.id %}" class="btn btn-sm btn-warning">Configure Swimlanes <i class="fas fa-sliders-h"></i></a>
  <a href="{% url 'list_project_board_cos' project.id %}" class="btn btn-sm btn-outline-warning ms-2">Configure Classes of Service</a>
        <div class="form-check form-switch ms-2">
          <input class="form-check-input" type="checkbox" id="toggleCosBadges" checked>
          <label class="form-check-label" for="toggleCosBadges"><small>Show Classes of Service</small></label>
        </div>
        <a href="{% url 'view_project_tree_backlog' project.id  %}?project_id={{ project.id }}" class="btn btn-sm btn-primary">
          <i class="bi bi-arrow-left"></i> Back to Backlog
        </a>
      </div>
    </div>
  </div>
</div>

<div class="kanban-board-container">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="kanban-table-wrapper">
        <!-- Kanban Table-->
        <table class="kanban-table">

        <!-- Headers -->
        <thead>
          <!--
          FIRST ROW
          COUNTS
          -->
          <tr class="header-row">
            <td class="placeholder_column">
              <!-- Place holder for swimlane -->
            </td>
            <td class=" ">
              <!-- Backlog counts -->
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_number">
                      1
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% for state in project_board_states %}
            {% if state.buffer_column %}              
            <td class=" " colspan="2">
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_number">
                      {{ forloop.counter|add:"1" }}
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% else %}
            <td class="" colspan="1">
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_number">
                      {{ forloop.counter|add:"1" }}
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% endif %}
            {% endfor %}
          </tr>

          




          <!--
          SECOND ROW
          COUNTS
          -->
          <tr class="header-row">
            <td class="placeholder_column">
              <!-- Place holder for swimlane -->
            </td>
            <td class="backlog_column count_column count_no_wip_limit">
              <!-- Backlog counts -->
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_count_and_limit">
                      <div class="count_wip">∞</div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% for state in project_board_states %}
            {% if state.buffer_column %}              
            <td class="count_column {% if not state.apply_wip_limit %}count_no_wip_limit{% else %}count_wip_limit{% endif %}" colspan="2">
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="buffer_column_count_and_limit">
                      <div class="count_wip">{% if state.apply_wip_limit %}{{ state.wip_limit }}{% else %}∞{% endif %}</div>                      
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% else %}
            <td class="count_column {% if not state.apply_wip_limit %}count_no_wip_limit{% else %}count_wip_limit{% endif %}" colspan="1">
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_count_and_limit">
                      <div class="count_wip">{% if state.apply_wip_limit %}{{ state.wip_limit }}{% else %}∞{% endif %}</div>   
                    </div>
                  </div>
                </div>
              </div>
            </td>
            {% endif %}
            {% endfor %}
          </tr>


          <!--
          THIRD ROW
          HEADER
          -->
          <tr class="header-row ">
            <td class="placeholder_column ">
              <!-- Place holder for swimlane -->
            </td>
            <!-- Backlog -->
            <td class="third_row sketchy_left_solid_border sketchy_right_solid_border header-bottom-divider-cell" rowspan="3">
              <div class="container">
                <div class="row">
                  <div class="col col md-6 text-center">
                    <div class="column_title">
                      Backlog
                    </div>
                  </div>
                </div>
              </div>
            </td>

            <!-- other columns -->
            {% for state in project_board_states %}
              <!-- Step1: Display columns and then columns with buffer states -->
              {% if state.buffer_column %}
              <td class=" buffer_column sketchy_right_solid_border" colspan="2">
                <div class="container">
                  <div class="row">
                    <div class="col col md-6 text-center">
                      <div class="column_title">
                        {{state.name}}
                      </div>
                    </div>
                  </div>
                </div>
              </td>
              {% else %}
              <td class="  sketchy_right_solid_border" colspan="1">
                <div class="container">
                  <div class="row">
                    <div class="col col md-6 text-center">
                      <div class="column_title">
                        {{state.name}}
                      </div>
                    </div>
                  </div>
                </div>
              </td>
              {% endif %}
            {% endfor %}
          </tr>


          <!--
          FOURTH ROW
          HEADER
          -->
          <tr class="header-row ">
            <td class="placeholder_column ">
              <!-- Place holder for swimlane -->
            </td>
           

            <!-- other columns -->
            {% for state in project_board_states %}
              <!-- Step1: Display columns and then columns with buffer states -->
              {% if state.buffer_column %}
                {% with subcolumns=state.get_subcolumns %}
                {% for substate_choice in subcolumns %}
                <td class=" buffer_sub_column sketchy_right_solid_border sketchy_top_solid_border" colspan="1">                
                  <div class="display_count_and_limit text-center">
                    <div class="count_wip">{% if state.apply_wip_limit %}{{ state.wip_limit }}{% else %}∞{% endif %}</div>                      
                  </div>
                </td>
                {% endfor %}
                {% endwith %}
              {% else %}
              <td class="  sketchy_right_solid_border" colspan="1">
                
              </td>
              {% endif %}
            {% endfor %}
          </tr>


          <!--
          FIFTH ROW
          HEADER
          -->
          <tr class="header-bottom-divider">
            <td class="placeholder_column ">
              <!-- Place holder for swimlane -->
            </td>
           

            <!-- other columns -->
            {% for state in project_board_states %}
              <!-- Step1: Display columns and then columns with buffer states -->
              {% if state.buffer_column %}
                {% with subcolumns=state.get_subcolumns %}
                {% for substate_choice in subcolumns %}
                <td class="  sketchy_right_solid_border sketchy_top_solid_border" colspan="1">                
                  <div class="column_title text-center">
                    {{ substate_choice }}   
                  </div>
                </td>
                {% endfor %}
                {% endwith %}
              {% else %}
              <td class="  sketchy_right_solid_border" colspan="1">
                <div class="container">
                  <div class="row">
                    <div class="col col md-6 text-center">
                      <div class="column_title">
                        
                      </div>
                    </div>
                  </div>
                </div>
              </td>
              {% endif %}
            {% endfor %}
          </tr>

          
        </thead>


        <!--
        BODY
        -->
        <tbody>
          {% if FLAG_board_swimlane_exists and board_swimlanes %}
            {% for lane in board_swimlanes %}
            <tr class="swimlane_row sketchy_top_solid_border">
              <td class="placeholder_column">
                <div class="swimlane_title">{{ lane.name|default:'Swimlane' }}</div>
              </td>
              <!-- Backlog column per swimlane: render empty to avoid duplicating backlog items; backlog is shown only once in General row -->
        <td class="kanban_column backlog_column sketchy_left_solid_border sketchy_right_solid_border"
          data-id="0" data-wip-limit="100" data-column-name="Backlog" data-state-id="0" data-swimlane-id="{{ lane.id }}" data-placeholder-backlog="true">
                <!-- Intentionally left blank. Backlog items are displayed only in the General row. -->
              </td>
              {% for state in project_board_states %}
                {% if state.buffer_column %}
                  {% with subcolumns=state.get_subcolumns %}
                  {% for substate_choice in subcolumns %}
          <td class="kanban_column buffer_column sketchy_top_solid_border {% if forloop.counter == 1 %}sketchy_right_dashed_border{% else %}sketchy_right_solid_border{% endif %}" colspan="1"
            id="{{state.id}}" data-column-name="{{state}}__{{substate_choice}}" data-swimlane-id="{{ lane.id }}"
                      data-column-type="{{ state.column_type }}" data-sc-wip-limit="2"
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      {% if item.substate == substate_choice and item.swimlane_id == lane.id %}
                        <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                             data-release="{{item.backlog.release|default:'v1.0'}}"
                             data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                             data-priority="{{item.backlog.priority|default:'Normal'}}"
                             data-size="{{item.backlog.size|default:'Medium'}}">
                          <div class="card_header">
                            <div class="card_header_left">
                              <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                              <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                            </div>
                            <div class="card_header_right">
                              <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                              <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                            </div>
                          </div>
                          <div class="card_content">
                            <div class="card_title">{{item|display_if_not_none}}
                              {% if item.class_of_service_id %}
                                <span class="badge bg-secondary ms-2 cos-badge">{{ item.class_of_service.name }}</span>
                              {% endif %}
                            </div>
                            <div class="card_description">{{item.description|default:''}}</div>
                          </div>
                          <div class="card_footer"></div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                  {% endfor %}
                  {% endwith %}
                {% else %}
          <td class="kanban_column normal_column sketchy_right_solid_border" colspan="1"
            id="{{state.id}}" data-column-name="{{state}}" data-state-id="{{ state.id }}" data-swimlane-id="{{ lane.id }}"
                      data-column-type="{{ state.column_type }}" data-wip-limit="{{ state.wip_limit }}"
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      {% if item.swimlane_id == lane.id %}
                        <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                             data-release="{{item.backlog.release|default:'v1.0'}}"
                             data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                             data-priority="{{item.backlog.priority|default:'Normal'}}"
                             data-size="{{item.backlog.size|default:'Medium'}}">
                          <div class="card_header">
                            <div class="card_header_left">
                              <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                              <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                            </div>
                            <div class="card_header_right">
                              <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                              <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                            </div>
                          </div>
                          <div class="card_content">
                            <div class="card_title">{{item|display_if_not_none}}
                              {% if item.class_of_service_id %}
                                <span class="badge bg-secondary ms-2 cos-badge">{{ item.class_of_service.name }}</span>
                              {% endif %}
                            </div>
                            <div class="card_description">{{item.description|default:''}}</div>
                          </div>
                          <div class="card_footer"></div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
            {% endfor %}
            <!-- Unassigned (General) row for cards without a swimlane -->
            <tr class="swimlane_row sketchy_top_solid_border">
              <td class="placeholder_column">
                <div class="swimlane_title">General</div>
              </td>
              <!-- Backlog remains unchanged -->
        <td class="kanban_column backlog_column sketchy_left_solid_border sketchy_right_solid_border"
          data-id="0" id="backlog" data-wip-limit="100" data-column-name="Backlog" data-state-id="0" data-swimlane-id="null" data-general-backlog="true">
                {% for item in backlog_items %}
                  <div class="card {{item.priority}} mb-2" id="{{item.id}}" draggable="true"
                       data-release="{{item.release|default:'v1.0'}}"
                       data-iteration="{{item.iteration|default:'Sprint 1'}}"
                       data-priority="{{item.priority|default:'Normal'}}"
                       data-size="{{item.size|default:'Medium'}}">
                    <div class="design-option">
                      <div class="card card-design-5">
                        <div class="card-header">
                          <span class="card-id">{{project}}-{{item.id}}</span>
                          <span class="status">{{item.priority|get_first_letter_caps}}</span>
                        </div>
                        <div class="card-body">
                          <h5 class="card-title">{{item.name|display_if_not_none}}</h5>
                          <p class="card-text">{{item.description|display_if_not_none}}</p>
                          <div class="card-meta">
                            <span class="meta-item"><i class="fas fa-calendar"></i>{{item.iteration|display_if_not_none}}</span>
                            <span class="meta-item"><i class="fas fa-tag"></i>{{item.release|display_if_not_none}}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </td>
              {% for state in project_board_states %}
                {% if state.buffer_column %}
                  {% with subcolumns=state.get_subcolumns %}
                  {% for substate_choice in subcolumns %}
          <td class="kanban_column buffer_column sketchy_top_solid_border {% if forloop.counter == 1 %}sketchy_right_dashed_border{% else %}sketchy_right_solid_border{% endif %}" colspan="1"
            id="{{state.id}}" data-column-name="{{state}}__{{substate_choice}}" data-swimlane-id="null"
                      data-column-type="{{ state.column_type }}" data-sc-wip-limit="2"
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      {% if item.substate == substate_choice and not item.swimlane_id %}
                        <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                             data-release="{{item.backlog.release|default:'v1.0'}}"
                             data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                             data-priority="{{item.backlog.priority|default:'Normal'}}"
                             data-size="{{item.backlog.size|default:'Medium'}}">
                          <div class="card_header">
                            <div class="card_header_left">
                              <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                              <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                            </div>
                            <div class="card_header_right">
                              <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                              <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                            </div>
                          </div>
                          <div class="card_content">
                            <div class="card_title">{{item|display_if_not_none}}</div>
                            <div class="card_description">{{item.description|default:''}}</div>
                          </div>
                          <div class="card_footer"></div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                  {% endfor %}
                  {% endwith %}
                {% else %}
          <td class="kanban_column normal_column sketchy_right_solid_border" colspan="1"
            id="{{state.id}}" data-column-name="{{state}}" data-state-id="{{ state.id }}" data-swimlane-id="null"
                      data-column-type="{{ state.column_type }}" data-wip-limit="{{ state.wip_limit }}"
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      {% if not item.swimlane_id %}
                        <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                             data-release="{{item.backlog.release|default:'v1.0'}}"
                             data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                             data-priority="{{item.backlog.priority|default:'Normal'}}"
                             data-size="{{item.backlog.size|default:'Medium'}}">
                          <div class="card_header">
                            <div class="card_header_left">
                              <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                              <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                            </div>
                            <div class="card_header_right">
                              <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                              <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                            </div>
                          </div>
                          <div class="card_content">
                            <div class="card_title">{{item|display_if_not_none}}</div>
                            <div class="card_description">{{item.description|default:''}}</div>
                          </div>
                          <div class="card_footer"></div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% else %}
            <!-- No swimlanes: default single row -->
            <tr class="general_row sketchy_top_solid_border ">
              <td class="placeholder_column ">
                <div class="swimlane_title">General</div>
              </td>
        <td class="kanban_column backlog_column sketchy_left_solid_border sketchy_right_solid_border"
          data-id="0" id="backlog" data-wip-limit="100" data-column-name="Backlog" data-state-id="0" data-swimlane-id="null" data-general-backlog="true">
                {% for item in backlog_items %}
                  <div class="card {{item.priority}} mb-2" id="{{item.id}}" draggable="true"
                       data-release="{{item.release|default:'v1.0'}}" 
                       data-iteration="{{item.iteration|default:'Sprint 1'}}"
                       data-priority="{{item.priority|default:'Normal'}}" 
                       data-size="{{item.size|default:'Medium'}}">
                    <div class="design-option">
                      <div class="card card-design-5">
                        <div class="card-header">
                          <span class="card-id">{{project}}-{{item.id}}</span>
                          <span class="status">{{item.priority|get_first_letter_caps}}</span>
                        </div>
                        <div class="card-body">
                          <h5 class="card-title">{{item.name|display_if_not_none}}</h5>
                          <p class="card-text">{{item.description|display_if_not_none}}</p>
                          <div class="card-meta">
                            <span class="meta-item"><i class="fas fa-calendar"></i>{{item.iteration|display_if_not_none}}</span>
                            <span class="meta-item"><i class="fas fa-tag"></i>{{item.release|display_if_not_none}}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>  
                {% endfor %}
              </td>
              {% for state in project_board_states %}
                {% if state.buffer_column %}
                  {% with subcolumns=state.get_subcolumns %}
                  {% for substate_choice in subcolumns %}
          <td class="kanban_column buffer_column sketchy_top_solid_border {% if forloop.counter == 1 %}sketchy_right_dashed_border{% else %}sketchy_right_solid_border{% endif %}" colspan="1"
            id="{{state.id}}"  data-column-name="{{state}}__{{substate_choice}}" data-swimlane-id="null"
                      data-column-type="{{ state.column_type }}" data-sc-wip-limit="2" 
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      {% if item.substate == substate_choice %}
                        <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                             data-release="{{item.backlog.release|default:'v1.0'}}" 
                             data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                             data-priority="{{item.backlog.priority|default:'Normal'}}" 
                             data-size="{{item.backlog.size|default:'Medium'}}">
                          <div class="card_header">
                            <div class="card_header_left">
                              <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                              <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                            </div>
                            <div class="card_header_right">
                              <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                              <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                            </div>
                          </div>
                          <div class="card_content">
                            <div class="card_title">{{item|display_if_not_none}}</div>
                            <div class="card_description">{{item.description|default:''}}</div>
                          </div>
                          <div class="card_footer"></div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                  {% endfor %}
                  {% endwith %}
                {% else %}
          <td class="kanban_column normal_column sketchy_right_solid_border" colspan="1"
            id="{{state.id}}"  data-column-name="{{state}}" data-state-id="{{ state.id }}" data-swimlane-id="null"
                      data-column-type="{{ state.column_type }}" data-wip-limit="{{ state.wip_limit }}" 
                      data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                    {% for item in state_items|get_item:state.id %}
                      <div class="card {{item.backlog.priority}} mb-2" id="{{item.id}}" draggable="true"
                           data-release="{{item.backlog.release|default:'v1.0'}}" 
                           data-iteration="{{item.backlog.iteration|default:'Sprint 1'}}"
                           data-priority="{{item.backlog.priority|default:'Normal'}}" 
                           data-size="{{item.backlog.size|default:'Medium'}}">
                        <div class="card_header">
                          <div class="card_header_left">
                            <span class="card_tag release">{{item.backlog.release|default:'v1.0'}}</span>
                            <span class="card_tag iteration">{{item.backlog.iteration|default:'Sprint 1'}}</span>
                          </div>
                          <div class="card_header_right">
                            <span class="card_tag priority-{{item.backlog.priority|default:'Normal'}}">{{item.backlog.priority|default:'Normal'}}</span>
                            <span class="card_tag size-{{item.backlog.size|default:'Medium'}}">{{item.backlog.size|default:'Medium'}}</span>
                          </div>
                        </div>
                        <div class="card_content">
                          <div class="card_title">{{item|display_if_not_none}}</div>
                          <div class="card_description">{{item.description|default:''}}</div>
                        </div>
                        <div class="card_footer"></div>
                      </div>
                    {% endfor %}
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endif %}
          
          <!-- Policies Row -->
          <tr class="policies_row">
            <!-- swimlane placeholder -->
            <td class="placeholder_column">
              <div class="swimlane_title policies-tab">Policies</div>
            </td>
            
            <!-- Backlog Policies -->
            <td class="kanban_column policies_cell backlog_column sketchy_left_solid_border sketchy_right_solid_border sketchy_top_solid_border">
              <div class="column-policies column-policies-content">
                <div class="policies-list" id="policies-backlog">
                  <!-- Policies will be loaded here -->
                </div>
                <div class="policy-form" id="form-backlog">
                  <input type="text" placeholder="Enter new policy..." class="policy-input">
                  <div class="policy-form-buttons">
                    <button class="btn-save-policy" onclick="savePolicy('backlog')">Save</button>
                    <button class="btn-cancel-policy" onclick="cancelPolicy('backlog')">Cancel</button>
                  </div>
                </div>
                <button class="add-policy-btn" onclick="showAddPolicy('backlog')" aria-label="Add policy" title="Add policy">+</button>
              </div>
            </td>
            
            <!-- Other Column Policies -->              
            {% for state in project_board_states %}
              <!-- Step1: Display columns and then columns with buffer states -->
              {% if state.buffer_column %}
                {% with subcolumns=state.get_subcolumns %}
                {% for substate_choice in subcolumns %}
                <td class="kanban_column policies_cell buffer_column sketchy_top_solid_border {% if forloop.counter == 1 %}sketchy_right_dashed_border{% else %}sketchy_right_solid_border{% endif %}" colspan="1">
                  <div class="column-policies column-policies-content">
                    <div class="policies-list" id="policies-{{state.name|slugify}}-{{substate_choice|slugify}}">
                      <!-- Policies will be loaded here -->
                    </div>
                    <div class="policy-form" id="form-{{state.name|slugify}}-{{substate_choice|slugify}}">
                      <input type="text" placeholder="Enter new policy..." class="policy-input">
                      <div class="policy-form-buttons">
                        <button class="btn-save-policy" onclick="savePolicy('{{state.name|slugify}}-{{substate_choice|slugify}}')">Save</button>
                        <button class="btn-cancel-policy" onclick="cancelPolicy('{{state.name|slugify}}-{{substate_choice|slugify}}')">Cancel</button>
                      </div>
                    </div>
                    <button class="add-policy-btn" onclick="showAddPolicy('{{state.name|slugify}}-{{substate_choice|slugify}}')" aria-label="Add policy" title="Add policy">+</button>
                  </div>
                </td>
                {% endfor %}
                {% endwith %}
              {% else %}
              <td class="kanban_column policies_cell normal_column sketchy_right_solid_border sketchy_top_solid_border" colspan="1">
                <div class="column-policies column-policies-content">
                  <div class="policies-list" id="policies-{{state.name|slugify}}">
                    <!-- Policies will be loaded here -->
                  </div>
                  <div class="policy-form" id="form-{{state.name|slugify}}">
                    <input type="text" placeholder="Enter new policy..." class="policy-input">
                    <div class="policy-form-buttons">
                      <button class="btn-save-policy" onclick="savePolicy('{{state.name|slugify}}')">Save</button>
                      <button class="btn-cancel-policy" onclick="cancelPolicy('{{state.name|slugify}}')">Cancel</button>
                    </div>
                  </div>
                  <button class="add-policy-btn" onclick="showAddPolicy('{{state.name|slugify}}')" aria-label="Add policy" title="Add policy">+</button>
                </div>
              </td>
              {% endif %}
            {% endfor %}
          </tr>

          <!-- General Policies as last full-width row -->
          <tr class="general_policies_row">
            <!-- swimlane placeholder cell -->
            <td class="placeholder_column">
              <div class="swimlane_title general-policies-tab">General Policies</div>
            </td>
            <!-- single cell spanning all board columns for general policies -->
            <td class="general_policies_cell sketchy_left_solid_border sketchy_right_solid_border sketchy_top_solid_border" colspan="100">
              <div class="common-policies-section mt-2">
                <div class="policies-header-common d-flex justify-content-between align-items-center mb-2">
                  <h6 class="m-0">General Policies</h6>
                  <button class="add-general-policy-btn" onclick="showAddGeneralPolicy()" aria-label="Add general policies" title="Add general policies">+ Add general policies</button>
                </div>
                <div class="common-policies-content">
                  <div class="policies-list" id="general-policies-list"></div>
                  <div class="policy-form" id="general-policy-form">
                    <input type="text" placeholder="Enter new general policy..." class="policy-input">
                    <div class="policy-form-buttons">
                      <button class="btn-save-policy" onclick="saveGeneralPolicy()">Save</button>
                      <button class="btn-cancel-policy" onclick="cancelGeneralPolicy()">Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          
          <!-- end of display -->
        </tbody>


      </table>

      </div>
    </div>
  </div>
</div>




<!-- Card Detail Modal -->
<div class="modal fade" id="cardDetailModal" tabindex="-1" aria-labelledby="cardDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" style="max-width: 60vw;">
    <div class="modal-content" style="height: 50vh;">
      <!-- Modal Header with title and close button -->
      <div class="modal-header">
        <h5 class="modal-title" id="cardDetailModalLabel">Card Details</h5>
        <div class="d-flex align-items-center">
          <!-- View/Edit Toggle Button -->
          <div class="form-check form-switch me-3">
            <input class="form-check-input" type="checkbox" id="editModeToggle">
            <label class="form-check-label" for="editModeToggle">Edit Mode</label>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      
      <!-- Modal Body - View Mode -->
      <div class="modal-body" id="viewModeContent">
        <div class="row">
          <div class="col-md-8">
            <!-- Card description -->
            <div class="card-description-panel mb-3">
              <h6 class="info-header">Description</h6>
              <div class="card-description-display p-2" id="cardDescriptionDisplay">
                This is a sample description for the card. It outlines what needs to be done, acceptance criteria, and other relevant details. The description can contain multiple paragraphs and can be formatted as needed.
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <!-- Card details -->
            <div class="card-info-panel">
              <h6 class="info-header">Details</h6>
              <div class="row mb-2">
                <div class="col-5 text-muted">ID:</div>
                <div class="col-7" id="cardIdDisplay">12345</div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-muted">Priority:</div>
                <div class="col-7" id="cardPriorityDisplay">
                  <span class="priority-tag priority-High">High</span>
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-muted">Size:</div>
                <div class="col-7" id="cardSizeDisplay">Medium</div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-muted">Release:</div>
                <div class="col-7" id="cardReleaseDisplay">v2.1</div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-muted">Iteration:</div>
                <div class="col-7" id="cardIterationDisplay">Sprint 4</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal Body - Edit Mode -->
      <div class="modal-body" id="editModeContent" style="display: none;">
        <div class="row">
          <div class="col-md-8">
            <!-- Title field -->
            <div class="mb-3">
              <label for="cardTitleEdit" class="form-label">Title</label>
              <input type="text" class="form-control" id="cardTitleEdit" value="Sample Card Title">
            </div>
            
            <!-- Description field -->
            <div class="mb-3">
              <label for="cardDescriptionEdit" class="form-label">Description</label>
              <textarea class="form-control" id="cardDescriptionEdit" rows="6">This is a sample description for the card. It outlines what needs to be done, acceptance criteria, and other relevant details. The description can contain multiple paragraphs and can be formatted as needed.</textarea>
            </div>
          </div>
          <div class="col-md-4">
            <!-- Priority field -->
            <div class="mb-3">
              <label for="cardPriorityEdit" class="form-label">Priority</label>
              <select class="form-select" id="cardPriorityEdit">
                <option value="Low">Low</option>
                <option value="Normal">Normal</option>
                <option value="Medium">Medium</option>
                <option value="High" selected>High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
            
            <!-- Size field -->
            <div class="mb-3">
              <label for="cardSizeEdit" class="form-label">Size</label>
              <select class="form-select" id="cardSizeEdit">
                <option value="Small">Small</option>
                <option value="Medium" selected>Medium</option>
                <option value="Large">Large</option>
                <option value="X-Large">X-Large</option>
              </select>
            </div>
            
            <!-- Release field -->
            <div class="mb-3">
              <label for="cardReleaseEdit" class="form-label">Release</label>
              <input type="text" class="form-control" id="cardReleaseEdit" value="v2.1">
            </div>
            
            <!-- Iteration field -->
            <div class="mb-3">
              <label for="cardIterationEdit" class="form-label">Iteration</label>
              <input type="text" class="form-control" id="cardIterationEdit" value="Sprint 4">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer with action buttons -->
      <div class="modal-footer">
        <!-- View Mode Buttons -->
        <div id="viewModeButtons">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Add Comment</button>
        </div>
        
        <!-- Edit Mode Buttons -->
        <div id="editModeButtons" style="display: none;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="saveCardChanges">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- End: Design Kanban Board -->

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js" 
integrity="sha512-ekwRoEshEqHU64D4luhOv/WNmhml94P8X5LnZd9FNOiOfSKgkY12cDFz3ZC6Ws+7wjMPQ4bPf94d+zZ3cOjlig==" 
crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      setupDragAndDrop();
      countAllCards();
      addNotificationContainer();
      // Initialize CoS badge toggle
      const cosToggle = document.getElementById('toggleCosBadges');
      if (cosToggle) {
        const apply = () => {
          const show = cosToggle.checked;
          document.querySelectorAll('.cos-badge').forEach(el => el.style.display = show ? 'inline-block' : 'none');
        };
        cosToggle.addEventListener('change', apply);
        apply();
      }
    });
  let draggedCard = null;
  let originalFromSwimlaneId = null;
    let originalFromColumn = null;
    let originalFromStateId = null;
    let originalFromColumnName = null;
// Add the notification container to the DOM
function addNotificationContainer() {
  const notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  notificationContainer.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 350px;
  `;
  document.body.appendChild(notificationContainer);
}

// Create and show a notification
function showNotification(message) {
  // Ensure container exists
  if (!document.getElementById('notification-container')) {
    addNotificationContainer();
  }
  
  const container = document.getElementById('notification-container');
  
  // Create notification element
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.style.cssText = `
    background-color: #007bff;
    color: white;
    padding: 12px 16px;
    margin-bottom: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    opacity: 0.8;
    transition: opacity 0.3s;
    font-size: 14px;
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    max-width: 40vw;
    text-align: center;
  `;
  
  // Add message
  notification.textContent = message;
  
  // Add to container
  container.appendChild(notification);
  
  // Fade in
  setTimeout(() => {
    notification.style.opacity = '1';
  }, 10);
  
  // Fade out and remove after 3 seconds
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300); // Wait for fade out animation
  }, 3000);
}
function handleDragStart(e) {
  draggedCard = this;
  originalFromColumn = this.closest('.kanban_column');
  originalFromStateId = originalFromColumn.dataset.stateId || originalFromColumn.id;
  originalFromColumnName = originalFromColumn.dataset.columnName || originalFromColumn.className;
  originalFromSwimlaneId = (originalFromColumn && originalFromColumn.dataset && originalFromColumn.dataset.swimlaneId) ? originalFromColumn.dataset.swimlaneId : null;
  
  this.classList.add('dragging');
  e.dataTransfer.setData('text/plain', this.id);
  e.dataTransfer.effectAllowed = 'move';
  
  console.log('Drag started for card:', this.id, 'from column:', originalFromColumnName);
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
  
  document.querySelectorAll('.kanban_column').forEach(column => {
    column.classList.remove('drag-over');
  });
  
  setTimeout(countAllCards, 100);
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.preventDefault();
  let destColumn = this;
  // Track intended swimlane id (for placeholder backlog drops)
  let intendedSwimlaneId = null;
  // If dropping into a placeholder backlog (swimlane backlog cell), redirect to the single General backlog container
  if (destColumn.classList.contains('backlog_column') && destColumn.hasAttribute('data-placeholder-backlog')) {
    // Preserve the swimlane target while redirecting to General backlog container
    intendedSwimlaneId = destColumn.dataset.swimlaneId || null;
    const generalBacklog = document.querySelector('.backlog_column.kanban_column[data-general-backlog="true"]');
    if (generalBacklog) destColumn = generalBacklog;
  }
  if (draggedCard) {
    const closestCard = getClosestCard(this, e.clientY);
    const currentCards = Array.from(destColumn.querySelectorAll('.card'));
    let insertIndex = -1;
    insertIndex = currentCards.indexOf(closestCard);
    if (closestCard) {
      const rect = closestCard.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      if (e.clientY > midpoint) {
        insertIndex++;
      }
      if (e.clientY < midpoint) {
        this.insertBefore(draggedCard, closestCard);
      } else {
        if (closestCard.nextElementSibling) {
          this.insertBefore(draggedCard, closestCard.nextElementSibling);
        } else {
          this.appendChild(draggedCard);
        }
      }
    } else {
      this.appendChild(draggedCard);
    }
    
    
  const toStateId = destColumn.dataset.stateId || destColumn.id;
  const toSwimlaneIdRaw = destColumn.dataset.swimlaneId;
  let toSwimlaneId = (toSwimlaneIdRaw === undefined) ? null : (toSwimlaneIdRaw === 'null' ? null : toSwimlaneIdRaw);
  // If we redirected from a lane placeholder backlog, use its lane id as destination lane
  if (intendedSwimlaneId !== null) {
    toSwimlaneId = intendedSwimlaneId === 'null' ? null : intendedSwimlaneId;
  }
    
    const isBufferColumn = destColumn.classList.contains('buffer_column');
    let substate = null;
    
    if (isBufferColumn) {
      const columnName = destColumn.dataset.columnName;
      if (columnName && columnName.includes('_')) {
        substate = columnName.split('__')[1];
      }
    }
    
  const destCards = Array.from(destColumn.querySelectorAll('.card'));
    // Create formatted positions array
    let formattedPositions = [];
    
    // Special handling for backlog
  if (destColumn.classList.contains('backlog_column')) {
      formattedPositions = destCards.map((card, index) => {
        return {
          card_id: card.id,
          position: index + 1
        };
      });
    } else {
      formattedPositions = destCards.map((card, index) => {
        return {
          card_id: card.id,
          position: index + 1
        };
      });
    }
    const destPositions = formattedPositions;
    const projectId = '{{ project.id }}';
    const boardId = '{{ project_board.id }}';
    const card = draggedCard;
    const cardId = draggedCard.id;
    const cardTitle = draggedCard.innerText;
    const toColumnName = destColumn.dataset.columnName || destColumn.className;
    var fromColumnName = originalFromColumnName;
    var fromSubColumnName = "";
    var fromBufferColumn = false;

    // Single atomic update: pass swimlaneId to the server along with the state move
    updateCardState(
      cardId,
      originalFromStateId,
      toStateId,
      destPositions,
      destColumn.dataset.columnName || destColumn.className,
      projectId,
      boardId,
      originalFromColumnName,
      toSwimlaneId
    );
    
    if (isBufferColumn && substate) {
      updateCardSubstate(draggedCard.id, toStateId, substate);
    }

    // Show notification
    if (originalFromColumnName && originalFromColumnName.includes('__')) {
      fromColumnName = originalFromColumnName.split('__')[0];
      fromSubColumnName = originalFromColumnName.split('__')[1];
      fromBufferColumn = true;
    }
    let notificationMsg = "";
    if (fromBufferColumn) {
      notificationMsg += `Card #${cardId}:  Moved from ${fromColumnName} / ${fromSubColumnName}`;
    } else {
      notificationMsg += `Card #${cardId}:  Moved from ${fromColumnName}`;
    }
    
    if (isBufferColumn) {
      notificationMsg += ` to ${toColumnName.split('__')[0]} / ${substate || 'None'}`;
    } else {
      notificationMsg += ` to ${toColumnName}`;
    }
    showNotification(notificationMsg);
    setTimeout(countAllCards, 100);
  }
  
  this.classList.remove('drag-over');
  
  return false;
}

function setupDragAndDrop() {
  const cards = document.querySelectorAll('.card[draggable="true"]');
  // All kanban columns are droppable; when dropping on a placeholder backlog we'll redirect to the General backlog
  const dropTargets = Array.from(document.querySelectorAll('.kanban_column:not(.policies_cell)'));

  cards.forEach(card => {
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
  });
  
  dropTargets.forEach(column => {
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('dragenter', handleDragEnter);
    column.addEventListener('dragleave', handleDragLeave);
    column.addEventListener('drop', handleDrop);
  });
}





function handleDragEnter(e) {
  // Add a class to highlight valid drop target
  this.classList.add('drag-over');
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}


function getStateIdFromColumn(column) {
  return column.dataset.stateId || column.id;
}


function getClosestCard(column, mouseY) {
  const cards = Array.from(column.querySelectorAll('.card'));
  
  if (cards.length === 0) return null;
  
  let closestCard = null;
  let closestDistance = Infinity;
  
  cards.forEach(card => {
    if (card === draggedCard) return; // Skip the dragged card itself
    
    const rect = card.getBoundingClientRect();
    const cardY = rect.top + rect.height / 2; // Y coordinate of card center
    const distance = Math.abs(mouseY - cardY);
    
    if (distance < closestDistance) {
      closestDistance = distance;
      closestCard = card;
    }
  });
  
  return closestCard;
}

// Also update the mouse feedback CSS to show insertion position
const style1 = document.createElement('style');
style1.textContent = `
  .card.dragging {
    opacity: 0.4;
  }
  
  .card.insert-above {
    border-top: 2px solid #007bff;
  }
  
  .card.insert-below {
    border-bottom: 2px solid #007bff;
  }
`;
document.head.appendChild(style1);

// Add some CSS for drag and drop visual feedback
const style = document.createElement('style');
style.textContent = `
  .card.dragging {
    opacity: 0.4;
  }
  
 
`;
document.head.appendChild(style);
// Add these functions to show visual indicator for insertion position
function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault(); // Necessary to allow drop
  }
  
  e.dataTransfer.dropEffect = 'move';
  
  // Clear all insertion indicators
  document.querySelectorAll('.card.insert-above, .card.insert-below').forEach(card => {
    card.classList.remove('insert-above', 'insert-below');
  });
  
  // Find the closest card and show insertion indicator
  const column = this;
  const closestCard = getClosestCard(column, e.clientY);
  
  if (closestCard && closestCard !== draggedCard) {
    const rect = closestCard.getBoundingClientRect();
    const midpoint = rect.top + rect.height / 2;
    
    if (e.clientY < midpoint) {
      closestCard.classList.add('insert-above');
    } else {
      closestCard.classList.add('insert-below');
    }
  }
  
  return false;
}

function countAllCards() {
  console.log('Counting cards in all columns...');
  
  // Default WIP limit for sub-columns
  const DEFAULT_SUBCOLUMN_WIP_LIMIT = 2;
  
  // 1. Backlog column (first column)
  const backlogColumn = document.querySelector('.backlog_column.kanban_column[data-general-backlog="true"]');
  const backlogCountEl = document.querySelector('.backlog_column.count_column .count_wip');
  
  if (backlogColumn && backlogCountEl) {
    const backlogCards = backlogColumn.querySelectorAll('.card').length;
    // Get just the limit part
    const limitPart = '∞';
    backlogCountEl.textContent = backlogCards + '/' + limitPart;
    console.log('Backlog count: ' + backlogCards + '/' + limitPart);
  }
  
  // 2. Process all normal columns
  const normalColumns = document.querySelectorAll('.normal_column');
  normalColumns.forEach((column, idx) => {
    // Find the corresponding count display
    const normalCountEls = document.querySelectorAll('.count_column:not(.backlog_column):not([colspan="2"]) .count_wip');
    
    if (idx < normalCountEls.length) {
      const countEl = normalCountEls[idx];
      const cardCount = column.querySelectorAll('.card').length;
      
      // Extract just the limit part from the original text
      let originalText = countEl.textContent.trim();
      let limitPart = '∞';
      
      if (originalText.includes('/')) {
        limitPart = originalText.split('/')[1];
      } else {
        limitPart = originalText;
      }
      
      // Update the count display
      countEl.textContent = cardCount + '/' + limitPart;
      
      // Highlight if over limit
      if (limitPart !== '∞' && cardCount > parseInt(limitPart)) {
        countEl.style.color = 'red';
      } else {
        countEl.style.color = '#707070';
      }
      
      console.log('Normal column ' + idx + ' count: ' + cardCount + '/' + limitPart);
    }
  });
  
  // 3. Process all buffer column sets (parent columns)
  const bufferCountEls = document.querySelectorAll('.count_column[colspan="2"] .count_wip');
  bufferCountEls.forEach((countEl, idx) => {
    // Find corresponding buffer columns
    const bufferCols = document.querySelectorAll('.buffer_column.kanban_column');
    let cardCount = 0;
    
    // Calculate which buffer columns correspond to this count element
    const startIdx = idx * 2;
    if (startIdx < bufferCols.length) {
      cardCount += bufferCols[startIdx].querySelectorAll('.card').length;
      
      if (startIdx + 1 < bufferCols.length) {
        cardCount += bufferCols[startIdx + 1].querySelectorAll('.card').length;
      }
    }
    
    // Extract just the limit part from the original text
    let originalText = countEl.textContent.trim();
    let limitPart = '∞';
    
    if (originalText.includes('/')) {
      limitPart = originalText.split('/')[1];
    } else {
      limitPart = originalText;
    }
    
    // Update the count display
    countEl.textContent = cardCount + '/' + limitPart;
    
    // Highlight if over limit
    if (limitPart !== '∞' && cardCount > parseInt(limitPart)) {
      countEl.style.color = 'red';
    } else {
      countEl.style.color = '#707070';
    }
    
    console.log('Buffer column set ' + idx + ' count: ' + cardCount + '/' + limitPart);
  });
  
  // 4. Process individual buffer sub-columns in the fourth row
  const bufferSubColumns = document.querySelectorAll('.buffer_sub_column .count_wip');
  const kanbanBufferColumns = document.querySelectorAll('.buffer_column.kanban_column');
  
  bufferSubColumns.forEach((subColCountEl, idx) => {
    if (idx < kanbanBufferColumns.length) {
      // Count cards in this specific buffer sub-column
      const cardCount = kanbanBufferColumns[idx].querySelectorAll('.card').length;
      
      // Update the count display with default sub-column WIP limit
      subColCountEl.textContent = cardCount + '/' + DEFAULT_SUBCOLUMN_WIP_LIMIT;
      
      // Highlight if over limit
      if (cardCount > DEFAULT_SUBCOLUMN_WIP_LIMIT) {
        subColCountEl.style.color = 'red';
      } else {
        subColCountEl.style.color = '#707070';
      }
      
      console.log('Buffer sub-column ' + idx + ' count: ' + cardCount + '/' + DEFAULT_SUBCOLUMN_WIP_LIMIT);
    }
  });
}

</script>

  
<script>
  // Helper still available if needed elsewhere
  function updateCardSwimlane(id, swimlaneId) {
    if (id && id.startsWith('temp-')) return;
    let formData = new FormData();
    formData.append('id', id);
    formData.append('model_name', 'ProjectBoardCard');
    formData.append('app_name', 'app_organization');
    formData.append('field_name', 'swimlane');
    formData.append('new_value', swimlaneId === null ? '' : swimlaneId);
    return fetch('/common/common_ajax/ajax_update_app_model_field_value/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: formData });
  }

function updateCardState(cardId, fromStateId, toStateId, destPositions, destColumn, projectId, boardId, fromColumn, swimlaneId = null, extra = {}) {
    const isNewCard = cardId && cardId.startsWith("temp-");
      console.log("EXTRA ", extra);
  return fetch("{% url 'ajax_update_project_board_card_state' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
    body: JSON.stringify({
            card_id: isNewCard ? null : cardId,
            temp_id: isNewCard ? cardId : null,
            from_state_id: fromStateId,
            to_state_id: toStateId,
            positions: destPositions,
            dest_column: destColumn,
            project_id: projectId,
            board_id: boardId,
            from_column: fromColumn,
      swimlane_id: swimlaneId,
            is_new_card: isNewCard,
            title: extra.title || "Added Card",
            priority: extra.priority || "Normal",
            substate: extra.substate || ""
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error:", data.error);
        } else {
            console.log("Card update success:", data);

            // If this was a new card, update the DOM element with real ID
            if (isNewCard && data.card_id) {
                const newCardElement = document.getElementById(cardId);
                if (newCardElement) {
                    newCardElement.id = data.card_id;
                }
            }
        }
    })
    .catch(error => {
        console.error("Update card state error:", error);
    });
}

  function updateCardSubstate(id, stateId, subState) {
      // Skip for temporary cards
      if (id && id.startsWith("temp-")) {
          return;
      }
      
      console.log(`Updating substate for Card ${id} -> ${subState}`);

      let formData = new FormData();
      formData.append("id", id);
      formData.append("model_name", "ProjectBoardCard");
      formData.append("app_name", "app_organization");
      formData.append("field_name", "substate");
      formData.append("new_value", subState);

      fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
          method: "POST",
          headers: {
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: formData
      })
      .then(response => response.json())
      .then(data => {
          if (data.error) {
              console.error("Error:", data.error);
          } else {
              console.log("Substate Update Success:", data);
          }
      })
      .catch(error => {
          console.error("Error:", error);
      });
  }

  
</script>




<script>
 // Card modal functionality
document.addEventListener('DOMContentLoaded', function() {
  // Initialize modal and setup event handlers
  initCardModal();
  addCardDoubleClickHandlers();
});

// Global variables
let cardDetailModal = null;
let currentCardId = null;

// Initialize the modal functionality
function initCardModal() {
  const modalElement = document.getElementById('cardDetailModal');
  if (!modalElement) {
    console.error('Modal element not found');
    return;
  }

  // Initialize the Bootstrap modal
  cardDetailModal = new bootstrap.Modal(modalElement);

  // Add event listener for the edit mode toggle
  const editModeToggle = document.getElementById('editModeToggle');
  if (editModeToggle) {
    editModeToggle.addEventListener('change', function() {
      toggleEditMode(this.checked);
    });
  }

  // Add event listener for the save button
  const saveButton = document.getElementById('saveCardChanges');
  if (saveButton) {
    saveButton.addEventListener('click', function() {
      saveCardChanges();
    });
  }
}

// Toggle between view and edit modes
function toggleEditMode(isEditMode) {
  document.getElementById('viewModeContent').style.display = isEditMode ? 'none' : 'block';
  document.getElementById('editModeContent').style.display = isEditMode ? 'block' : 'none';
  document.getElementById('viewModeButtons').style.display = isEditMode ? 'none' : 'block';
  document.getElementById('editModeButtons').style.display = isEditMode ? 'block' : 'none';
  
  if (isEditMode) {
    // Copy data from view mode to edit mode
    document.getElementById('cardTitleEdit').value = document.getElementById('cardDetailModalLabel').textContent;
    document.getElementById('cardDescriptionEdit').value = document.getElementById('cardDescriptionDisplay').textContent.trim();
    
    // Copy priority
    const priorityText = document.querySelector('#cardPriorityDisplay .priority-tag').textContent;
    selectOptionByValue('cardPriorityEdit', priorityText);
    
    // Copy size
    const sizeText = document.getElementById('cardSizeDisplay').textContent;
    selectOptionByValue('cardSizeEdit', sizeText);
    
    // Copy release and iteration
    document.getElementById('cardReleaseEdit').value = document.getElementById('cardReleaseDisplay').textContent;
    document.getElementById('cardIterationEdit').value = document.getElementById('cardIterationDisplay').textContent;
  }
}

// Helper to select an option in a select element by value
function selectOptionByValue(selectId, value) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value === value) {
      select.options[i].selected = true;
      break;
    }
  }
}

// Add double-click handlers to all cards
function addCardDoubleClickHandlers() {
  const cards = document.querySelectorAll('.card');
  
  cards.forEach(card => {
    // Check if the card already has the double-click handler
    if (!card._hasDoubleClickHandler) {
      card.addEventListener('dblclick', handleCardDoubleClick);
      card._hasDoubleClickHandler = true;
    }
  });
  
  // Set up observer for new cards
  setupCardObserver();
}

// Handle double-click on a card
function handleCardDoubleClick(e) {
  e.preventDefault();
  e.stopPropagation();
  
  const card = this;
  const cardId = card.id;
  
  // Simply open the modal - all data extraction happens in the openCardModal function
  openCardModal(cardId);
}

// Observe for new cards being added to the kanban board
function setupCardObserver() {
  // Create a MutationObserver to watch for new cards
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length) {
        mutation.addedNodes.forEach(function(node) {
          // Check if the added node is a card and doesn't have a handler yet
          if (node.classList && node.classList.contains('card') && !node._hasDoubleClickHandler) {
            node.addEventListener('dblclick', handleCardDoubleClick);
            node._hasDoubleClickHandler = true;
          }
        });
      }
    });
  });
  
  // Start observing the kanban columns for new cards
  const kanbanColumns = document.querySelectorAll('.kanban_column');
  kanbanColumns.forEach(column => {
    observer.observe(column, { childList: true });
  });
}

// Open the card modal with data extracted directly from the card element
function openCardModal(id) {
  if (!cardDetailModal) {
    console.error("Modal not initialized");
    return;
  }
  
  // Store the current card ID
  currentCardId = id;
  
  // Extract all data directly from the card element
  fetchCardDetails(id);
  
  // Reset to view mode
  document.getElementById('editModeToggle').checked = false;
  document.getElementById('viewModeContent').style.display = 'block';
  document.getElementById('editModeContent').style.display = 'none';
  document.getElementById('viewModeButtons').style.display = 'block';
  document.getElementById('editModeButtons').style.display = 'none';
  
  // Show the modal
  cardDetailModal.show();
}

// Fetch card details directly from the card element
function fetchCardDetails(cardId) {
  // Find the card element in the DOM
  const cardElement = document.getElementById(cardId);
  if (!cardElement) {
    console.error('Card element not found:', cardId);
    return;
  }
  
  // Extract data from the card's data attributes and content
  const title = cardElement.querySelector('.card_title')?.textContent.trim() || '';
  const description = cardElement.querySelector('.card_description')?.textContent.trim() || '';
  
  // Get priority from data attribute or CSS class
  let priority = cardElement.dataset.priority || '';
  if (!priority) {
    if (cardElement.classList.contains('Critical')) priority = 'Critical';
    else if (cardElement.classList.contains('High')) priority = 'High';
    else if (cardElement.classList.contains('Medium')) priority = 'Medium';
    else if (cardElement.classList.contains('Low')) priority = 'Low';
    else priority = 'Normal';
  }
  
  const size = cardElement.dataset.size || 'Medium';
  const release = cardElement.dataset.release || '';
  const iteration = cardElement.dataset.iteration || '';
  
  // Update the modal with the extracted data
  document.getElementById('cardIdDisplay').textContent = cardId;
  document.getElementById('cardDetailModalLabel').textContent = title;
  document.getElementById('cardDescriptionDisplay').textContent = description || 'No description available.';
  document.getElementById('cardPriorityDisplay').innerHTML = `<span class="priority-tag priority-${priority}">${priority}</span>`;
  document.getElementById('cardSizeDisplay').textContent = size;
  document.getElementById('cardReleaseDisplay').textContent = release;
  document.getElementById('cardIterationDisplay').textContent = iteration;
  
  // Return the data for potential additional use
  return {
    title: title,
    description: description,
    priority: priority,
    size: size,
    release: release,
    iteration: iteration
  };
}

// Save changes to the card
function saveCardChanges() {
  if (!currentCardId) {
    console.error('No card ID set');
    return;
  }
  
  // Get the updated values from the form
  const title = document.getElementById('cardTitleEdit').value;
  const description = document.getElementById('cardDescriptionEdit').value;
  const priority = document.getElementById('cardPriorityEdit').value;
  const size = document.getElementById('cardSizeEdit').value;
  const release = document.getElementById('cardReleaseEdit').value;
  const iteration = document.getElementById('cardIterationEdit').value;
  
  // Update the view mode content in the modal
  document.getElementById('cardDetailModalLabel').textContent = title;
  document.getElementById('cardDescriptionDisplay').textContent = description;
  document.getElementById('cardPriorityDisplay').innerHTML = `<span class="priority-tag priority-${priority}">${priority}</span>`;
  document.getElementById('cardSizeDisplay').textContent = size;
  document.getElementById('cardReleaseDisplay').textContent = release;
  document.getElementById('cardIterationDisplay').textContent = iteration;
  
  // Update the card in the DOM
  updateCardInDOM(currentCardId, title, description, priority, size, release, iteration);
  
  // Save to server using your existing API functions
  saveCardToServer(currentCardId, {
    title: title,
    description: description,
    priority: priority,
    size: size,
    release: release,
    iteration: iteration
  });
  
  // Switch back to view mode
  document.getElementById('editModeToggle').checked = false;
  toggleEditMode(false);
  
  // Show success notification
  showNotification('Card updated successfully');
}

// Update the card in the DOM with the new data
function updateCardInDOM(cardId, title, description, priority, size, release, iteration) {
  const card = document.getElementById(cardId);
  if (!card) return;
  
  // Update card content
  const titleElement = card.querySelector('.card_title');
  if (titleElement) {
    titleElement.textContent = title;
  } else {
    // If there's no title element, update the entire card text
    card.textContent = title;
  }
  
  // Update description if it exists
  const descriptionElement = card.querySelector('.card_description');
  if (descriptionElement) {
    descriptionElement.textContent = description;
  }
  
  // Update priority class
  ['Critical', 'High', 'Medium', 'Low', 'Normal'].forEach(p => {
    card.classList.remove(p);
  });
  card.classList.add(priority);
  
  // Update data attributes
  card.dataset.priority = priority;
  card.dataset.size = size;
  card.dataset.release = release;
  card.dataset.iteration = iteration;
  
  // If card has priority tag, update it
  if (card.querySelector('.card-tag.priority')) {
    card.querySelector('.card-tag.priority').textContent = priority;
  }
}

// Save card data to server
function saveCardToServer(cardId, data) {
  // Create FormData for the title
  const titleFormData = new FormData();
  titleFormData.append("id", cardId);
  titleFormData.append("model_name", "Backlog");
  titleFormData.append("app_name", "app_organization");
  titleFormData.append("field_name", "name");
  titleFormData.append("new_value", data.title);
  
  // Create FormData for the description
  const descFormData = new FormData();
  descFormData.append("id", cardId);
  descFormData.append("model_name", "Backlog");
  descFormData.append("app_name", "app_organization");
  descFormData.append("field_name", "description");
  descFormData.append("new_value", data.description);
  
  // Create FormData for the priority
  const priorityFormData = new FormData();
  priorityFormData.append("id", cardId);
  priorityFormData.append("model_name", "Backlog");
  priorityFormData.append("app_name", "app_organization");
  priorityFormData.append("field_name", "priority");
  priorityFormData.append("new_value", data.priority);
  
  // Create FormData for size
  const sizeFormData = new FormData();
  sizeFormData.append("id", cardId);
  sizeFormData.append("model_name", "Backlog");
  sizeFormData.append("app_name", "app_organization");
  sizeFormData.append("field_name", "size");
  sizeFormData.append("new_value", data.size);
  
  // Create FormData for release
  const releaseFormData = new FormData();
  releaseFormData.append("id", cardId);
  releaseFormData.append("model_name", "Backlog");
  releaseFormData.append("app_name", "app_organization");
  releaseFormData.append("field_name", "release");
  releaseFormData.append("new_value", data.release);
  
  // Create FormData for iteration
  const iterationFormData = new FormData();
  iterationFormData.append("id", cardId);
  iterationFormData.append("model_name", "Backlog");
  iterationFormData.append("app_name", "app_organization");
  iterationFormData.append("field_name", "iteration");
  iterationFormData.append("new_value", data.iteration);
  
  // Chain promises to update each field
  return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
    method: "POST",
    headers: {
      "X-CSRFToken": '{{ csrf_token }}'
    },
    body: titleFormData
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating title:", data.error);
    }
    
    // Update description
    return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
      method: "POST",
      headers: {
        "X-CSRFToken": '{{ csrf_token }}'
      },
      body: descFormData
    });
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating description:", data.error);
    }
    
    // Update priority
    return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
      method: "POST",
      headers: {
        "X-CSRFToken": '{{ csrf_token }}'
      },
      body: priorityFormData
    });
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating priority:", data.error);
    }
    
    // Update size
    return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
      method: "POST",
      headers: {
        "X-CSRFToken": '{{ csrf_token }}'
      },
      body: sizeFormData
    });
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating size:", data.error);
    }
    
    // Update release
    return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
      method: "POST",
      headers: {
        "X-CSRFToken": '{{ csrf_token }}'
      },
      body: releaseFormData
    });
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating release:", data.error);
    }
    
    // Update iteration
    return fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
      method: "POST",
      headers: {
        "X-CSRFToken": '{{ csrf_token }}'
      },
      body: iterationFormData
    });
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      console.error("Error updating iteration:", data.error);
    }
    
    console.log("All card fields updated successfully");
  })
  .catch(error => {
    console.error("Error updating card:", error);
  });
}
</script>

<!-- Column Policies Management JavaScript -->
<!-- Resolve named URLs before entering script to avoid JS parser errors in editors -->
{% url 'ajax_list_policies' as ajax_list_policies_url %}
{% url 'ajax_create_column_policy' as ajax_create_column_policy_url %}
{% url 'ajax_update_column_policy' as ajax_update_column_policy_url %}
{% url 'ajax_delete_column_policy' as ajax_delete_column_policy_url %}
{% url 'ajax_reorder_column_policies' as ajax_reorder_column_policies_url %}
{% url 'ajax_create_general_policy' as ajax_create_general_policy_url %}
{% url 'ajax_update_general_policy' as ajax_update_general_policy_url %}
{% url 'ajax_delete_general_policy' as ajax_delete_general_policy_url %}
<script>
// Backend-driven policies (no browser storage)
const policyBoardId = '{{ project_board.id }}';
const columnPoliciesData = {}; // { columnKey: [{id, text, position}] }
let generalPolicies = []; // [{id, text, position}]

const __policyBase = '/org/org_board/ajax_policies';
const __fallback = (u, f) => (u && u.length ? u : f);

const ajaxPolicies = {
  list: __fallback("{{ ajax_list_policies_url }}", `${__policyBase}/list/`),
  column: {
    create: __fallback("{{ ajax_create_column_policy_url }}", `${__policyBase}/column/create/`),
    update: __fallback("{{ ajax_update_column_policy_url }}", `${__policyBase}/column/update/`),
    delete: __fallback("{{ ajax_delete_column_policy_url }}", `${__policyBase}/column/delete/`),
    reorder: __fallback("{{ ajax_reorder_column_policies_url }}", `${__policyBase}/column/reorder/`)
  },
  general: {
    create: __fallback("{{ ajax_create_general_policy_url }}", `${__policyBase}/general/create/`),
    update: __fallback("{{ ajax_update_general_policy_url }}", `${__policyBase}/general/update/`),
    delete: __fallback("{{ ajax_delete_general_policy_url }}", `${__policyBase}/general/delete/`)
  }
};

document.addEventListener('DOMContentLoaded', function() {
  setupColumnPoliciesToggle();
  fetch(`${ajaxPolicies.list}?board_id=${policyBoardId}`)
    .then(r => r.json())
    .then(data => {
      if (data && data.success) {
        Object.keys(data.columns || {}).forEach(key => {
          columnPoliciesData[key] = (data.columns[key] || []).map(p => ({ id: p.id, text: p.text, position: p.position }));
        });
        generalPolicies = (data.general || []).map(p => ({ id: p.id, text: p.text, position: p.position }));
      }
    })
    .finally(() => {
      initializeColumnPolicies();
      initializeGeneralPolicies();
    });
});

function initializeColumnPolicies() {
  const policyContainers = document.querySelectorAll('[id^="policies-"]');
  policyContainers.forEach(container => {
    const columnName = container.id.replace('policies-', '');
    if (!columnPoliciesData[columnName]) columnPoliciesData[columnName] = [];
    displayColumnPolicies(columnName);
  });
}

function setupColumnPoliciesToggle() {
  const checkbox = document.getElementById('showColumnPolicies');
  const policyContainers = document.querySelectorAll('.column-policies-content');
  const isVisible = true; // default visible, not persisted
  if (checkbox) checkbox.checked = isVisible;
  policyContainers.forEach(c => c.style.display = isVisible ? 'block' : 'none');
  if (checkbox) checkbox.addEventListener('change', function() {
    const display = this.checked ? 'block' : 'none';
    policyContainers.forEach(c => c.style.display = display);
  });
}

function displayColumnPolicies(columnName) {
  const container = document.getElementById(`policies-${columnName}`);
  if (!container) return;
  container.innerHTML = '';
  const list = columnPoliciesData[columnName] || [];
  if (list.length > 0) {
    list.forEach((policy, index) => {
      const ptext = typeof policy === 'string' ? policy : (policy.text || '');
      const pid = typeof policy === 'string' ? null : policy.id;
      const policyItem = document.createElement('div');
      policyItem.className = 'policy-item';
      policyItem.innerHTML = `
        <span class="policy-text">• ${ptext}</span>
        <div class="policy-actions">
          <button class="btn-edit-policy" onclick="editColumnPolicy('${columnName}', ${index})" title="Edit policy">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-delete-policy" onclick="showDeleteModal('${columnName}', ${index}, '${ptext.replace(/'/g, "\\'")}', ${pid !== null ? pid : 'null'})" title="Delete policy">
            <i class="fas fa-trash"></i>
          </button>
        </div>`;
      container.appendChild(policyItem);
    });
  } else {
    container.innerHTML = '<div class="policy-item"><span class="policy-text" style="color:#888;font-size:0.6rem;">No policies</span></div>';
  }
}

function showAddPolicy(columnName) {
  const form = document.getElementById(`form-${columnName}`);
  const input = form.querySelector('.policy-input');
  form.classList.add('active');
  input.value = '';
  input.focus();
  document.querySelectorAll('.policy-form').forEach(f => { if (f !== form) f.classList.remove('active'); });
}

async function savePolicy(columnName) {
  const form = document.getElementById(`form-${columnName}`);
  const input = form.querySelector('.policy-input');
  const policyText = input.value.trim();
  if (!policyText) { alert('Please enter a policy description.'); return; }
  const editIndex = form.dataset.editIndex;
  if (editIndex !== undefined) {
    const existing = columnPoliciesData[columnName][parseInt(editIndex)];
    const pid = existing && existing.id;
    if (pid) {
  await saveColumnPoliciesData({ scope: 'column', op: 'update', data: { id: pid, text: policyText } });
      existing.text = policyText;
    }
    delete form.dataset.editIndex;
  } else {
    if (!columnPoliciesData[columnName]) columnPoliciesData[columnName] = [];
  const data = await saveColumnPoliciesData({ scope: 'column', op: 'create', data: { board_id: policyBoardId, column_key: columnName, text: policyText } });
    if (data && data.success) columnPoliciesData[columnName].push({ id: data.id, text: data.text, position: 1000 });
  }
  displayColumnPolicies(columnName);
  cancelPolicy(columnName);
}

function editColumnPolicy(columnName, index) {
  const form = document.getElementById(`form-${columnName}`);
  const input = form.querySelector('.policy-input');
  form.classList.add('active');
  const policy = columnPoliciesData[columnName][index];
  input.value = typeof policy === 'string' ? policy : (policy.text || '');
  form.dataset.editIndex = index;
  input.focus();
  document.querySelectorAll('.policy-form').forEach(f => { if (f !== form) f.classList.remove('active'); });
}

// Modal & delete handling
let pendingDeleteData = null; // { type: 'column'|'general', columnName?, index?, id? }

function showDeleteModal(columnName, index, policyText, policyId=null) {
  pendingDeleteData = { type: 'column', columnName, index, id: policyId };
  document.getElementById('policyPreview').textContent = '• ' + policyText;
  document.getElementById('deletePolicyModal').style.display = 'block';
  setTimeout(() => document.addEventListener('click', handleModalClick), 100);
}

function handleModalClick(event) {
  const modal = document.getElementById('deletePolicyModal');
  const modalContent = modal.querySelector('.delete-modal-content');
  if (event.target === modal && !modalContent.contains(event.target)) {
    cancelDeletePolicy();
  }
}

async function confirmDeletePolicy() {
  if (pendingDeleteData) {
    if (pendingDeleteData.type === 'column') {
      const { columnName, index, id } = pendingDeleteData;
      if (id) {
  await saveColumnPoliciesData({ scope: 'column', op: 'delete', data: { id } });
      }
      columnPoliciesData[columnName].splice(index, 1);
      displayColumnPolicies(columnName);
    } else if (pendingDeleteData.type === 'general') {
      const { index, id } = pendingDeleteData;
      if (id) {
  await saveColumnPoliciesData({ scope: 'general', op: 'delete', data: { id } });
      }
      generalPolicies.splice(index, 1);
      renderGeneralPolicies();
    }
  }
  closeDeleteModal();
}

function cancelDeletePolicy() { closeDeleteModal(); }
function closeDeleteModal() {
  document.getElementById('deletePolicyModal').style.display = 'none';
  document.removeEventListener('click', handleModalClick);
  pendingDeleteData = null;
}

function cancelPolicy(columnName) {
  const form = document.getElementById(`form-${columnName}`);
  const input = form.querySelector('.policy-input');
  form.classList.remove('active');
  input.value = '';
  delete form.dataset.editIndex;
}

async function saveColumnPoliciesData({ scope, op, data }) {
  let url = '';
  if (scope === 'column') {
    if (op === 'create') url = ajaxPolicies.column.create;
    else if (op === 'update') url = ajaxPolicies.column.update;
    else if (op === 'delete') url = ajaxPolicies.column.delete;
    else if (op === 'reorder') url = ajaxPolicies.column.reorder;
  } else if (scope === 'general') {
    if (op === 'create') url = ajaxPolicies.general.create;
    else if (op === 'update') url = ajaxPolicies.general.update;
    else if (op === 'delete') url = ajaxPolicies.general.delete;
  }
  if (!url) throw new Error('Invalid scope/op');
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
    body: JSON.stringify(data || {})
  });
  let json = {};
  try { json = await resp.json(); } catch (e) {}
  return json;
}

// General policies
function initializeGeneralPolicies() { renderGeneralPolicies(); }

function renderGeneralPolicies() {
  const list = document.getElementById('general-policies-list');
  if (!list) return;
  list.innerHTML = '';
  if (!generalPolicies || generalPolicies.length === 0) {
    list.innerHTML = '<div class="policy-item"><span class="policy-text" style="color:#888;font-size:0.6rem;">No policies</span></div>';
    return;
  }
  generalPolicies.forEach((item, idx) => {
    const text = typeof item === 'string' ? item : (item.text || '');
    const pid = typeof item === 'string' ? null : item.id;
    const el = document.createElement('div');
    el.className = 'policy-item';
    el.innerHTML = `
      <span class="policy-text">• ${text}</span>
      <div class="policy-actions">
        <button class="btn-edit-policy" onclick="editGeneralPolicy(${idx})" title="Edit policy"><i class="fas fa-edit"></i></button>
        <button class="btn-delete-policy" onclick="showGeneralDelete(${idx}, '${"" + text.replace(/'/g, "\\'")}', ${pid !== null ? pid : 'null'})" title="Delete policy"><i class="fas fa-trash"></i></button>
      </div>`;
    list.appendChild(el);
  });
}

function showAddGeneralPolicy() {
  const form = document.getElementById('general-policy-form');
  if (!form) return;
  form.classList.add('active');
  const input = form.querySelector('.policy-input');
  input.value = '';
  input.focus();
  delete form.dataset.editIndex;
}

async function saveGeneralPolicy() {
  const form = document.getElementById('general-policy-form');
  const input = form.querySelector('.policy-input');
  const txt = input.value.trim();
  if (!txt) return;
  const editIndex = form.dataset.editIndex;
  if (editIndex !== undefined) {
    const idx = parseInt(editIndex);
    const existing = generalPolicies[idx];
    const pid = existing && existing.id;
    if (pid) {
  await saveColumnPoliciesData({ scope: 'general', op: 'update', data: { id: pid, text: txt } });
      existing.text = txt;
    }
    delete form.dataset.editIndex;
  } else {
  const data = await saveColumnPoliciesData({ scope: 'general', op: 'create', data: { board_id: policyBoardId, text: txt } });
    if (data && data.success) generalPolicies.push({ id: data.id, text: data.text, position: 1000 });
  }
  renderGeneralPolicies();
  cancelGeneralPolicy();
}

function editGeneralPolicy(index) {
  const form = document.getElementById('general-policy-form');
  const input = form.querySelector('.policy-input');
  const itm = generalPolicies[index];
  input.value = typeof itm === 'string' ? itm : (itm.text || '');
  form.dataset.editIndex = index;
  form.classList.add('active');
  input.focus();
}

let pendingGeneralDeleteIndex = null;
function showGeneralDelete(index, text, id=null) {
  pendingGeneralDeleteIndex = index;
  pendingDeleteData = { type: 'general', index, id };
  const preview = document.getElementById('policyPreview');
  if (preview) preview.textContent = '• ' + text;
  document.getElementById('deletePolicyModal').style.display = 'block';
  setTimeout(() => document.addEventListener('click', handleModalClick), 100);
}

// Clear and close the General Policies form
function cancelGeneralPolicy() {
  const form = document.getElementById('general-policy-form');
  if (!form) return;
  const input = form.querySelector('.policy-input');
  if (input) input.value = '';
  delete form.dataset.editIndex;
  form.classList.remove('active');
}

// Handle Enter/Escape in inputs and modal escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.target.classList.contains('policy-input')) {
    const form = e.target.closest('.policy-form');
    if (!form) return;
    e.preventDefault();
    if (form.id === 'general-policy-form') {
      saveGeneralPolicy();
    } else {
      const columnName = form.id.replace('form-', '');
      savePolicy(columnName);
    }
  }
  if (e.key === 'Escape' && e.target.classList.contains('policy-input')) {
    const form = e.target.closest('.policy-form');
    if (!form) return;
    if (form.id === 'general-policy-form') {
      cancelGeneralPolicy();
    } else {
      const columnName = form.id.replace('form-', '');
      cancelPolicy(columnName);
    }
  }
  if (e.key === 'Escape') {
    const modal = document.getElementById('deletePolicyModal');
    if (modal && modal.style.display === 'block') cancelDeletePolicy();
  }
});
</script>

<!-- Delete Confirmation Modal -->
<div id="deletePolicyModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <i class="fas fa-exclamation-triangle"></i>
      <h4>Delete Policy</h4>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to delete this policy?</p>
      <div class="policy-preview" id="policyPreview">
        <!-- Policy text will be inserted here -->
      </div>
      <p><small class="text-muted">This action cannot be undone.</small></p>
    </div>
    <div class="delete-modal-buttons">
      <button type="button" class="btn-modal btn-cancel-delete" onclick="cancelDeletePolicy()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button type="button" class="btn-modal btn-confirm-delete" onclick="confirmDeletePolicy()">
        <i class="fas fa-trash"></i> Delete
      </button>
    </div>
  </div>
</div>

</body>
</html>