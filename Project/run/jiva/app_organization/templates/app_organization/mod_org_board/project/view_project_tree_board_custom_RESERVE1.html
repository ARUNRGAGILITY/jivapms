{% extends 'app_common/common_files/base_template.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load app_web_my_filters %}
{% load markdown_extras %}
{% load mptt_tags %}
{% block content %}
<style>
    
/* Main Kanban Board Layout */
.kanban-board {
    width: 100%;
    margin-bottom: 20px;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 15px 0;
    height: 75vh;
}

.kanban-board td {
    vertical-align: top;
    padding: 0;
}

/* Column Styling */
.kanban-column {
    background: #f1f5f8;
    border: 1px solid #ddd;
    border-radius: 8px;
    height: 70vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    padding: 5px;
}

/* Buffer column is wider */
.kanban-column.buffer-column {
    /* Width controlled by table cell */
}

.column_title {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 30px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
}

.column_title h4 {
    margin: 0;
    font-size: 0.85rem;
    color: #333;
    font-weight: bold;
}

/* Swimlane Container */
.kanban-swimlane {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 5px 0;
}

/* Card Styling */
.kanban-card {
    background: #f0efed;
    border-radius: 6px;
    padding: 3px;
    border: 1px solid #e0e0e0;
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
    font-size: 0.55rem;
    display: flex;
    flex-direction: column;
    min-height: 6vh;
    text-overflow: ellipsis;
    overflow: hidden;
    word-wrap: break-word;
    margin-bottom: 5px;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-3px);
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
}

/* Card Header with Priority and ID */
.kanban-card-header {
    font-size: 0.5rem;
    color: #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.kanban-card .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.50rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

/* Priority colors */
.priority-High { background-color: #ff5252; }
.priority-Critical { background-color: #e91e63; }
.priority-Medium { background-color: #ff9800; }
.priority-Low { background-color: #b1ce11; }
.priority-Normal { background-color: #e00ecf; }
.priority-none { background-color: #9e9e9e; }
.priority-high { background-color: #ff5252; }
.priority-critical { background-color: #e91e63; }
.priority-medium { background-color: #ff9800; }
.priority-low { background-color: #4caf50; }

/* Card Content */
.kanban-card h5 {
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
    margin: 5px 0;
}

.kanban-card p {
    font-size: 0.7rem;
    color: #555;
    margin: 0;
    line-height: 1;
}

.kanban-card-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
    font-size: 0.65rem;
}

/* Buffer Column Layout */
.kanban-buffer {
    display: flex;
    flex-direction: row;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f8f9fa;
    padding: 5px;
    width: 100%;
    gap: 5px;
    height: 100%;
}

.kanban-subcolumn {
    width: 100%;
    height: 100%;
    padding: 5px;
    background: #fdfdfd;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.kanban-subcolumn.doing {
    border: 2px dashed #ff9800;
    background-color: #fff8e1;
}

.kanban-subcolumn.done {
    border: 2px dashed #4caf50;
    background-color: #e8f5e9;
}

/* Card Status Colors */
.kanban-card { background-color: #dcdcdc; color: #333 !important; }
.kanban-card.todo { background-color: #bbdefb; color: #0d47a1 !important; }
.kanban-card.in-progress, .kanban-card.WIP, .kanban-card.wip { 
    background-color: #fff59d; 
    color: #f57f17 !important; 
}
.kanban-card.blocked { background-color: lightcoral; color: #ffffff !important; }
.kanban-card.done { background-color: #81c784; color: #1b5e20 !important; }

/* Placeholder for dragging */
.kanban-card-placeholder {
    background: #f0f0f0;
    border: 1px dashed #aaa;
    height: 50px; 
    border-radius: 6px;
    margin: 5px 0;
    width: 100%;
}

/* WIP Limit Visual Indicator */
@keyframes blinkBorder {
    0% { border-color: red; }
    50% { border-color: transparent; }
    100% { border-color: red; }
}

.blink-border {
    border: 3px solid red;
    animation: blinkBorder 1s infinite;
}

/* Main Kanban Board Layout */
.kanban-board-wrapper {
    overflow-x: auto;
    width: 100%;
    padding-bottom: 15px;
}

.kanban-board {
    width: auto;
    min-width: 100%;
    margin-bottom: 20px;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 15px 0;
    height: 75vh;
}

.kanban-board td {
    vertical-align: top;
    padding: 0;
}

/* Column width settings */
.kanban-board td.normal-column {
    width: 250px;
    min-width: 250px;
}

.kanban-board td.buffer-column-cell {
    width: 400px;
    min-width: 400px;
}

/* Column Styling */
.kanban-column {
    background: #f1f5f8;
    border: 1px solid #ddd;
    border-radius: 8px;
    height: 70vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    padding: 5px;
}

/* Buffer column is wider */
.kanban-column.buffer-column {
    /* Width controlled by table cell */
}

.column_title {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 30px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
}

.column_title h4 {
    margin: 0;
    font-size: 0.85rem;
    color: #333;
    font-weight: bold;
}

/* Swimlane Container */
.kanban-swimlane {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 5px 0;
}

/* Card Styling */
.kanban-card {
    background: #f0efed;
    border-radius: 6px;
    padding: 3px;
    border: 1px solid #e0e0e0;
    box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
    font-size: 0.55rem;
    display: flex;
    flex-direction: column;
    min-height: 6vh;
    text-overflow: ellipsis;
    overflow: hidden;
    word-wrap: break-word;
    margin-bottom: 5px;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-3px);
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
}

/* Card Header with Priority and ID */
.kanban-card-header {
    font-size: 0.5rem;
    color: #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.kanban-card .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.50rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

/* Priority colors */
.priority-High { background-color: #ff5252; }
.priority-Critical { background-color: #e91e63; }
.priority-Medium { background-color: #ff9800; }
.priority-Low { background-color: #b1ce11; }
.priority-Normal { background-color: #e00ecf; }
.priority-none { background-color: #9e9e9e; }
.priority-high { background-color: #ff5252; }
.priority-critical { background-color: #e91e63; }
.priority-medium { background-color: #ff9800; }
.priority-low { background-color: #4caf50; }

/* Card Content */
.kanban-card h5 {
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
    margin: 5px 0;
}

.kanban-card p {
    font-size: 0.7rem;
    color: #555;
    margin: 0;
    line-height: 1;
}

.kanban-card-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
    font-size: 0.65rem;
}

/* Buffer Column Layout */
.kanban-buffer {
    display: flex;
    flex-direction: row;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f8f9fa;
    padding: 5px;
    width: 100%;
    gap: 5px;
    height: 100%;
}

.kanban-subcolumn {
    width: 100%;
    height: 100%;
    padding: 5px;
    background: #fdfdfd;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.kanban-subcolumn.doing {
    border: 2px dashed #ff9800;
    background-color: #fff8e1;
}

.kanban-subcolumn.done {
    border: 2px dashed #4caf50;
    background-color: #e8f5e9;
}

/* Card Status Colors */
.kanban-card { background-color: #dcdcdc; color: #333 !important; }
.kanban-card.todo { background-color: #bbdefb; color: #0d47a1 !important; }
.kanban-card.in-progress, .kanban-card.WIP, .kanban-card.wip { 
    background-color: #fff59d; 
    color: #f57f17 !important; 
}
.kanban-card.blocked { background-color: lightcoral; color: #ffffff !important; }
.kanban-card.done { background-color: #81c784; color: #1b5e20 !important; }

/* Placeholder for dragging */
.kanban-card-placeholder {
    background: #f0f0f0;
    border: 1px dashed #aaa;
    height: 50px; 
    border-radius: 6px;
    margin: 5px 0;
    width: 100%;
}

/* WIP Limit Visual Indicator */
@keyframes blinkBorder {
    0% { border-color: red; }
    50% { border-color: transparent; }
    100% { border-color: red; }
}

.blink-border {
    border: 3px solid red;
    animation: blinkBorder 1s infinite;
}

/* Highlight for droppable targets */
.kanban-subcolumn.kanban-droppable-hover,
.kanban-column.kanban-droppable-hover {
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
}

/* Loading Spinner */
.spinner-border {
    border: 0.25em solid #f3f3f3;
    border-top: 0.25em solid #007bff;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Fixed navbar */
.navbar {
    margin: 0 !important;
    padding: 0 !important;
    height: 50px;
}

/* Custom Select for Swimlane filter */
.custom-select {
    appearance: none;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 6px 8px;
    padding-right: 25px;
    font-size: 14px;
    cursor: pointer;
}

/* Parent container adjustments for scrolling */
.content-wrapper, .contentbar, .container-fluid {
    overflow: visible; /* Allow child elements to control their own scrolling */
}

/* WIP Limit Counter Styling */
.column_header {
    text-align: center;
    padding-bottom: 5px;
    min-width: 250px; /* Match column width */
}

.column_header:nth-child(n+2) {
    min-width: 250px; /* For regular columns */
}

th.column_header.buffer-column-header {
    min-width: 400px; /* For buffer columns */
}

.column_header span {
    font-size: 0.7rem;
    text-align: center;
    font-weight: bold;
    min-height: 20px;
    display: block;
}

/* Styling for WIP counts in buffer column titles */
.kanban-subcolumn b {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 5px;
    margin-bottom: 5px;
    border-radius: 4px;
    background-color: rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s ease;
}

.kanban-subcolumn b .wip-count {
    font-size: 0.65rem;
    opacity: 0.9;
    padding: 0 5px;
    border-radius: 3px;
    background-color: rgba(0, 0, 0, 0.1);
    margin-left: 5px;
    transition: all 0.3s ease;
}

/* Styling for exceeded WIP count */
.kanban-subcolumn b .wip-count.exceeded {
    background-color: rgba(255, 0, 0, 0.2);
    color: #d00;
    font-weight: bold;
    box-shadow: 0 0 3px rgba(255, 0, 0, 0.3);
}

/* Buffer column exceeded styling */
.buffer-exceeded {
    background-color: rgba(255, 0, 0, 0.05) !important;
    border: 2px solid rgba(255, 0, 0, 0.3) !important;
}

/* Individual subcolumn exceeded styling */
.subcolumn-exceeded {
    border: 2px dashed rgba(255, 0, 0, 0.5) !important;
    background-color: rgba(255, 0, 0, 0.08) !important;
    box-shadow: inset 0 0 8px rgba(255, 0, 0, 0.1);
}

.subcolumn-exceeded b {
    background-color: rgba(255, 0, 0, 0.1);
    color: #900;
    font-weight: bold;
}

/* More prominent WIP limit visualization */
.blink-border {
    border: 3px solid red !important;
    animation: blinkBorder 1s infinite;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
}

/* Ensure the board wrapper has specific height and scrollbars */
.kanban-board-wrapper {
    height: 80vh;
    overflow-y: hidden;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .kanban-board-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    
    .kanban-board {
        width: auto;
        min-width: 1200px; /* Ensure minimum width to force horizontal scrolling */
    }
}

/* Main Kanban Board Layout */
.kanban-board-wrapper {
    overflow-x: auto;
    width: 100%;
    padding-bottom: 15px;
}

.kanban-board {
    width: auto;
    min-width: 100%;
    margin-bottom: 20px;
    table-layout: fixed;
    border-collapse: collapse;
    border-spacing: 0;
    height: 75vh;
    border: 1px solid #dee2e6;
}

.kanban-board th,
.kanban-board td {
    vertical-align: top;
    padding: 0;
    border: 1px solid #dee2e6;
}

/* Table header styling */
.kanban-board thead {
    background-color: #f8f9fa;
}

.kanban-board th {
    padding: 8px 4px;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid #dee2e6;
}

/* Column width settings */
.kanban-board td.normal-column {
    width: 200px;
    min-width: 200px;
}

.kanban-board td.buffer-column-cell {
    width: 320px;
    min-width: 320px;
}

/* Swimlane row styling */
.kanban-board tr.swimlane-header {
    background-color: #f0f0f0;
    border-top: 2px solid #dee2e6;
}

.kanban-board tr.swimlane-header td {
    padding: 8px 4px;
    font-weight: 600;
    text-align: center;
}

/* Column Styling */
.kanban-column {
    background: #f9f9f9;
    height: 70vh;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    padding: 3px;
    border-radius: 0;
    box-shadow: none;
}

/* Buffer column is wider */
.kanban-column.buffer-column {
    /* Width controlled by table cell */
}

.column_title {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 25px;
    background: #f0f0f0;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 10;
}

.column_title h4 {
    margin: 0;
    font-size: 0.75rem;
    color: #333;
    font-weight: bold;
}

/* Swimlane Container */
.kanban-swimlane {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    height: calc(100% - 25px);
    overflow-y: auto;
    padding: 3px 0;
}

/* Swimlane header and section */
.swimlane-section {
    border-top: 1px dashed #ccc;
    margin-top: 5px;
    padding-top: 5px;
}

.swimlane-title {
    font-size: 0.7rem;
    font-weight: bold;
    color: #555;
    background-color: #f3f3f3;
    padding: 2px 4px;
    margin-bottom: 3px;
    border-radius: 2px;
    text-align: center;
}

/* Card Styling */
.kanban-card {
    background: #f0efed;
    border-radius: 4px;
    padding: 2px;
    border: 1px solid #e0e0e0;
    box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
    font-size: 0.5rem;
    display: flex;
    flex-direction: column;
    min-height: 4vh;
    max-width: 190px;
    text-overflow: ellipsis;
    overflow: hidden;
    word-wrap: break-word;
    margin-bottom: 3px;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.15);
}

/* Card Header with Priority and ID */
.kanban-card-header {
    font-size: 0.5rem;
    color: #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 3px;
    margin-bottom: 3px;
}

.kanban-card .priority {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    font-size: 0.50rem;
    font-weight: bold;
    text-align: center;
    line-height: 14px;
    color: white;
}

/* Priority colors */
.priority-High { background-color: #ff5252; }
.priority-Critical { background-color: #e91e63; }
.priority-Medium { background-color: #ff9800; }
.priority-Low { background-color: #b1ce11; }
.priority-Normal { background-color: #e00ecf; }
.priority-none { background-color: #9e9e9e; }
.priority-high { background-color: #ff5252; }
.priority-critical { background-color: #e91e63; }
.priority-medium { background-color: #ff9800; }
.priority-low { background-color: #4caf50; }

/* Card Content */
.kanban-card h5 {
    font-size: 0.8rem;
    font-weight: bold;
    color: #333;
    margin: 5px 0;
}

.kanban-card p {
    font-size: 0.7rem;
    color: #555;
    margin: 0;
    line-height: 1;
}

.kanban-card-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
    font-size: 0.65rem;
}

/* Buffer Column Layout */
.kanban-buffer {
    display: flex;
    flex-direction: row;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f8f9fa;
    padding: 5px;
    width: 100%;
    gap: 5px;
    height: 100%;
}

.kanban-subcolumn {
    width: 100%;
    height: 100%;
    padding: 5px;
    background: #fdfdfd;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.kanban-subcolumn.doing {
    border: 2px dashed #ff9800;
    background-color: #fff8e1;
}

.kanban-subcolumn.done {
    border: 2px dashed #4caf50;
    background-color: #e8f5e9;
}

/* Card Status Colors */
.kanban-card { background-color: #dcdcdc; color: #333 !important; }
.kanban-card.todo { background-color: #bbdefb; color: #0d47a1 !important; }
.kanban-card.in-progress, .kanban-card.WIP, .kanban-card.wip { 
    background-color: #fff59d; 
    color: #f57f17 !important; 
}
.kanban-card.blocked { background-color: lightcoral; color: #ffffff !important; }
.kanban-card.done { background-color: #81c784; color: #1b5e20 !important; }

/* Placeholder for dragging */
.kanban-card-placeholder {
    background: #f0f0f0;
    border: 1px dashed #aaa;
    height: 50px; 
    border-radius: 6px;
    margin: 5px 0;
    width: 100%;
}

/* WIP Limit Visual Indicator */
@keyframes blinkBorder {
    0% { border-color: red; }
    50% { border-color: transparent; }
    100% { border-color: red; }
}

.blink-border {
    border: 3px solid red;
    animation: blinkBorder 1s infinite;
}

/* Highlight for droppable targets */
.kanban-subcolumn.kanban-droppable-hover,
.kanban-column.kanban-droppable-hover {
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
}

/* Loading Spinner */
.spinner-border {
    border: 0.25em solid #f3f3f3;
    border-top: 0.25em solid #007bff;
    border-radius: 50%;
    width: 3rem;
    height: 3rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Fixed navbar */
.navbar {
    margin: 0 !important;
    padding: 0 !important;
    height: 50px;
}

/* Custom Select for Swimlane filter */
.custom-select {
    appearance: none;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 6px 8px;
    padding-right: 25px;
    font-size: 14px;
    cursor: pointer;
}

/* Parent container adjustments for scrolling */
.content-wrapper, .contentbar, .container-fluid {
    overflow: visible; /* Allow child elements to control their own scrolling */
}

/* WIP Limit Counter Styling */
.column_header {
    text-align: center;
    padding-bottom: 5px;
    min-width: 250px; /* Match column width */
}

.column_header:nth-child(n+2) {
    min-width: 250px; /* For regular columns */
}

th.column_header.buffer-column-header {
    min-width: 400px; /* For buffer columns */
}

.column_header span {
    font-size: 0.7rem;
    text-align: center;
    font-weight: bold;
    min-height: 20px;
    display: block;
}

/* Styling for WIP counts in buffer column titles */
.kanban-subcolumn b {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3px 5px;
    margin-bottom: 5px;
    border-radius: 4px;
    background-color: rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s ease;
}

.kanban-subcolumn b .wip-count {
    font-size: 0.65rem;
    opacity: 0.9;
    padding: 0 5px;
    border-radius: 3px;
    background-color: rgba(0, 0, 0, 0.1);
    margin-left: 5px;
    transition: all 0.3s ease;
}

/* Styling for exceeded WIP count */
.kanban-subcolumn b .wip-count.exceeded {
    background-color: rgba(255, 0, 0, 0.2);
    color: #d00;
    font-weight: bold;
    box-shadow: 0 0 3px rgba(255, 0, 0, 0.3);
}

/* Buffer column exceeded styling */
.buffer-exceeded {
    background-color: rgba(255, 0, 0, 0.05) !important;
    border: 2px solid rgba(255, 0, 0, 0.3) !important;
}

/* Individual subcolumn exceeded styling */
.subcolumn-exceeded {
    border: 2px dashed rgba(255, 0, 0, 0.5) !important;
    background-color: rgba(255, 0, 0, 0.08) !important;
    box-shadow: inset 0 0 8px rgba(255, 0, 0, 0.1);
}

.subcolumn-exceeded b {
    background-color: rgba(255, 0, 0, 0.1);
    color: #900;
    font-weight: bold;
}

/* More prominent WIP limit visualization */
.blink-border {
    border: 3px solid red !important;
    animation: blinkBorder 1s infinite;
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
}

/* Ensure the board wrapper has specific height and scrollbars */
.kanban-board-wrapper {
    height: 80vh;
    overflow-y: hidden;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .kanban-board-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
    }
    
    .kanban-board {
        width: auto;
        min-width: 1200px; /* Ensure minimum width to force horizontal scrolling */
    }
}
</style>


<!--
1. This is default or when get_swimlane_id is -1 where we need to display 
Project Iteration Board
-->

{% if project_iteration_flag == True %}

<div class="content-wrapper">
    <div class="contentbar mb-5" id="contentbar">
        {% if project.project_details.template.name == 'Kanban' %}
        <div class="container-fluid mb-1">
            <div class="row">
                <div class="col col-md-6">
                    <b class="me-2">Project: </b>
                    {{project}} 
                    <b class="mb-2 me-2">Release: </b>
                    {{project.project_release}}
                    <b class="mb-2 me-2">Iteration: </b>
                    {{current_iteration}}
                    <b class="mb-2 me-2">Project Board: </b>
                    {{project_board}}
                </div>

                <div class="col col-md-6 text-end">
                    {% if page == 'custom' %}
                    <a href="{% url 'view_project_tree_board_smart_kanban' project.id %}" class="me-2">SMART</a>
                    <b>Custom</b>
                    {% else %}
                    <b>SMART</b>
                    <a href="{% url 'view_project_tree_board_custom' project.id %}" class="me-2">Custom</a>
                    {% endif %}
                    
                    <a href="{% url 'list_project_boards' project.id %}" class="btn btn-sm btn-primary me-2">Board</a>
                    <a href="{% url 'board_card_settings' project_board.id %}" class="btn btn-sm btn-success me-2">Card</a>
                    <select id="parentFilter" class="custom-select">
                        <option value="">-- Select SwimLane --</option>
                        <option value="0">-- All SwimLanes --</option>
                        <option value="-1" selected>-- Project Iteration --</option>
                        {% for efcc in efcc_backlog_items %}
                            <option value="{{ efcc.id }}">{{ efcc }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="container-fluid">
            <div class="d-flex justify-content-end align-items-center">
                <div class="display_topic"></div>
                <div class="view_options"></div>
                <div class="dropdown"></div>
                <div class="menu"></div>
            </div>
            
            <!-- Kanban Board as Table -->
            <div class="kanban-board-wrapper">
                <table id="kanban-board" data-board-id="{{ project_board.id }}" class="kanban-board mb-5">
                    <thead>
                        <tr>
                            <!-- Column Headers with WIP Limits -->
                            <th class="column_header">
                                <span style="color: red;" id="card-count-0">∞</span>
                            </th>
                            {% for state in project_board_states %}
                            <th class="column_header">
                                {% if state.apply_wip_limit %}
                                <span id="card-count-{{ state.id }}" style="color: green;">0</span>
                                {% else %}
                                <span id="card-count-{{ state.id }}" style="color: red;">∞</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <!-- Backlog Column -->
                            <td class="normal-column">
                                <div class="kanban-column" data-id="0" id="backlog" 
                                     data-apply-wip-limit="false">
                                    <div class="column_title"><h4>Backlog</h4></div>
                                    <div class="kanban-swimlane">
                                    {% for item in backlog_items %}
                                        <div class="kanban-card" data-id="{{ item.id }}">
                                            <div class="kanban-card-header">
                                                <span class="priority priority-{{item.priority}}">{{item.priority|get_first_letter_caps}}</span>
                                                <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.id %}?back_to=view_project_tree_board&project_id={{project.id}}">#{{item.id}}</a> {{item.iteration| display_if_not_none }}</span>
                                            </div>
                                            <b>{{ item }}</b>
                                            <p>{{ item.description | display_if_not_none }}</p>
                                            <div class="kanban-card-footer">
                                                <div class="parent"></div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    </div>
                                </div>
                            </td>

                            <!-- State Columns -->
                            {% for state in project_board_states %}
                            <td class="{% if state.buffer_column %}buffer-column-cell{% else %}normal-column{% endif %}">
                                <div class="kanban-column {% if state.buffer_column %}buffer-column{% endif %}" 
                                     data-id="{{ state.id }}" 
                                     id="column-{{ state.name }}" 
                                     data-column-type="{{ state.column_type }}" 
                                     data-wip-limit="{{ state.wip_limit }}" 
                                     data-apply-wip-limit="{{ state.apply_wip_limit|yesno:'true,false' }}">
                                    
                                    <div class="column_title"><h4>{{ state.name }}</h4></div>
                                    
                                    {% if state.buffer_column %}
                                    <!-- Buffer Column with Subcolumns -->
                                    <div class="kanban-buffer">
                                        {% with subcolumns=state.get_subcolumns %}
                                        {% for substate_choice in subcolumns %}
                                        <div class="kanban-subcolumn {{ substate_choice|lower|slugify }}"
                                             data-id="{{ state.id }}"
                                             id="{{ substate_choice|lower|slugify }}-{{ state.id }}"
                                             data-substate="{{ substate_choice }}"
                                             data-buffer-subcolumn-wip-limit="2">
                                             
                                            <b>{{ state.name }}: {{ substate_choice }}</b>
                                
                                            {% for item in state_items|get_item:state.id %}
                                                {% if item.backlog.iteration.id == current_iteration.id and item.substate == substate_choice %}
                                                    <div class="kanban-card {{ state.column_type|lower }}" style="color: white;" data-id="{{ item.id }}">
                                                        <div class="kanban-card-header">
                                                            <span class="priority priority-{{ item.backlog.priority }}">{{ item.backlog.priority|get_first_letter_caps }}</span>
                                                            <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.backlog.id %}?back_to=view_project_tree_board&project_id={{ project.id }}">
                                                                #{{ item.backlog.id }}</a> {{ item.backlog.iteration }}</span>
                                                        </div>
                                                        <b>{{ item }}</b>
                                                        <p>{{ item.description | display_if_not_none }}</p>
                                                        <div class="kanban-card-footer">
                                                            <div class="parent"></div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endfor %}
                                        {% endwith %}
                                    </div>
                                    {% else %}
                                    <!-- Regular Column -->
                                    <div class="kanban-swimlane">
                                    {% for item in state_items|get_item:state.id %}
                                        {% if item.backlog.iteration.id == current_iteration.id %}
                                            <div class="kanban-card {{ state.column_type|lower }}" style="color: white;" data-id="{{ item.id }}">
                                                <div class="kanban-card-header">
                                                    <span class="priority priority-{{ item.backlog.priority }}">{{ item.backlog.priority|get_first_letter_caps }}</span>
                                                    <span><a href="{% url 'edit_project_tree_backlog_item' project.id item.backlog.id %}?back_to=view_project_tree_board&project_id={{ project.id }}">#{{ item.backlog.id }}</a> {{ item.backlog.iteration }}</span>
                                                </div>
                                                <b>{{ item }}</b>
                                                <p>{{ item.description | display_if_not_none }}</p>
                                                <div class="kanban-card-footer">
                                                    <div class="parent"></div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Loading Spinner -->
<div id="loading-spinner" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>


<!-- Set project and board IDs for JavaScript -->
<script>
    const PROJECT_ID = {{ project.id }};
    const BOARD_ID = {{ project_board.id }};
</script>


<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    // Column color mapping for card status
const columnColorMapping = {
    "Backlog": "kanban-card",
    "ToDo": "kanban-card todo",
    "In Progress": "kanban-card WIP",
    "WIP": "kanban-card WIP",
    "Blocked": "kanban-card blocked",
    "Done": "kanban-card done"
};

// WIP Count function with dynamic substates
function updateWIPCounts() {
    document.querySelectorAll(".kanban-column").forEach(column => {
        let stateId = column.getAttribute("data-id");
        let wipLimit = parseInt(column.getAttribute("data-wip-limit"), 10);
        let applyWipLimit = column.getAttribute("data-apply-wip-limit") === "true";
        let isBufferColumn = column.classList.contains("buffer-column");
        
        // Set default WIP limit of 2 for buffer columns if not already set
        if (isBufferColumn && (!wipLimit || isNaN(wipLimit))) {
            wipLimit = 2;
            column.setAttribute("data-wip-limit", "2");
            column.setAttribute("data-apply-wip-limit", "true");
            applyWipLimit = true;
        }
        
        // Count cards differently for regular vs buffer columns
        let cardCount = 0;
        
        if (isBufferColumn) {
            // Get all subcolumns
            const subcolumns = column.querySelectorAll(".kanban-subcolumn");
            let subcolumnCounts = {};
            let totalCount = 0;
            
            // Count cards in each subcolumn
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const count = subcolumn.querySelectorAll(".kanban-card").length;
                subcolumnCounts[substate] = count;
                totalCount += count;
            });
            
            cardCount = totalCount;
            
            // Update top column count display with just the total
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Display Total: count/wipLimit or Total: count/∞ if no WIP limit
                const limitDisplay = applyWipLimit ? wipLimit : "∞";
                countElement.innerHTML = `<span>Total: ${cardCount}/${limitDisplay}</span>`;
                countElement.style.color = (!applyWipLimit || cardCount <= wipLimit) ? "green" : "red";
            }
            
            // Update each subcolumn title with its count
            subcolumns.forEach(subcolumn => {
                const substate = subcolumn.getAttribute("data-substate");
                const wip_limit_attr = subcolumn.getAttribute("data-buffer-subcolumn-wip-limit");
                const subWipLimit = wip_limit_attr ? parseInt(wip_limit_attr) : 2;
                const count = subcolumnCounts[substate];
                
                // Set the WIP limit attribute if not already set
                if (!wip_limit_attr) {
                    subcolumn.setAttribute("data-buffer-subcolumn-wip-limit", subWipLimit);
                }
                
                // Update the title
                const title = subcolumn.querySelector("b");
                if (title) {
                    const columnName = title.textContent.split(":")[0];
                    title.innerHTML = `${columnName}: ${substate} <span class="wip-count ${count > subWipLimit ? 'exceeded' : ''}">${count}/${subWipLimit}</span>`;
                }
                
                // Highlight subcolumn if count exceeds limit
                if (count > subWipLimit) {
                    subcolumn.classList.add("subcolumn-exceeded");
                } else {
                    subcolumn.classList.remove("subcolumn-exceeded");
                }
            });
            
            // Highlight whole column if total exceeds limit
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
                column.querySelector(".kanban-buffer").classList.add("buffer-exceeded");
            } else {
                column.classList.remove("blink-border");
                column.querySelector(".kanban-buffer").classList.remove("buffer-exceeded");
            }
            
        } else {
            // For regular columns, just count all cards
            cardCount = column.querySelectorAll(".kanban-card").length;
            
            // Update the count display
            let countElement = document.getElementById(`card-count-${stateId}`);
            if (countElement) {
                // Check if WIP limit is applied and format accordingly (count/wipLimit or count/∞)
                if (applyWipLimit) {
                    countElement.innerText = `${cardCount}/${wipLimit}`;
                    countElement.style.color = (cardCount <= wipLimit) ? "green" : "red";
                } else {
                    countElement.innerHTML = `${cardCount}/∞`;
                    countElement.style.color = "green"; // Always green for unlimited columns
                }
            }
            
            // Add blinking border if WIP limit is exceeded
            if (applyWipLimit && cardCount > wipLimit) {
                column.classList.add("blink-border");
            } else {
                column.classList.remove("blink-border");
            }
        }
    });
}

// Initialize the sortable functionality
$(function() {
    $(".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn").sortable({
        connectWith: ".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn",
        placeholder: "kanban-card-placeholder",
        tolerance: 'pointer',
        scroll: true,
        scrollSensitivity: 100,
        scrollSpeed: 10,
        appendTo: "body",
        helper: "clone",
        forcePlaceholderSize: true,
        items: ".kanban-card",
        cancel: ".non-draggable",
        over: function(event, ui) {
            $(this).addClass("kanban-droppable-hover");
        },
        out: function(event, ui) {
            $(this).removeClass("kanban-droppable-hover");
        },
        
        start: function(event, ui) {
            var fromColumn;
            if (ui.item.closest(".kanban-subcolumn").length) {
                fromColumn = ui.item.closest(".kanban-subcolumn").closest(".kanban-column");
            } else {
                fromColumn = ui.item.closest(".kanban-column");
            }
            ui.item.data("start-state", fromColumn.data("id"));
            ui.item.data("from-column", fromColumn.find("h4").text().trim());
            
            // Make item visible during drag
            ui.helper.css('z-index', 1000);
        },

        stop: function(event, ui) {
            var projectId = PROJECT_ID;  // Replace this with actual project ID
            var cardId = ui.item.data("id");
            var boardId = BOARD_ID;  // Replace this with actual board ID
            var fromStateId = ui.item.data("start-state");
            var fromColumn = ui.item.data("from-column");

            var toColumn = ui.item.closest(".kanban-subcolumn, .kanban-column");
            var toStateId = toColumn.data("id");
            var subState = toColumn.attr("data-substate");
            var destColumn = toColumn.attr("id").replace("column-", "").trim().toLowerCase();
            var columnType = toColumn.closest(".kanban-column").data("column-type");
            
            var destPositions = [];
            toColumn.find(".kanban-card").each(function(index) {
                var id = $(this).data("id");
                destPositions.push({ card_id: id, position: index + 1 });
            });
            
            const card = ui.item;
            card.removeClass("todo wip blocked done");
            const newClass = columnColorMapping[columnType] || "kanban-card";
            card.attr("class", newClass);
            
            if (subState) {                
                setTimeout(function() {
                    updateCardSubstate(cardId, toStateId, subState);
                }, 3);
            }
            
            setTimeout(function() {
                updateCardState(cardId, fromStateId, toStateId, destPositions, destColumn, projectId, boardId, fromColumn);
            }, 3);
            
            ui.item.removeData("start-state").removeData("from-column");
            ui.item.data("start-state", toStateId);
            ui.item.data("from-column", destColumn);

            if (fromColumn == 'Backlog' || destColumn == 'Backlog') {
                refreshKanbanBoard();
            }

            updateWIPCounts();
        }
    }).disableSelection();
});

// Update card substate function
function updateCardSubstate(id, stateId, subState) {
    console.log(`Updating substate for Card ${id} -> ${subState}`);

    let formData = new FormData();
    formData.append("id", id);
    formData.append("model_name", "ProjectBoardCard");
    formData.append("app_name", "app_organization");
    formData.append("field_name", "substate");
    formData.append("new_value", subState);

    fetch("/common/common_ajax/ajax_update_app_model_field_value/", {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error:", data.error);
        } else {
            console.log("Substate Update Success:", data);
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

// Update card state function
function updateCardState(cardId, fromStateId, toStateId, destPositions, destColumn, projectId, boardId, fromColumn) {
    fetch("/ajax_update_project_board_card_state/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
        },
        body: JSON.stringify({
            card_id: cardId,
            board_id: boardId,
            from_state_id: fromStateId,
            to_state_id: toStateId,
            positions: destPositions,
            dest_column: destColumn,
            project_id: projectId,
            board_id: boardId,
            from_column: fromColumn
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error("Error:", data.error);
        } else {
            console.log("Success:", data);
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

// Refresh kanban board
function refreshKanbanBoard() {
    document.getElementById("loading-spinner").style.display = "flex";
    setTimeout(() => {
        location.reload();
    }, 200);
}

// Handle swimlane filter change
function setupSwimLaneFilter() {
    document.getElementById('parentFilter').addEventListener('change', function () {
        let selectedValue = this.value;
        let url = new URL(window.location.href);

        if (url.searchParams.has('swimlane_id')) {
            url.searchParams.set('swimlane_id', selectedValue);
        } else {
            url.searchParams.append('swimlane_id', selectedValue);
        }

        window.location.href = url.toString();
    });
}

// Make elements editable
function makeEditable(element) {
    element.contentEditable = true;
    element.focus();
}

function save_element_text(element, id, appName, modelName, fieldName) {
    element.contentEditable = false;
    $.ajax({
        url: '/common/common_ajax/ajax_save_element_text/',
        type: 'POST',
        data : {
            'csrfmiddlewaretoken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
            'model_name': modelName,
            'app_name': appName,
            'field_name': fieldName,
            'text': element.textContent, 
            'id': id,
        },
        dataType: 'json',
        success: function(data) {
            console.log(data);
        }
    });
}

// Initialize everything when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Update WIP counts
    updateWIPCounts();
    
    // Setup swimlane filter
    setupSwimLaneFilter();
    
    // Hide loading spinner
    document.getElementById("loading-spinner").style.display = "none";
    
    // Re-initialize sortable after page load to ensure it works properly
    setTimeout(function() {
        $(".kanban-column, .kanban-column .kanban-swimlane, .kanban-subcolumn").sortable("refresh");
    }, 100);
    
    // Run WIP counts after any drag-and-drop operations
    $(document).on("sortreceive sortstop", function() {
        setTimeout(updateWIPCounts, 100);
    });
});
</script>
{% endblock content %}