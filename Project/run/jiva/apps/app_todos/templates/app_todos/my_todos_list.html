{% extends "base.html" %}

{% block title %}My Todo Lists{% endblock %}

{% block content %}
<div class="todo-container">
    <div class="todo-card p-4">
        <div class="todo-header d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-clipboard-list"></i> My Todo Lists</h2>
            <div>
                <button id="toggleAddFormBtn" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus"></i> Add To Do List
                </button>
                <a href="{% url 'todo_app:my_todos_trash' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-trash"></i> Trash
                    {% if trash_count > 0 %}
                    <span class="badge bg-secondary">{{ trash_count }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActionsContainer" class="mb-3" style="display: none;">
            <button id="bulkDeleteBtn" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
        
        <!-- Search the my todos -->
        <form class="d-flex mx-auto" id="globalSearchForm">
            <div class="input-group" style="max-width: 500px;">
                <input class="form-control" type="search" id="globalSearchInput" placeholder="Search lists and todos..." aria-label="Search">
                <button class="btn btn-outline-primary" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>

        <!-- search results -->
        <div class="modal fade" id="searchResultsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Search Results</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="searchResultsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="lists-tab" data-bs-toggle="tab" data-bs-target="#lists" type="button" role="tab">
                                    Lists <span id="listsCount" class="badge bg-primary">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="todos-tab" data-bs-toggle="tab" data-bs-target="#todos" type="button" role="tab">
                                    Todos <span id="todosCount" class="badge bg-primary">0</span>
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content pt-3" id="searchResultsTabContent">
                            <div class="tab-pane fade show active" id="lists" role="tabpanel">
                                <div id="listsResults" class="row g-3">
                                    <!-- Lists will be loaded here -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="todos" role="tabpanel">
                                <div id="todosResults">
                                    <!-- Todos will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>






        <!-- New List Form (Initially Hidden) -->
        <div id="new-list-form" class="mb-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Add New Todo List</h5>
                </div>
                <div class="card-body">
                    <form action="{% url 'todo_app:my_todos_create' %}" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="listName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="listName" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="listIcon" class="form-label">Icon</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i id="iconPreview" class="fas fa-list"></i></span>
                                    <select class="form-select" id="listIcon" name="icon">
                                        <option value="fa-list">List</option>
                                        <option value="fa-tasks">Tasks</option>
                                        <option value="fa-clipboard">Clipboard</option>
                                        <option value="fa-clipboard-check">Checklist</option>
                                        <option value="fa-calendar">Calendar</option>
                                        <option value="fa-briefcase">Work</option>
                                        <option value="fa-home">Home</option>
                                        <option value="fa-shopping-cart">Shopping</option>
                                        <option value="fa-book">Study</option>
                                        <option value="fa-dumbbell">Fitness</option>
                                        <option value="fa-utensils">Food</option>
                                        <option value="fa-plane">Travel</option>
                                        <option value="fa-music">Music</option>
                                        <option value="fa-film">Movies</option>
                                        <option value="fa-gamepad">Games</option>
                                        <option value="fa-heart">Personal</option>
                                        <option value="fa-star">Important</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="listDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="listDescription" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorPrimary" value="primary" checked>
                                    <label class="form-check-label bg-primary text-white rounded px-2" for="colorPrimary">Primary</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorSuccess" value="success">
                                    <label class="form-check-label bg-success text-white rounded px-2" for="colorSuccess">Success</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorDanger" value="danger">
                                    <label class="form-check-label bg-danger text-white rounded px-2" for="colorDanger">Danger</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorWarning" value="warning">
                                    <label class="form-check-label bg-warning text-dark rounded px-2" for="colorWarning">Warning</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorInfo" value="info">
                                    <label class="form-check-label bg-info text-dark rounded px-2" for="colorInfo">Info</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorSecondary" value="secondary">
                                    <label class="form-check-label bg-secondary text-white rounded px-2" for="colorSecondary">Secondary</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="color" id="colorDark" value="dark">
                                    <label class="form-check-label bg-dark text-white rounded px-2" for="colorDark">Dark</label>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" id="cancelAddBtn" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create List</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Todo Lists Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="todoListsTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 40px;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllLists">
                            </div>
                        </th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Owner</th>
                        <th>Tasks</th>
                        <th>Last Updated</th>
                        <th style="width: 180px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="todoListsContainer">
                    {% for list in todo_lists %}
                    <tr data-id="{{ list.id }}" class="list-row">
                        <td class="grab-handle text-center">
                            <i class="fas fa-grip-vertical text-muted"></i>
                        </td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input list-select-checkbox" type="checkbox" data-id="{{ list.id }}">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas {{ list.icon }} me-2 text-{{ list.color }}"></i>
                                <span>{{ list.name }}</span>
                                
                                <!-- Add sharing indicators -->
                                {% if list.is_public %}
                                    <span class="badge bg-info ms-2" title="Public list">
                                        <i class="fas fa-globe"></i>
                                    </span>
                                {% endif %}
                                
                                {% if list.shares.exists %}
                                    <span class="badge bg-info ms-2" title="Shared with {{ list.shares.count }} users">
                                        <i class="fas fa-share-alt"></i> {{ list.shares.count }}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ list.description|truncatechars:70 }}</td>
                        <td>
                            <!-- <span class="badge bg-{{ list.color }} px-3 py-2">{{ list.color }}</span> -->
                             {{list.owner|capfirst}}
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ list.todo_count }} todos</span>
                            <span class="badge bg-success">{{ list.done_count }} done</span>
                        </td>
                        <td>{{ list.updated_at|timesince }} ago</td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'todo_app:my_todos_detail' list.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-secondary edit-list" data-id="{{ list.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                
                                <a href="{% url 'todo_app:my_todos_copy' list.id %}" class="btn btn-sm btn-outline-info copy-list" data-id="{{ list.id }}">
                                    <i class="fas fa-copy"></i>
                                </a>
                                <a href="{% url 'todo_app:share_todo_list' list.id %}" class="btn btn-sm btn-outline-secondary share-list">
                                    <i class="fas fa-share-alt"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-list" data-id="{{ list.id }}" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr id="edit-{{ list.id }}" class="edit-form-row" style="display: none;">
                        <td colspan="8">
                            <form action="{% url 'todo_app:my_todos_edit' list.id %}" method="post" class="edit-list-form">
                                {% csrf_token %}
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5>Edit List: {{ list.name }}</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="edit-name-{{ list.id }}" class="form-label">Name</label>
                                                <input type="text" class="form-control" id="edit-name-{{ list.id }}" name="name" value="{{ list.name }}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="edit-icon-{{ list.id }}" class="form-label">Icon</label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas {{ list.icon }}"></i></span>
                                                    <select class="form-select" id="edit-icon-{{ list.id }}" name="icon">
                                                        <option value="fa-list" {% if list.icon == 'fa-list' %}selected{% endif %}>List</option>
                                                        <option value="fa-tasks" {% if list.icon == 'fa-tasks' %}selected{% endif %}>Tasks</option>
                                                        <option value="fa-clipboard" {% if list.icon == 'fa-clipboard' %}selected{% endif %}>Clipboard</option>
                                                        <option value="fa-clipboard-check" {% if list.icon == 'fa-clipboard-check' %}selected{% endif %}>Checklist</option>
                                                        <option value="fa-calendar" {% if list.icon == 'fa-calendar' %}selected{% endif %}>Calendar</option>
                                                        <option value="fa-briefcase" {% if list.icon == 'fa-briefcase' %}selected{% endif %}>Work</option>
                                                        <option value="fa-home" {% if list.icon == 'fa-home' %}selected{% endif %}>Home</option>
                                                        <option value="fa-shopping-cart" {% if list.icon == 'fa-shopping-cart' %}selected{% endif %}>Shopping</option>
                                                        <option value="fa-book" {% if list.icon == 'fa-book' %}selected{% endif %}>Study</option>
                                                        <option value="fa-dumbbell" {% if list.icon == 'fa-dumbbell' %}selected{% endif %}>Fitness</option>
                                                        <option value="fa-utensils" {% if list.icon == 'fa-utensils' %}selected{% endif %}>Food</option>
                                                        <option value="fa-plane" {% if list.icon == 'fa-plane' %}selected{% endif %}>Travel</option>
                                                        <option value="fa-music" {% if list.icon == 'fa-music' %}selected{% endif %}>Music</option>
                                                        <option value="fa-film" {% if list.icon == 'fa-film' %}selected{% endif %}>Movies</option>
                                                        <option value="fa-gamepad" {% if list.icon == 'fa-gamepad' %}selected{% endif %}>Games</option>
                                                        <option value="fa-heart" {% if list.icon == 'fa-heart' %}selected{% endif %}>Personal</option>
                                                        <option value="fa-star" {% if list.icon == 'fa-star' %}selected{% endif %}>Important</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="edit-description-{{ list.id }}" class="form-label">Description</label>
                                            <textarea class="form-control" id="edit-description-{{ list.id }}" name="description" rows="2">{{ list.description }}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Color</label>
                                            <div class="d-flex gap-2 flex-wrap">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-primary-{{ list.id }}" value="primary" {% if list.color == 'primary' %}checked{% endif %}>
                                                    <label class="form-check-label bg-primary text-white rounded px-2" for="edit-color-primary-{{ list.id }}">Primary</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-success-{{ list.id }}" value="success" {% if list.color == 'success' %}checked{% endif %}>
                                                    <label class="form-check-label bg-success text-white rounded px-2" for="edit-color-success-{{ list.id }}">Success</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-danger-{{ list.id }}" value="danger" {% if list.color == 'danger' %}checked{% endif %}>
                                                    <label class="form-check-label bg-danger text-white rounded px-2" for="edit-color-danger-{{ list.id }}">Danger</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-warning-{{ list.id }}" value="warning" {% if list.color == 'warning' %}checked{% endif %}>
                                                    <label class="form-check-label bg-warning text-dark rounded px-2" for="edit-color-warning-{{ list.id }}">Warning</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-info-{{ list.id }}" value="info" {% if list.color == 'info' %}checked{% endif %}>
                                                    <label class="form-check-label bg-info text-dark rounded px-2" for="edit-color-info-{{ list.id }}">Info</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-secondary-{{ list.id }}" value="secondary" {% if list.color == 'secondary' %}checked{% endif %}>
                                                    <label class="form-check-label bg-secondary text-white rounded px-2" for="edit-color-secondary-{{ list.id }}">Secondary</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="color" id="edit-color-dark-{{ list.id }}" value="dark" {% if list.color == 'dark' %}checked{% endif %}>
                                                    <label class="form-check-label bg-dark text-white rounded px-2" for="edit-color-dark-{{ list.id }}">Dark</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-secondary cancel-edit">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Save Changes</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <h4 class="text-muted">No todo lists yet</h4>
                            <p>Click the "Add List" button to create your first todo list.</p>
                            <button id="emptyStateAddBtn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Your First List
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this todo list? All todos in this list will remain available but will no longer be associated with this list.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Bulk Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the selected todo lists? All todos in these lists will remain available but will no longer be associated with these lists.</p>
                <p><span id="bulkDeleteCount" class="fw-bold">0</span> lists will be moved to trash.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete Selected</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Toggle add form
        $('#toggleAddFormBtn').click(function() {
            $('#new-list-form').toggle();
            // Hide any open edit forms when showing add form
            if ($('#new-list-form').is(':visible')) {
                $('.edit-form-row').hide();
                $('.list-row').show();
            }
        });
        
        // Empty state add button
        $('#emptyStateAddBtn').click(function() {
            $('#new-list-form').show();
        });
        
        // Cancel add button
        $('#cancelAddBtn').click(function() {
            $('#new-list-form').hide();
        });
        
        // Make todo lists sortable
        new Sortable(document.getElementById('todoListsContainer'), {
            animation: 150,
            handle: '.grab-handle',
            onEnd: function(evt) {
                const lists = [];
                $('tr[data-id]').each(function(index) {
                    lists.push({
                        id: $(this).data('id'),
                        position: index
                    });
                });
                
                // Update positions via AJAX
                $.ajax({
                    url: "{% url 'todo_app:my_todos_reorder' %}",
                    type: "POST",
                    data: JSON.stringify({ lists: lists }),
                    contentType: "application/json",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log("Reordering successful");
                    },
                    error: function(xhr, status, error) {
                        console.error("Error reordering:", error);
                    }
                });
            }
        });
        
        // Select all checkbox
        $('#selectAllLists').change(function() {
            const isChecked = $(this).prop('checked');
            $('.list-select-checkbox').prop('checked', isChecked);
            updateBulkActionsVisibility();
        });
        
        // Individual checkbox change
        $('.list-select-checkbox').change(function() {
            updateBulkActionsVisibility();
            
            // If any checkbox is unchecked, uncheck "select all"
            if (!$(this).prop('checked')) {
                $('#selectAllLists').prop('checked', false);
            }
            
            // If all checkboxes are checked, check "select all"
            if ($('.list-select-checkbox:checked').length === $('.list-select-checkbox').length) {
                $('#selectAllLists').prop('checked', true);
            }
        });
        
        // Update bulk actions container visibility
        function updateBulkActionsVisibility() {
            const checkedCount = $('.list-select-checkbox:checked').length;
            $('#bulkActionsContainer').toggle(checkedCount > 0);
            $('#bulkDeleteCount').text(checkedCount);
        }
        
        // Edit list button
        $('.edit-list').click(function() {
            const listId = $(this).data('id');
            
            // Hide the add form if it's visible
            $('#new-list-form').hide();
            
            // Hide all edit forms
            $('.edit-form-row').hide();
            $('.list-row').show();
            
            // Show this edit form
            $('#edit-' + listId).show();
            $(this).closest('tr').hide();
        });
        
        // Cancel edit
        $('.cancel-edit').click(function(e) {
            e.preventDefault();
            const editRow = $(this).closest('tr');
            editRow.hide();
            // Show the original row
            editRow.prev('tr').show();
        });
        
        // Icon preview on change
        $('#listIcon').change(function() {
            const icon = $(this).val();
            $('#iconPreview').attr('class', 'fas ' + icon);
        });
        
        // Edit icon preview on change
        $('select[id^="edit-icon-"]').change(function() {
            const icon = $(this).val();
            $(this).prev('.input-group-text').find('i').attr('class', 'fas ' + icon);
        });
        
        // Delete list
        $('.delete-list').click(function() {
            const listId = $(this).data('id');
            $('#confirmDeleteBtn').data('id', listId);
        });
        
        // Confirm Delete
        $('#confirmDeleteBtn').click(function() {
            const listId = $(this).data('id');
            
            $.ajax({
                url: "{% url 'todo_app:my_todos_delete' 0 %}".replace('0', listId),
                type: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    $('#deleteModal').modal('hide');
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting list:", error);
                    alert("Error deleting list. Please try again.");
                }
            });
        });
        
        // Bulk delete button
        $('#bulkDeleteBtn').click(function() {
            const checkedCount = $('.list-select-checkbox:checked').length;
            $('#bulkDeleteCount').text(checkedCount);
        });
        
        // Confirm bulk delete
        $('#confirmBulkDeleteBtn').click(function() {
            const selectedIds = [];
            $('.list-select-checkbox:checked').each(function() {
                selectedIds.push($(this).data('id'));
            });
            
            if (selectedIds.length === 0) {
                $('#bulkDeleteModal').modal('hide');
                return;
            }
            
            // Create a form to submit
            const form = $('<form></form>').attr({
                method: 'POST',
                action: "{% url 'todo_app:my_todos_bulk_delete' %}"
            });
            
            // Add CSRF token
            form.append($('<input>').attr({
                type: 'hidden',
                name: 'csrfmiddlewaretoken',
                value: '{{ csrf_token }}'
            }));
            
            // Add ids
            form.append($('<input>').attr({
                type: 'hidden',
                name: 'ids',
                value: JSON.stringify(selectedIds)
            }));
            
            // Append to body, submit, and remove
            $('body').append(form);
            form.submit();
        });
    });
</script>


<!--SEARCH FUNCTIONALITY -->
<!-- Add to the existing script section -->
<script>
    $(document).ready(function() {
        // Global search functionality
        $('#globalSearchForm').submit(function(e) {
            e.preventDefault();
            const query = $('#globalSearchInput').val().trim();
            
            if (query) {
                // Show loading indicators
                $('#listsResults, #todosResults').html(
                    '<div class="text-center my-3"><div class="spinner-border text-primary" role="status"></div></div>'
                );
                
                // Reset counts
                $('#listsCount, #todosCount').text('0');
                
                // Show the modal
                $('#searchResultsModal').modal('show');
                
                // Perform AJAX search
                $.ajax({
                    url: "{% url 'todo_app:global_search' %}",
                    data: { q: query },
                    success: function(response) {
                        // Update counts
                        $('#listsCount').text(response.lists.length);
                        $('#todosCount').text(response.todos.length);
                        
                        // Render lists
                        if (response.lists.length === 0) {
                            $('#listsResults').html('<div class="alert alert-info">No lists found</div>');
                        } else {
                            let listsHtml = '';
                            response.lists.forEach(function(list) {
                                listsHtml += `
                                    <div class="col-md-6">
                                        <div class="card border-${list.color}">
                                            <div class="card-header bg-${list.color} text-light">
                                                <i class="fas ${list.icon}"></i> ${list.name}
                                            </div>
                                            <div class="card-body">
                                                <p class="small">${list.description || 'No description'}</p>
                                                <div class="d-flex gap-2">
                                                    <span class="badge bg-primary">${list.todo_count} todos</span>
                                                    <span class="badge bg-success">${list.done_count} done</span>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                <a href="${'{% url "todo_app:my_todos_detail" 999999 %}'.replace('999999', list.id)}" class="btn btn-sm btn-primary w-100">
                                                    <i class="fas fa-external-link-alt"></i> Open
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#listsResults').html(listsHtml);
                        }
                        
                        // Render todos
                        if (response.todos.length === 0) {
                            $('#todosResults').html('<div class="alert alert-info">No todos found</div>');
                        } else {
                            let todosHtml = '<div class="list-group">';
                            response.todos.forEach(function(todo) {
                                const priorityClass = 
                                    todo.priority === 'critical' ? 'border-danger' : 
                                    todo.priority === 'high' ? 'border-warning' :
                                    todo.priority === 'medium' ? 'border-info' :
                                    todo.priority === 'low' ? 'border-success' : '';
                                
                                todosHtml += `
                                    <div class="list-group-item list-group-item-action ${priorityClass} ${todo.done ? 'text-decoration-line-through text-muted' : ''} ${todo.blocked ? 'bg-light' : ''}">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">${todo.name}</h5>
                                            <small>${todo.list_name}</small>
                                        </div>
                                        <p class="mb-1">${todo.description}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge 
                                                    ${todo.priority === 'critical' ? 'bg-danger' : 
                                                    todo.priority === 'high' ? 'bg-warning text-dark' :
                                                    todo.priority === 'medium' ? 'bg-info text-dark' :
                                                    todo.priority === 'low' ? 'bg-success' : 'bg-secondary'}">
                                                    ${todo.priority}
                                                </span>
                                                ${todo.done ? '<span class="badge bg-success">Done</span>' : ''}
                                                ${todo.blocked ? '<span class="badge bg-danger">Blocked</span>' : ''}
                                            </div>
                                            <a href="${todo.list_id ? '{% url "todo_app:my_todos_detail" 0 %}'.replace('0', todo.list_id) : '{% url "todo_app:table_view" %}'}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-external-link-alt"></i> View
                                            </a>
                                        </div>
                                    </div>
                                `;
                            });
                            todosHtml += '</div>';
                            $('#todosResults').html(todosHtml);
                        }
                    },
                    error: function() {
                        $('#listsResults, #todosResults').html(
                            '<div class="alert alert-danger">An error occurred while searching</div>'
                        );
                    }
                });
            }
        });
    });
</script>

<script>
    document.querySelectorAll('.copy-list').forEach(button => {
    button.addEventListener('click', function() {
        const listId = this.getAttribute('data-id');
        
        
        fetch(`/my-todos/copy/${listId}/`, {
            method: 'POST',
            data: {
                'pk': listId,
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Refresh the page or update the UI as needed
                window.location.reload();
            }
        });
    });
});
</script>
{% endblock %}